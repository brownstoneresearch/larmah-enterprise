<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <title>Exchange | Larmah Enterprise</title>
  <meta name="description" content="Institutional-grade FX and Crypto OTC desk. Live NGN rates, secure settlement, and instant WhatsApp booking." />
  <meta name="keywords" content="Buy Dollar Nigeria, Sell USDT Nigeria, Crypto OTC Lagos, FX Rates Nigeria, Larmah Exchange" />
  <meta name="theme-color" content="#070A12" />
  <link rel="canonical" href="https://heylarmah.tech/exchange.html" />

  <link rel="icon" href="assets/images/larmah-favicon.jpeg" type="image/jpeg" />
  <link rel="preload" href="assets/images/larmah-header.jpeg" as="image" />

  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="assets/js/app.js"></script>

  <style>
    .rate-board {
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      padding: 24px;
      backdrop-filter: blur(10px);
      box-shadow: inset 0 0 80px rgba(0,0,0,0.5);
      position: relative;
      overflow: hidden;
    }
    .rate-row {
      display: grid; grid-template-columns: 1fr 1fr 1fr auto;
      align-items: center; gap: 12px;
      padding: 16px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .rate-row:last-child { border-bottom: none; }

    .currency-pair { display: flex; align-items: center; gap: 10px; font-weight: 900; font-size: 1.05rem; }
    .currency-icon {
      width: 32px; height: 32px; border-radius: 50%;
      background: rgba(255,255,255,0.1);
      display: grid; place-items: center; font-size: 0.9rem;
    }
    .rate-val { font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .rate-label { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; margin-bottom: 2px; font-weight: 900; }
    .buy-rate { color: var(--ok); font-weight: 900; font-size: 1.1rem; }
    .sell-rate { color: var(--warn); font-weight: 900; font-size: 1.1rem; }

    .converter {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
    }
    .conv-input-group { position: relative; margin-bottom: 12px; }
    .conv-input {
      font-size: 1.5rem; font-weight: 950; padding-right: 100px;
      background: rgba(0,0,0,0.2); border-color: rgba(255,255,255,0.1);
    }
    .conv-select {
      position: absolute; right: 6px; top: 6px; bottom: 6px;
      width: 90px; border: none; background: rgba(255,255,255,0.08);
      color: #fff; font-weight: 900; border-radius: 10px; cursor: pointer;
      text-align: center;
    }
    .conv-result { text-align: right; font-size: 0.9rem; color: var(--muted); margin-top: 8px; }
    .conv-total { font-size: 1.8rem; font-weight: 950; color: var(--accent); letter-spacing: -1px; }

    .live-dot { display:inline-flex; align-items:center; gap:8px; font-weight:800; font-size:.85rem; color: var(--ok); }
    .live-dot i { font-size: 8px; }

    @media(max-width: 600px) {
      .rate-row { grid-template-columns: 1fr 1fr; row-gap: 16px; }
      .rate-action { grid-column: 1 / -1; }
    }
  </style>
</head>

<body data-page="exchange">

  <div id="mobileNavOverlay">
    <div class="msheet">
      <div class="msheet-head">
        <div class="msheet-brand">
          <img src="assets/images/larmah-header.jpeg" alt="Larmah Logo">
        </div>
        <button class="msheet-close" onclick="LARMAH.toggleMenu()" aria-label="Close Menu">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="msheet-body">
        <div class="msheet-links">
          <a href="real-estate.html" class="msheet-link">
            <span><i class="fa-solid fa-house" style="width:24px;color:var(--brand)"></i> Real Estate</span>
            <i class="fa-solid fa-chevron-right" style="font-size:12px;opacity:.5"></i>
          </a>
          <a href="logistics.html" class="msheet-link">
            <span><i class="fa-solid fa-truck" style="width:24px;color:var(--brand)"></i> Logistics</span>
            <i class="fa-solid fa-chevron-right" style="font-size:12px;opacity:.5"></i>
          </a>
          <a href="insights.html" class="msheet-link">
            <span><i class="fa-solid fa-chart-line" style="width:24px;color:var(--brand)"></i> Insights</span>
            <i class="fa-solid fa-chevron-right" style="font-size:12px;opacity:.5"></i>
          </a>
          <a href="exchange.html" class="msheet-link active">
            <span><i class="fa-solid fa-money-bill-transfer" style="width:24px;color:var(--brand)"></i> Exchange</span>
            <i class="fa-solid fa-check" style="font-size:12px;"></i>
          </a>
        </div>
        <div class="msheet-footer">
          <div class="msheet-hint">Menu</div>
          <a href="premium.html" class="msheet-link" style="color:var(--accent);border-color:rgba(212,175,55,.2)">
            <span><i class="fa-solid fa-crown" style="width:24px"></i> Premium</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <header>
    <div class="container header-inner">
      <a class="brand" href="index.html" aria-label="Larmah Home">
        <img src="assets/images/larmah-header.jpeg" alt="Larmah Enterprise" />
      </a>

      <button class="menu-btn" onclick="LARMAH.toggleMenu()" aria-label="Open menu">
        <i class="fa-solid fa-bars"></i>
      </button>

      <nav id="nav" aria-label="Primary navigation">
        <ul>
          <li><a class="nav-link" href="real-estate.html">Real Estate</a></li>
          <li><a class="nav-link" href="logistics.html">Logistics</a></li>
          <li><a class="nav-link" href="insights.html">Insights</a></li>
          <li><a class="nav-link active" href="exchange.html">Exchange</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <div class="hero-shell">
        <div class="hero-inner">
          <div>
            <div class="hero-kicker">
              <span class="kicker-pill"><i class="fa-solid fa-money-bill-trend-up"></i> OTC Trading Desk</span>
              <span class="kicker-dot">•</span>
              <span class="kicker-sub">Instant Settlement</span>
            </div>

            <h1>Institutional Grade<br>Exchange Rates.</h1>
            <p class="lead">
              Securely trade FX and Crypto with Larmah's verified OTC desk.
              Competitive rates, WhatsApp-first booking.
            </p>

            <div class="actions">
              <a class="btn solid" href="#rates"><i class="fa-solid fa-chart-pie"></i> Check Rates</a>
              <button class="btn primary" onclick="startTrade()">
                <i class="fa-brands fa-whatsapp"></i> Start Trade
              </button>
            </div>

            <div class="trust-row">
              <div class="trust-badge"><i class="fa-solid fa-lock"></i> Escrow Available</div>
              <div class="trust-badge"><i class="fa-solid fa-bolt"></i> &lt; 10min Settlement</div>
            </div>

            <div class="small live-dot" id="liveStateFX" style="margin-top:12px;opacity:.9">
              <i class="fa-solid fa-circle fa-beat"></i> Live rate updates enabled
            </div>
          </div>

          <div style="align-self:center">
            <div class="converter">
              <h3 style="margin-bottom:12px;font-size:1rem;color:var(--muted)">Quick Converter</h3>

              <div class="conv-input-group">
                <input type="number" id="calc_amount" class="input conv-input" value="1000" placeholder="0.00">
                <select id="calc_from" class="conv-select">
                  <option value="USD">USD ($)</option>
                  <option value="GBP">GBP (£)</option>
                  <option value="EUR">EUR (€)</option>
                  <option value="USDT">USDT</option>
                </select>
              </div>

              <div class="conv-result">
                <div>Estimated Value (NGN)</div>
                <div class="conv-total" id="calc_result">₦—</div>
                <div style="font-size:0.8rem;opacity:0.6;margin-top:4px">
                  Rate: <span id="calc_rate_display">—</span> / 1
                </div>
              </div>

              <button class="btn solid" style="width:100%;margin-top:16px" onclick="lockRate()">
                <i class="fa-brands fa-whatsapp"></i> Lock this Rate
              </button>
            </div>
          </div>

        </div>
      </div>
    </section>

    <section class="section" id="rates">
      <div class="section-head-split">
        <div>
          <h2>Live Desk Rates</h2>
          <p class="lead">Rates update live. Confirm on WhatsApp.</p>
        </div>
        <div class="small" style="color:var(--ok)">
          <i class="fa-solid fa-circle fa-beat" style="font-size:8px;margin-right:6px"></i> Live
        </div>
      </div>

      <div class="rate-board">
        <div class="rate-row" style="padding-top:0; border-bottom:1px solid rgba(255,255,255,0.1); opacity:0.6; font-size:0.85rem">
          <div>ASSET</div><div>WE BUY @</div><div>WE SELL @</div><div>ACTION</div>
        </div>

        <div class="rate-row">
          <div class="currency-pair"><div class="currency-icon"><i class="fa-solid fa-dollar-sign"></i></div><div>USD <span style="font-size:0.8rem;color:var(--muted);font-weight:400">/ NGN</span></div></div>
          <div class="rate-buy"><div class="rate-label">We Buy</div><div class="rate-val" id="rate_usd_buy">—</div></div>
          <div class="rate-sell"><div class="rate-label">We Sell</div><div class="rate-val" id="rate_usd_sell">—</div></div>
          <div class="rate-action"><button class="btn small primary" onclick="tradeAsset('USD')">Trade</button></div>
        </div>

        <div class="rate-row">
          <div class="currency-pair"><div class="currency-icon"><i class="fa-solid fa-sterling-sign"></i></div><div>GBP <span style="font-size:0.8rem;color:var(--muted);font-weight:400">/ NGN</span></div></div>
          <div class="rate-buy"><div class="rate-label">We Buy</div><div class="rate-val" id="rate_gbp_buy">—</div></div>
          <div class="rate-sell"><div class="rate-label">We Sell</div><div class="rate-val" id="rate_gbp_sell">—</div></div>
          <div class="rate-action"><button class="btn small primary" onclick="tradeAsset('GBP')">Trade</button></div>
        </div>

        <div class="rate-row">
          <div class="currency-pair"><div class="currency-icon" style="color:#26A17B"><i class="fa-brands fa-ethereum"></i></div><div>USDT <span style="font-size:0.8rem;color:var(--muted);font-weight:400">/ NGN</span></div></div>
          <div class="rate-buy"><div class="rate-label">We Buy</div><div class="rate-val" id="rate_usdt_buy">—</div></div>
          <div class="rate-sell"><div class="rate-label">We Sell</div><div class="rate-val" id="rate_usdt_sell">—</div></div>
          <div class="rate-action"><button class="btn small primary" onclick="tradeAsset('USDT')">Trade</button></div>
        </div>

        <div class="rate-row">
          <div class="currency-pair"><div class="currency-icon" style="color:#F7931A"><i class="fa-brands fa-bitcoin"></i></div><div>BTC <span style="font-size:0.8rem;color:var(--muted);font-weight:400">/ USD</span></div></div>
          <div class="rate-buy"><div class="rate-label">We Buy</div><div class="rate-val" id="rate_btc_buy">—</div></div>
          <div class="rate-sell"><div class="rate-label">We Sell</div><div class="rate-val" id="rate_btc_sell">—</div></div>
          <div class="rate-action"><button class="btn small primary" onclick="tradeAsset('BTC')">Trade</button></div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <div class="footer-grid">
        <div>
          <div class="brandline">
            <img src="assets/images/larmah-header.jpeg" alt="Larmah Enterprise" />
            <div>
              <div style="font-weight:950">Larmah Enterprise</div>
              <div class="small">Real Estate • Logistics • Insights • Exchange</div>
            </div>
          </div>
          <div class="small" style="margin-top:8px">
            Trust-first commerce for Nigeria — verified listings, trackable enquiries, and WhatsApp-first support.
          </div>
          <div class="social-row" aria-label="Social links">
            <a class="social-btn" href="https://instagram.com/hey_larmah" aria-label="Instagram" title="Instagram"><i class="fa-brands fa-instagram"></i></a>
            <a class="social-btn" href="https://x.com/heylarmah_tech" aria-label="X" title="X (Twitter)"><i class="fa-brands fa-x-twitter"></i></a>
            <a class="social-btn" href="https://t.me/heylarmah_tech" aria-label="Telegram" title="Telegram"><i class="fa-brands fa-telegram"></i></a>
            <a class="social-btn" href="https://youtube.com/@heylarmah" aria-label="YouTube" title="YouTube"><i class="fa-brands fa-youtube"></i></a>
          </div>
        </div>

        <div>
          <b>Navigation</b>
          <div class="small" style="margin-top:10px"><a href="real-estate.html">Real Estate</a></div>
          <div class="small"><a href="logistics.html">Logistics</a></div>
          <div class="small"><a href="insights.html">Insights</a></div>
          <div class="small"><a href="exchange.html">Exchange</a></div>
          <div class="small"><a href="premium.html">Premium</a></div>
        </div>

        <div>
          <b>Contact</b>
          <div class="small" style="margin-top:10px"><i class="fa-brands fa-whatsapp"></i> +234 706 308 0605</div>
          <div class="small"><i class="fa-regular fa-envelope"></i> business@heylarmah.tech</div>
          <div class="small"><i class="fa-solid fa-location-dot"></i> Lagos, Nigeria</div>
          <div class="actions" style="margin-top:12px">
            <button class="btn small" onclick="LARMAH.openWhatsApp(LARMAH.buildMessage('Support', { Message:'Hello Larmah, I need help.' }))">
              <i class="fa-brands fa-whatsapp"></i> WhatsApp Support
            </button>
          </div>
          <div class="small" style="margin-top:10px;opacity:.65">
            <a href="auth.html">Staff Sign-in</a> • <a href="admin.html">Admin</a>
          </div>
        </div>
      </div>

      <div class="small">© <span id="year"></span> Larmah Enterprise. All rights reserved.</div>
    </div>
  </footer>

  <div id="toast" class="toast"></div>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    const RATES = {
      USD:{buy:1635,sell:1645},
      GBP:{buy:2140,sell:2160},
      EUR:{buy:1780,sell:1800},
      USDT:{buy:1642,sell:1650},
      BTC:{buy:101200,sell:102500}
    };

    let __fxChannel = null;
    let __fxDeb = null;
    function debounce(fn, wait=600){ clearTimeout(__fxDeb); __fxDeb = setTimeout(fn, wait); }

    function fmt(n){ return (n===null||n===undefined) ? "—" : Number(n).toLocaleString(); }

    function paintRates(){
      document.getElementById("rate_usd_buy").textContent = fmt(RATES.USD.buy);
      document.getElementById("rate_usd_sell").textContent = fmt(RATES.USD.sell);
      document.getElementById("rate_gbp_buy").textContent = fmt(RATES.GBP.buy);
      document.getElementById("rate_gbp_sell").textContent = fmt(RATES.GBP.sell);
      document.getElementById("rate_usdt_buy").textContent = fmt(RATES.USDT.buy);
      document.getElementById("rate_usdt_sell").textContent = fmt(RATES.USDT.sell);
      document.getElementById("rate_btc_buy").textContent = "$" + fmt(RATES.BTC.buy);
      document.getElementById("rate_btc_sell").textContent = "$" + fmt(RATES.BTC.sell);
      updateCalc();
    }

    async function loadRates(){
      try{
        const sb = window.supabaseClient || (window.ensureSupabaseClient && window.ensureSupabaseClient());
        if(!sb) throw new Error("supabaseClient not ready");

        const { data, error } = await sb.from("rates").select("*").eq("status","active");
        if(error) throw error;

        (data || []).forEach(r => {
          const a = String(r.asset||"").toUpperCase();
          if(!a) return;
          RATES[a] = { buy:Number(r.buy||0), sell:Number(r.sell||0) };
        });
      }catch(e){
        console.warn("Rates fallback:", e?.message || e);
      }
      paintRates();
    }

    function updateCalc(){
      const amt = parseFloat(document.getElementById("calc_amount").value) || 0;
      const cur = document.getElementById("calc_from").value;
      const rate = RATES[cur]?.sell || 0;
      document.getElementById("calc_rate_display").textContent = rate ? rate.toLocaleString() : "—";
      document.getElementById("calc_result").textContent = rate ? ("₦" + (amt*rate).toLocaleString(undefined,{maximumFractionDigits:2})) : "₦—";
    }

    async function startTrade(){
      if(LARMAH.submitRequest){
        await LARMAH.submitRequest({
          header: "Exchange Intro",
          category: "exchange",
          fields: { Message: "Hello Larmah, I want to trade. Please share settlement steps." },
          refPrefix: "FX"
        });
      } else {
        LARMAH.openWhatsApp(LARMAH.buildMessage("Exchange Intro", { Message:"Hello Larmah, I want to trade." }));
      }
    }

    async function lockRate(){
      const amt = document.getElementById("calc_amount").value;
      const cur = document.getElementById("calc_from").value;
      const rate = RATES[cur]?.sell || 0;

      const fields = { Pair:`${cur}/NGN`, Amount:`${amt} ${cur}`, Rate: rate ? rate.toLocaleString() : "—", Intent:`Lock ${cur} sell rate` };
      if(LARMAH.submitRequest){
        await LARMAH.submitRequest({ header:"Trade Booking", category:"exchange", fields, refPrefix:"FX" });
      } else {
        LARMAH.openWhatsApp(LARMAH.buildMessage("Trade Booking", fields));
      }
    }

    async function tradeAsset(asset){
      const a = String(asset||"").toUpperCase();
      const fields = { Asset:a, Buy:String(RATES[a]?.buy||""), Sell:String(RATES[a]?.sell||""), Intent:`Trade ${a}` };
      if(LARMAH.submitRequest){
        await LARMAH.submitRequest({ header:"Trade Booking", category:"exchange", fields, refPrefix:"FX" });
      } else {
        LARMAH.openWhatsApp(LARMAH.buildMessage("Trade Booking", fields));
      }
    }

    function initRealtimeFX(){
      const sb = window.supabaseClient || (window.ensureSupabaseClient && window.ensureSupabaseClient());
      if(!sb) return;

      if(__fxChannel){
        try { sb.removeChannel(__fxChannel); } catch {}
        __fxChannel = null;
      }

      __fxChannel = sb.channel("realtime-exchange")
        .on("postgres_changes", { event:"*", schema:"public", table:"rates" }, () => {
          debounce(() => loadRates(), 600);
        })
        .subscribe((st) => {
          const el = document.getElementById("liveStateFX");
          if(!el) return;
          if(st === "SUBSCRIBED") el.innerHTML = `<i class="fa-solid fa-circle fa-beat"></i> Live rate updates enabled`;
          else el.innerHTML = `<i class="fa-solid fa-circle"></i> Live: ${st}`;
        });
    }

    document.addEventListener("DOMContentLoaded", async () => {
      document.getElementById("calc_amount").addEventListener("input", updateCalc);
      document.getElementById("calc_from").addEventListener("change", updateCalc);

      await loadRates();
      initRealtimeFX();
    });
  </script>
</body>
</html>
