<!-- exchange.html (FULL â€” dynamic rates from Supabase + realtime + logs requests + WhatsApp) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Exchange | Larmah Enterprise</title>

  <meta name="description" content="Live Exchange Desk: USD/GBP/EUR and BTC/ETH/USDT to NGN. Rates are managed in Admin and update in real time." />
  <meta name="theme-color" content="#070A12" />

  <link rel="icon" href="assets/images/larmah-favicon.jpeg" type="image/jpeg" />
  <link rel="preload" href="assets/images/larmah-header.jpeg" as="image" />

  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="assets/js/app.js"></script>
</head>

<body data-page="exchange">
  <!-- Live ticker -->
  <div class="live-ticker">
    <div class="container">
      <div id="liveRatesTicker" class="ticker-content">
        <span>Loading live ratesâ€¦</span>
      </div>
    </div>
  </div>

  <header>
    <div class="container header-inner">
      <a class="brand" href="index.html" aria-label="Larmah Home">
        <img src="assets/images/larmah-header.jpeg" alt="Larmah Enterprise" />
      </a>

      <button class="menu-btn" onclick="LARMAH.toggleMenu()" aria-label="Open menu">
        <i class="fa-solid fa-bars"></i>
      </button>

      <nav id="nav" aria-label="Primary navigation">
        <ul>
          <li><a class="nav-link" href="real-estate.html" data-link="real-estate">Real Estate</a></li>
          <li><a class="nav-link" href="logistics.html" data-link="logistics">Logistics</a></li>
          <li><a class="nav-link" href="insights.html" data-link="insights">Insights</a></li>
          <li><a class="nav-link" href="exchange.html" data-link="exchange">Exchange</a></li>
        </ul>
      </nav>

      <div class="header-actions" id="authPill">
        <a class="pill primary" href="premium.html"><i class="fa-solid fa-star"></i> Premium</a>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- HERO -->
    <section class="hero">
      <div class="hero-shell">
        <div class="hero-inner">
          <div>
            <div class="hero-kicker">
              <span class="kicker-pill">
                <i class="fa-solid fa-money-bill-transfer"></i>
                Live Exchange Desk
              </span>
              <span class="kicker-dot">â€¢</span>
              <span class="kicker-sub">Dynamic rates â€¢ Admin-managed â€¢ WhatsApp-first</span>
            </div>

            <h1>Exchange with Confidence.</h1>
            <p class="lead">
              Rates are pulled from our verified desk and update instantly when Admin changes them.
              Use quick calc for estimates, then request a quote on WhatsApp.
            </p>

            <!-- Quick Calculator -->
            <div class="exchange-quick-calc" aria-label="Quick exchange calculator">
              <div class="calc-inputs">
                <div class="input-group">
                  <input type="number" value="100" id="quickAmount" class="input" min="0" step="0.0001" />
                  <select class="input" id="quickFrom">
                    <option value="USD">ðŸ‡ºðŸ‡¸ USD</option>
                    <option value="GBP">ðŸ‡¬ðŸ‡§ GBP</option>
                    <option value="EUR">ðŸ‡ªðŸ‡º EUR</option>
                    <option value="BTC">â‚¿ BTC</option>
                    <option value="ETH">Îž ETH</option>
                    <option value="USDT">ðŸ’µ USDT</option>
                    <option value="NGN">ðŸ‡³ðŸ‡¬ NGN</option>
                  </select>
                </div>

                <div class="calc-arrow">â†’</div>

                <div class="input-group">
                  <div class="result-display" id="quickResult">â€”</div>
                  <select class="input" id="quickTo">
                    <option value="NGN">ðŸ‡³ðŸ‡¬ NGN</option>
                    <option value="USD">ðŸ‡ºðŸ‡¸ USD</option>
                    <option value="GBP">ðŸ‡¬ðŸ‡§ GBP</option>
                    <option value="EUR">ðŸ‡ªðŸ‡º EUR</option>
                    <option value="BTC">â‚¿ BTC</option>
                    <option value="ETH">Îž ETH</option>
                    <option value="USDT">ðŸ’µ USDT</option>
                  </select>
                </div>
              </div>

              <div class="actions" style="margin-top:12px">
                <button class="btn solid" onclick="quickExchange()">
                  <i class="fa-brands fa-whatsapp"></i> Get This Rate
                </button>
                <a class="btn" href="#calculator"><i class="fa-solid fa-calculator"></i> Advanced</a>
                <a class="btn primary" href="premium.html"><i class="fa-solid fa-crown"></i> Premium</a>
              </div>
            </div>

            <div class="trust-row">
              <div class="trust-badge"><i class="fa-solid fa-circle-check"></i> Reference IDs</div>
              <div class="trust-badge"><i class="fa-solid fa-shield-halved"></i> Confirm-first process</div>
              <div class="trust-badge"><i class="fa-solid fa-bolt"></i> Fast coordination</div>
            </div>
          </div>

          <div class="hero-badges">
            <div class="hero-card">
              <h3><i class="fa-solid fa-dollar-sign" style="color:var(--brand)"></i> FX Desk</h3>
              <p>USD/GBP/EUR â†” NGN. Admin-managed live rates.</p>
              <div class="card-actions"><a class="btn small" href="#rates">View Rates</a></div>
            </div>
            <div class="hero-card">
              <h3><i class="fa-solid fa-coins" style="color:var(--brand)"></i> Crypto Desk</h3>
              <p>BTC/ETH/USDT â†” NGN with clear confirmation steps.</p>
              <div class="card-actions"><a class="btn small" href="#rates">Trade Crypto</a></div>
            </div>
            <div class="hero-card">
              <h3><i class="fa-solid fa-chart-line" style="color:var(--brand)"></i> Insights</h3>
              <p>See community updates and market signals.</p>
              <div class="card-actions"><a class="btn small" href="insights.html">Open Insights</a></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Rates -->
    <section class="section" id="rates">
      <div class="section-head-split">
        <div>
          <h2>Live Exchange Rates</h2>
          <p class="lead">These are loaded from Supabase <b>exchange_rates</b> and update in real time.</p>
        </div>
        <div class="notice" id="rateUpdateTime" style="max-width:max-content">Updated: â€”</div>
      </div>

      <div id="forexRatesGrid" class="grid"></div>

      <div class="section-head-split" style="margin-top:20px">
        <div>
          <h2>Crypto Rates</h2>
          <p class="lead">BTC â€¢ ETH â€¢ USDT</p>
        </div>
      </div>

      <div id="cryptoRatesGrid" class="grid"></div>
    </section>

    <!-- Advanced calculator -->
    <section class="section" id="calculator">
      <div class="card">
        <h2><i class="fa-solid fa-calculator"></i> Advanced Exchange Calculator</h2>
        <p class="lead">Estimate conversion and fee using the current live desk rates.</p>

        <div class="calc-container">
          <div class="calc-row">
            <div>
              <label class="small">You Send</label>
              <input type="number" class="input" id="sendAmount" value="100" min="0" step="0.0001" />
            </div>
            <div>
              <label class="small">Currency</label>
              <select class="input" id="sendCurrency">
                <option value="USD">ðŸ‡ºðŸ‡¸ USD</option>
                <option value="GBP">ðŸ‡¬ðŸ‡§ GBP</option>
                <option value="EUR">ðŸ‡ªðŸ‡º EUR</option>
                <option value="BTC">â‚¿ BTC</option>
                <option value="ETH">Îž ETH</option>
                <option value="USDT">ðŸ’µ USDT</option>
                <option value="NGN">ðŸ‡³ðŸ‡¬ NGN</option>
              </select>
            </div>
          </div>

          <div class="calc-swap">
            <button class="swap-btn" onclick="swapCurrencies()">
              <i class="fa-solid fa-right-left"></i>
            </button>
          </div>

          <div class="calc-row">
            <div>
              <label class="small">You Receive</label>
              <div class="result-box" id="receiveAmount">â€”</div>
            </div>
            <div>
              <label class="small">Currency</label>
              <select class="input" id="receiveCurrency">
                <option value="NGN">ðŸ‡³ðŸ‡¬ NGN</option>
                <option value="USD">ðŸ‡ºðŸ‡¸ USD</option>
                <option value="GBP">ðŸ‡¬ðŸ‡§ GBP</option>
                <option value="EUR">ðŸ‡ªðŸ‡º EUR</option>
                <option value="BTC">â‚¿ BTC</option>
                <option value="ETH">Îž ETH</option>
                <option value="USDT">ðŸ’µ USDT</option>
              </select>
            </div>
          </div>

          <div class="calc-details">
            <div class="detail-row"><span>Rate:</span><span id="calcRate">â€”</span></div>
            <div class="detail-row"><span>Fee:</span><span id="calcFee">â€”</span></div>
            <div class="detail-row"><span>ETA:</span><span id="calcTime">â€”</span></div>
          </div>

          <button class="btn solid" style="width:100%;margin-top:14px" onclick="initiateExchange()">
            <i class="fa-brands fa-whatsapp"></i> Proceed with Exchange
          </button>
        </div>
      </div>
    </section>

    <!-- Request form -->
    <section class="section" id="exchange-form">
      <div class="card">
        <h2>Start Exchange Now</h2>
        <p class="lead">Submit request â€” logs to Supabase + opens WhatsApp with a reference.</p>

        <form id="exchangeRequestForm">
          <div class="row2">
            <div>
              <label class="small">Full Name *</label>
              <input type="text" class="input" id="exName" required />
            </div>
            <div>
              <label class="small">WhatsApp Number *</label>
              <input type="tel" class="input" id="exPhone" required />
            </div>
          </div>

          <div class="row2" style="margin-top:12px">
            <div>
              <label class="small">Exchange Type *</label>
              <select class="input" id="exType" required>
                <option value="">Select exchange type</option>
                <option value="USD to NGN">USD â†’ NGN</option>
                <option value="GBP to NGN">GBP â†’ NGN</option>
                <option value="EUR to NGN">EUR â†’ NGN</option>
                <option value="BTC to NGN">BTC â†’ NGN</option>
                <option value="ETH to NGN">ETH â†’ NGN</option>
                <option value="USDT to NGN">USDT â†’ NGN</option>
                <option value="NGN to USD">NGN â†’ USD</option>
                <option value="NGN to USDT">NGN â†’ USDT</option>
              </select>
            </div>
            <div>
              <label class="small">Amount *</label>
              <input type="number" class="input" id="exAmount" required min="0" step="0.0001" />
            </div>
          </div>

          <div style="margin-top:12px">
            <label class="small">Additional Notes</label>
            <textarea class="input" id="exNotes" rows="3" placeholder="Any special instructions..."></textarea>
          </div>

          <div class="actions" style="margin-top:12px">
            <button type="submit" class="btn solid" style="flex:1">
              <i class="fa-brands fa-whatsapp"></i> Submit Exchange Request
            </button>
          </div>
        </form>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <div class="footer-grid">
        <div>
          <div class="brandline">
            <img src="assets/images/larmah-header.jpeg" alt="Larmah Exchange" />
            <div>
              <div style="font-weight:950">Larmah Enterprise</div>
              <div class="small">Exchange Desk</div>
            </div>
          </div>
          <div class="small" style="margin-top:8px">Rates are admin-managed and update instantly.</div>
        </div>

        <div>
          <b>Links</b>
          <div class="small" style="margin-top:10px"><a href="#rates">Live rates</a></div>
          <div class="small"><a href="#calculator">Calculator</a></div>
          <div class="small"><a href="premium.html">Premium</a></div>
        </div>

        <div>
          <b>Contact Desk</b>
          <div class="small" style="margin-top:10px"><i class="fa-brands fa-whatsapp"></i> +234 706 308 0605</div>
          <div class="small"><i class="fa-regular fa-envelope"></i> business@heylarmah.tech</div>
        </div>
      </div>

      <div class="small">Â© <span id="year"></span> Larmah Enterprise.</div>
    </div>
  </footer>

  <div id="toast" class="toast"></div>

  <!-- Dynamic Exchange Script (Supabase-backed) -->
  <script>
    let RATES = {}; // keyed by code

    function toNum(x){ return x === null || x === undefined ? 0 : Number(x); }

    function fmtNGN(n){
      return "â‚¦" + Number(n || 0).toLocaleString(undefined, { maximumFractionDigits: 2 });
    }

    function buildRatesMap(rows){
      const m = {};
      (rows || []).forEach(r => {
        m[r.code] = {
          code: r.code,
          name: r.name,
          buy: toNum(r.buy_ngn),
          sell: toNum(r.sell_ngn),
          fee: toNum(r.fee_rate),
          min: toNum(r.min_amount),
          max: toNum(r.max_amount),
          updated_at: r.updated_at
        };
      });
      return m;
    }

    function renderTicker(){
      const t = document.getElementById("liveRatesTicker");
      if(!t) return;

      const usd = RATES.USD?.buy || 0;
      const gbp = RATES.GBP?.buy || 0;
      const eur = RATES.EUR?.buy || 0;
      const btc = RATES.BTC?.buy || 0;

      t.innerHTML = `
        <span>
          ðŸ“ˆ LIVE: USD/NGN ${fmtNGN(usd)} â€¢ GBP/NGN ${fmtNGN(gbp)} â€¢ EUR/NGN ${fmtNGN(eur)} â€¢ BTC/NGN ${fmtNGN(btc)}
        </span>
      `;
    }

    function rateCard(code, isCrypto=false){
      const r = RATES[code];
      if(!r) return "";

      const updated = r.updated_at ? new Date(r.updated_at).toLocaleString() : "-";

      return `
        <div class="card rate-card">
          ${isCrypto ? `<div class="rate-badge">CRYPTO</div>` : ``}
          <h3>${LARMAH.escapeHtml(r.name || code)}</h3>
          <div class="rate-main">${fmtNGN(r.buy)}</div>
          <div class="meta" style="margin-top:6px">
            <span>Min: ${r.min} ${code}</span>
            <span class="dot">â€¢</span>
            <span>Max: ${r.max} ${code}</span>
          </div>
          <div class="small" style="margin-top:6px;opacity:.85">
            Fee: ${(r.fee*100).toFixed(2)}% â€¢ Sell: ${fmtNGN(r.sell)}
          </div>
          <div class="small" style="margin-top:6px;opacity:.70">
            Updated: ${updated}
          </div>
          <div class="actions" style="margin-top:10px">
            <button class="btn small primary" onclick="requestQuote('${code}')">
              <i class="fa-brands fa-whatsapp"></i> Exchange ${code}
            </button>
          </div>
        </div>
      `;
    }

    function renderRates(){
      const forex = document.getElementById("forexRatesGrid");
      const crypto = document.getElementById("cryptoRatesGrid");
      const time = document.getElementById("rateUpdateTime");

      const stamp = RATES.USD?.updated_at || RATES.GBP?.updated_at || RATES.EUR?.updated_at || new Date().toISOString();
      if(time) time.textContent = "Updated: " + new Date(stamp).toLocaleTimeString();

      if(forex){
        forex.innerHTML =
          rateCard("USD") +
          rateCard("GBP") +
          rateCard("EUR");
      }

      if(crypto){
        crypto.innerHTML =
          rateCard("BTC", true) +
          rateCard("ETH", true) +
          rateCard("USDT", true);
      }
    }

    function calc(from, to, amount){
      const amt = Number(amount || 0);
      if(!amt) return { converted: 0, rate: 0, fee: 0, feePct: 0 };
      if(from === to) return { converted: amt, rate: 1, fee: 0, feePct: 0 };

      // Receive NGN: use buy_ngn
      if(to === "NGN" && RATES[from]){
        const rate = RATES[from].buy;
        const feePct = RATES[from].fee;
        const converted = amt * rate;
        const fee = converted * feePct;
        return { converted: converted - fee, rate, fee, feePct: feePct*100 };
      }

      // Send NGN: use sell_ngn
      if(from === "NGN" && RATES[to]){
        const rate = 1 / RATES[to].sell;
        const feePct = RATES[to].fee;
        const converted = amt * rate;
        const fee = converted * feePct;
        return { converted: converted - fee, rate, fee, feePct: feePct*100 };
      }

      // Cross via NGN
      if(RATES[from] && RATES[to]){
        const toNgn = RATES[from].buy;
        const ngnTo = 1 / RATES[to].sell;
        const rate = toNgn * ngnTo;
        const feePct = Math.max(RATES[from].fee, RATES[to].fee);
        const converted = amt * rate;
        const fee = converted * feePct;
        return { converted: converted - fee, rate, fee, feePct: feePct*100 };
      }

      return { converted: 0, rate: 0, fee: 0, feePct: 0 };
    }

    function format(amount, currency){
      const n = Number(amount || 0);
      if(currency === "NGN") return "â‚¦" + n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      if(currency === "BTC") return n.toFixed(6) + " BTC";
      if(currency === "ETH") return n.toFixed(4) + " ETH";
      if(currency === "USDT") return n.toFixed(2) + " USDT";
      return n.toFixed(2) + " " + currency;
    }

    function updateQuick(){
      const amount = document.getElementById("quickAmount").value;
      const from = document.getElementById("quickFrom").value;
      const to = document.getElementById("quickTo").value;
      const res = calc(from, to, amount);
      document.getElementById("quickResult").textContent = format(res.converted, to);
    }

    function updateAdvanced(){
      const amount = document.getElementById("sendAmount").value;
      const from = document.getElementById("sendCurrency").value;
      const to = document.getElementById("receiveCurrency").value;

      const res = calc(from, to, amount);
      document.getElementById("receiveAmount").textContent = format(res.converted, to);
      document.getElementById("calcRate").textContent = `1 ${from} â‰ˆ ${format(res.rate, to)}`;
      document.getElementById("calcFee").textContent = `${res.feePct.toFixed(1)}% â€¢ ${format(res.fee, to)}`;

      const eta = (from === "BTC" || from === "ETH" || to === "BTC" || to === "ETH") ? "45â€“120 minutes" : "15â€“30 minutes";
      document.getElementById("calcTime").textContent = eta;
    }

    function requestQuote(code){
      const r = RATES[code];
      if(!r){ LARMAH.toast("Rate not available"); return; }

      const msg = LARMAH.buildMessage("Exchange Quote Request", {
        Pair: `${code} â†’ NGN`,
        BuyRate: fmtNGN(r.buy),
        SellRate: fmtNGN(r.sell),
        Fee: (r.fee*100).toFixed(2) + "%",
        Name: "",
        Phone: ""
      });
      LARMAH.openWhatsApp(msg);
    }

    function swapCurrencies(){
      const from = document.getElementById("sendCurrency");
      const to = document.getElementById("receiveCurrency");
      const tmp = from.value;
      from.value = to.value;
      to.value = tmp;
      updateAdvanced();
    }

    function quickExchange(){
      const msg = LARMAH.buildMessage("Quick Exchange Quote", {
        From: `${document.getElementById("quickAmount").value} ${document.getElementById("quickFrom").value}`,
        To: document.getElementById("quickTo").value,
        Expected: document.getElementById("quickResult").textContent
      });
      LARMAH.openWhatsApp(msg);
    }

    function initiateExchange(){
      const msg = LARMAH.buildMessage("Exchange Initiation", {
        Send: `${document.getElementById("sendAmount").value} ${document.getElementById("sendCurrency").value}`,
        Receive: document.getElementById("receiveAmount").textContent,
        Rate: document.getElementById("calcRate").textContent,
        Name: "",
        Phone: ""
      });
      LARMAH.openWhatsApp(msg);
    }

    async function loadRates(){
      const rows = await LARMAH.fetchExchangeRates();
      RATES = buildRatesMap(rows);

      if(!Object.keys(RATES).length){
        document.getElementById("forexRatesGrid").innerHTML =
          `<div class="notice"><strong>No rates configured.</strong> Admin must set exchange_rates.</div>`;
        document.getElementById("cryptoRatesGrid").innerHTML = "";
        document.getElementById("liveRatesTicker").innerHTML = `<span>Rates not configured (admin).</span>`;
        return;
      }

      renderTicker();
      renderRates();
      updateQuick();
      updateAdvanced();
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await loadRates();

      // realtime updates (requires Supabase Realtime enabled for exchange_rates)
      await LARMAH.subscribeExchangeRates(async () => {
        await loadRates();
      });

      // wire calculator inputs
      ["quickAmount","quickFrom","quickTo"].forEach(id => {
        const el = document.getElementById(id);
        if(el){ el.addEventListener("input", updateQuick); el.addEventListener("change", updateQuick); }
      });
      ["sendAmount","sendCurrency","receiveCurrency"].forEach(id => {
        const el = document.getElementById(id);
        if(el){ el.addEventListener("input", updateAdvanced); el.addEventListener("change", updateAdvanced); }
      });

      // form submission: logs request + WhatsApp
      const form = document.getElementById("exchangeRequestForm");
      if(form){
        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const fields = {
            Name: document.getElementById("exName").value.trim(),
            Phone: document.getElementById("exPhone").value.trim(),
            Exchange: document.getElementById("exType").value.trim(),
            Amount: document.getElementById("exAmount").value.trim(),
            Notes: document.getElementById("exNotes").value.trim() || "-"
          };

          if(!fields.Name || !fields.Phone || !fields.Exchange || !fields.Amount){
            LARMAH.toast("Please fill all required fields");
            return;
          }

          const ref = "WEB-EX-" + Math.random().toString(16).slice(2,10).toUpperCase();
          fields.Ref = ref;

          const res = await LARMAH.submitRequest({
            category: "exchange",
            name: fields.Name,
            phone: fields.Phone,
            details: fields
          });
          if(!res.ok) LARMAH.toast("Logging request...");

          LARMAH.openWhatsApp(LARMAH.buildMessage("Exchange Request", fields));
          form.reset();
          LARMAH.toast("Opening WhatsAppâ€¦");
        });
      }

      // expose globals for buttons
      window.swapCurrencies = swapCurrencies;
      window.quickExchange = quickExchange;
      window.initiateExchange = initiateExchange;
      window.requestQuote = requestQuote;
    });
  </script>
</body>
</html>
