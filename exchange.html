<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Exchange | Larmah Enterprise</title>
  <meta name="description" content="Admin-managed live FX + crypto rates with realtime updates. WhatsApp-first exchange desk." />
  <meta name="theme-color" content="#070A12" />

  <link rel="icon" href="assets/images/larmah-favicon.jpeg" type="image/jpeg" />
  <link rel="preload" href="assets/images/larmah-header.jpeg" as="image" />
  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="assets/js/app.js"></script>
</head>

<body data-page="exchange">
  <div class="live-ticker">
    <div class="container">
      <div id="liveRatesTicker" class="ticker-content"><span>Loading live ratesâ€¦</span></div>
    </div>
  </div>

  <header>
    <div class="container header-inner">
      <a class="brand" href="index.html" aria-label="Larmah Home">
        <img src="assets/images/larmah-header.jpeg" alt="Larmah Enterprise" />
      </a>

      <button class="menu-btn" onclick="LARMAH.toggleMenu()" aria-label="Open menu">
        <i class="fa-solid fa-bars"></i>
      </button>

      <nav id="nav" aria-label="Primary navigation">
        <div class="nav-panel">
          <div class="nav-panel-head">
            <div class="nav-brand">
              <img src="assets/images/larmah-header.jpeg" alt="Larmah Enterprise" />
            </div>
            <button class="nav-close" onclick="LARMAH.closeMenu()" aria-label="Close menu">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>

          <div class="nav-panel-body">
            <ul>
              <li><a class="nav-link" href="real-estate.html" data-link="real-estate">Real Estate <i class="fa-solid fa-chevron-right" style="opacity:.55"></i></a></li>
              <li><a class="nav-link" href="logistics.html" data-link="logistics">Logistics <i class="fa-solid fa-chevron-right" style="opacity:.55"></i></a></li>
              <li><a class="nav-link" href="insights.html" data-link="insights">Insights <i class="fa-solid fa-chevron-right" style="opacity:.55"></i></a></li>
              <li><a class="nav-link" href="exchange.html" data-link="exchange">Exchange <i class="fa-solid fa-chevron-right" style="opacity:.55"></i></a></li>
            </ul>

            <div class="nav-panel-footer">
              <div class="nav-hint">Tip: Tap a section to open. Press ESC to close.</div>
              <a class="btn solid" href="premium.html"><i class="fa-solid fa-star"></i> Premium</a>
              <button class="btn" onclick="LARMAH.openWhatsApp(LARMAH.buildMessage('Quick Help', { Name:'', Phone:'', Message:'Hello Larmah, I need exchange help.' }))">
                <i class="fa-brands fa-whatsapp"></i> WhatsApp Support
              </button>
            </div>
          </div>
        </div>
      </nav>

      <div class="header-actions" id="authPill">
        <a class="pill primary" href="premium.html"><i class="fa-solid fa-star"></i> Premium</a>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <div class="hero-shell">
        <div class="hero-inner">
          <div>
            <div class="hero-kicker">
              <span class="kicker-pill"><i class="fa-solid fa-money-bill-transfer"></i> Live Exchange Desk</span>
              <span class="kicker-dot">â€¢</span>
              <span class="kicker-sub">Dynamic rates â€¢ Admin-managed â€¢ Realtime</span>
            </div>

            <h1>Exchange with Confidence.</h1>
            <p class="lead">Rates load from Supabase <b>exchange_rates</b> and update instantly when Admin changes them.</p>

            <div class="exchange-quick-calc">
              <div class="calc-inputs">
                <div class="input-group">
                  <input type="number" value="100" id="quickAmount" class="input" min="0" step="0.0001">
                  <select class="input" id="quickFrom">
                    <option value="USD">ðŸ‡ºðŸ‡¸ USD</option>
                    <option value="GBP">ðŸ‡¬ðŸ‡§ GBP</option>
                    <option value="EUR">ðŸ‡ªðŸ‡º EUR</option>
                    <option value="BTC">â‚¿ BTC</option>
                    <option value="ETH">Îž ETH</option>
                    <option value="USDT">ðŸ’µ USDT</option>
                    <option value="NGN">ðŸ‡³ðŸ‡¬ NGN</option>
                  </select>
                </div>

                <div class="calc-arrow">â†’</div>

                <div class="input-group">
                  <div class="result-display" id="quickResult">â€”</div>
                  <select class="input" id="quickTo">
                    <option value="NGN">ðŸ‡³ðŸ‡¬ NGN</option>
                    <option value="USD">ðŸ‡ºðŸ‡¸ USD</option>
                    <option value="GBP">ðŸ‡¬ðŸ‡§ GBP</option>
                    <option value="EUR">ðŸ‡ªðŸ‡º EUR</option>
                    <option value="BTC">â‚¿ BTC</option>
                    <option value="ETH">Îž ETH</option>
                    <option value="USDT">ðŸ’µ USDT</option>
                  </select>
                </div>
              </div>

              <div class="actions" style="margin-top:12px">
                <button class="btn solid" onclick="quickExchange()">
                  <i class="fa-brands fa-whatsapp"></i> Get This Rate
                </button>
                <a class="btn" href="#calculator"><i class="fa-solid fa-calculator"></i> Advanced</a>
                <a class="btn primary" href="premium.html"><i class="fa-solid fa-crown"></i> Premium</a>
              </div>
            </div>

            <div class="trust-row">
              <div class="trust-badge"><i class="fa-solid fa-circle-check"></i> Reference IDs</div>
              <div class="trust-badge"><i class="fa-solid fa-shield-halved"></i> Confirm-first workflow</div>
              <div class="trust-badge"><i class="fa-solid fa-bolt"></i> Fast coordination</div>
            </div>
          </div>

          <div class="hero-badges">
            <div class="hero-card">
              <h3><i class="fa-solid fa-dollar-sign" style="color:var(--brand)"></i> FX Desk</h3>
              <p>USD/GBP/EUR â†” NGN. Live admin rates.</p>
              <div class="card-actions"><a class="btn small" href="#rates">View Rates</a></div>
            </div>
            <div class="hero-card">
              <h3><i class="fa-solid fa-coins" style="color:var(--brand)"></i> Crypto Desk</h3>
              <p>BTC/ETH/USDT â†” NGN. Live admin rates.</p>
              <div class="card-actions"><a class="btn small" href="#rates">Trade Crypto</a></div>
            </div>
            <div class="hero-card">
              <h3><i class="fa-solid fa-crown" style="color:var(--brand)"></i> Premium</h3>
              <p>Priority desk routing and faster responses.</p>
              <div class="card-actions"><a class="btn small" href="premium.html">Upgrade</a></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="section" id="rates">
      <div class="section-head-split">
        <div>
          <h2>Live Rates</h2>
          <p class="lead">Loaded from Supabase and updated in realtime.</p>
        </div>
        <div class="notice" id="rateUpdateTime" style="max-width:max-content">Updated: â€”</div>
      </div>

      <div id="forexRatesGrid" class="grid"></div>

      <div class="section-head-split" style="margin-top:20px">
        <div>
          <h2>Crypto Rates</h2>
          <p class="lead">BTC â€¢ ETH â€¢ USDT</p>
        </div>
      </div>

      <div id="cryptoRatesGrid" class="grid"></div>
    </section>

    <section class="section" id="calculator">
      <div class="card">
        <h2><i class="fa-solid fa-calculator"></i> Advanced Calculator</h2>
        <p class="lead">Uses current desk rates + fees.</p>

        <div class="calc-container">
          <div class="calc-row">
            <div>
              <label class="small">You Send</label>
              <input type="number" class="input" id="sendAmount" value="100" min="0" step="0.0001">
            </div>
            <div>
              <label class="small">Currency</label>
              <select class="input" id="sendCurrency">
                <option value="USD">ðŸ‡ºðŸ‡¸ USD</option>
                <option value="GBP">ðŸ‡¬ðŸ‡§ GBP</option>
                <option value="EUR">ðŸ‡ªðŸ‡º EUR</option>
                <option value="BTC">â‚¿ BTC</option>
                <option value="ETH">Îž ETH</option>
                <option value="USDT">ðŸ’µ USDT</option>
                <option value="NGN">ðŸ‡³ðŸ‡¬ NGN</option>
              </select>
            </div>
          </div>

          <div class="calc-swap">
            <button class="swap-btn" onclick="swapCurrencies()"><i class="fa-solid fa-right-left"></i></button>
          </div>

          <div class="calc-row">
            <div>
              <label class="small">You Receive</label>
              <div class="result-box" id="receiveAmount">â€”</div>
            </div>
            <div>
              <label class="small">Currency</label>
              <select class="input" id="receiveCurrency">
                <option value="NGN">ðŸ‡³ðŸ‡¬ NGN</option>
                <option value="USD">ðŸ‡ºðŸ‡¸ USD</option>
                <option value="GBP">ðŸ‡¬ðŸ‡§ GBP</option>
                <option value="EUR">ðŸ‡ªðŸ‡º EUR</option>
                <option value="BTC">â‚¿ BTC</option>
                <option value="ETH">Îž ETH</option>
                <option value="USDT">ðŸ’µ USDT</option>
              </select>
            </div>
          </div>

          <div class="calc-details">
            <div class="detail-row"><span>Rate:</span><span id="calcRate">â€”</span></div>
            <div class="detail-row"><span>Fee:</span><span id="calcFee">â€”</span></div>
            <div class="detail-row"><span>ETA:</span><span id="calcTime">â€”</span></div>
          </div>

          <button class="btn solid" style="width:100%;margin-top:14px" onclick="initiateExchange()">
            <i class="fa-brands fa-whatsapp"></i> Proceed with Exchange
          </button>
        </div>
      </div>
    </section>

    <section class="section" id="exchange-form">
      <div class="card">
        <h2>Start Exchange Now</h2>
        <p class="lead">Logs request to Supabase + opens WhatsApp.</p>

        <form id="exchangeRequestForm">
          <div class="row2">
            <div>
              <label class="small">Full Name *</label>
              <input type="text" class="input" id="exName" required />
            </div>
            <div>
              <label class="small">WhatsApp Number *</label>
              <input type="tel" class="input" id="exPhone" required />
            </div>
          </div>

          <div class="row2" style="margin-top:12px">
            <div>
              <label class="small">Exchange Type *</label>
              <select class="input" id="exType" required>
                <option value="">Select exchange type</option>
                <option value="USD to NGN">USD â†’ NGN</option>
                <option value="GBP to NGN">GBP â†’ NGN</option>
                <option value="EUR to NGN">EUR â†’ NGN</option>
                <option value="BTC to NGN">BTC â†’ NGN</option>
                <option value="ETH to NGN">ETH â†’ NGN</option>
                <option value="USDT to NGN">USDT â†’ NGN</option>
                <option value="NGN to USD">NGN â†’ USD</option>
                <option value="NGN to USDT">NGN â†’ USDT</option>
              </select>
            </div>
            <div>
              <label class="small">Amount *</label>
              <input type="number" class="input" id="exAmount" required min="0" step="0.0001" />
            </div>
          </div>

          <div style="margin-top:12px">
            <label class="small">Notes</label>
            <textarea class="input" id="exNotes" rows="3" placeholder="Any special instructions..."></textarea>
          </div>

          <div class="actions" style="margin-top:12px">
            <button type="submit" class="btn solid" style="flex:1">
              <i class="fa-brands fa-whatsapp"></i> Submit Exchange Request
            </button>
          </div>
        </form>
      </div>
    </section>
  </main>

  <!-- Standard Footer -->
  <footer>
    <div class="container">
      <div class="footer-grid">
        <div>
          <div class="brandline">
            <img src="assets/images/larmah-header.jpeg" alt="Larmah Enterprise" />
            <div>
              <div style="font-weight:950">Larmah Enterprise</div>
              <div class="small">Real Estate â€¢ Logistics â€¢ Insights â€¢ Exchange</div>
            </div>
          </div>

          <div class="small" style="margin-top:8px">
            Trust-first commerce for Nigeria â€” verified listings, trackable enquiries, and WhatsApp-first support.
          </div>

          <div class="social-row" aria-label="Social links">
            <a class="social-btn" href="https://instagram.com/hey_larmah" aria-label="Instagram" title="Instagram"><i class="fa-brands fa-instagram"></i></a>
            <a class="social-btn" href="https://x.com/heylarmah_tech" aria-label="X" title="X (Twitter)"><i class="fa-brands fa-x-twitter"></i></a>
            <a class="social-btn" href="https://t.me/heylarmah_tech" aria-label="Telegram" title="Telegram"><i class="fa-brands fa-telegram"></i></a>
            <a class="social-btn" href="https://youtube.com/@heylarmah" aria-label="YouTube" title="YouTube"><i class="fa-brands fa-youtube"></i></a>
          </div>
        </div>

        <div>
          <b>Navigation</b>
          <div class="small" style="margin-top:10px"><a href="real-estate.html">Real Estate</a></div>
          <div class="small"><a href="logistics.html">Logistics</a></div>
          <div class="small"><a href="insights.html">Insights</a></div>
          <div class="small"><a href="exchange.html">Exchange</a></div>
          <div class="small"><a href="premium.html">Premium</a></div>
        </div>

        <div>
          <b>Contact</b>
          <div class="small" style="margin-top:10px"><i class="fa-brands fa-whatsapp"></i> +234 706 308 0605</div>
          <div class="small"><i class="fa-regular fa-envelope"></i> business@heylarmah.tech</div>
          <div class="small"><i class="fa-solid fa-location-dot"></i> Lagos, Nigeria</div>

          <div class="actions" style="margin-top:12px">
            <button class="btn small" onclick="LARMAH.openWhatsApp(LARMAH.buildMessage('Support', { Name:'', Phone:'', Message:'Hello Larmah, I need help.' }))">
              <i class="fa-brands fa-whatsapp"></i> WhatsApp Support
            </button>
          </div>

          <div class="small" style="margin-top:10px;opacity:.65">
            <a href="auth.html">Staff Sign-in</a> â€¢ <a href="admin.html">Admin</a>
          </div>
        </div>
      </div>

      <div class="small">Â© <span id="year"></span> Larmah Enterprise. All rights reserved.</div>
    </div>
  </footer>

  <div id="toast" class="toast"></div>

  <script>
    let RATES = {};

    function toNum(x){ return x === null || x === undefined ? 0 : Number(x); }
    function fmtNGN(n){ return "â‚¦" + Number(n||0).toLocaleString(undefined,{maximumFractionDigits:2}); }
    function buildRatesMap(rows){
      const m = {};
      (rows||[]).forEach(r=>{
        m[r.code] = {
          code:r.code, name:r.name,
          buy: toNum(r.buy_ngn), sell: toNum(r.sell_ngn),
          fee: toNum(r.fee_rate),
          min: toNum(r.min_amount),
          max: toNum(r.max_amount),
          updated_at: r.updated_at
        };
      });
      return m;
    }

    function renderTicker(){
      const t = document.getElementById("liveRatesTicker");
      const usd = RATES.USD?.buy || 0;
      const gbp = RATES.GBP?.buy || 0;
      const eur = RATES.EUR?.buy || 0;
      const btc = RATES.BTC?.buy || 0;
      t.innerHTML = `<span>ðŸ“ˆ LIVE: USD/NGN ${fmtNGN(usd)} â€¢ GBP/NGN ${fmtNGN(gbp)} â€¢ EUR/NGN ${fmtNGN(eur)} â€¢ BTC/NGN ${fmtNGN(btc)}</span>`;
    }

    function rateCard(code, isCrypto=false){
      const r = RATES[code]; if(!r) return "";
      const updated = r.updated_at ? new Date(r.updated_at).toLocaleString() : "-";
      return `
        <div class="card rate-card">
          ${isCrypto ? `<div class="rate-badge">CRYPTO</div>` : ``}
          <h3>${LARMAH.escapeHtml(r.name || code)}</h3>
          <div class="rate-main">${fmtNGN(r.buy)}</div>
          <div class="meta" style="margin-top:6px">
            <span>Min: ${r.min} ${code}</span>
            <span class="dot">â€¢</span>
            <span>Max: ${r.max} ${code}</span>
          </div>
          <div class="small" style="margin-top:6px;opacity:.85">
            Fee: ${(r.fee*100).toFixed(2)}% â€¢ Sell: ${fmtNGN(r.sell)}
          </div>
          <div class="small" style="margin-top:6px;opacity:.70">Updated: ${updated}</div>
          <div class="actions" style="margin-top:10px">
            <button class="btn small primary" onclick="requestQuote('${code}')">
              <i class="fa-brands fa-whatsapp"></i> Exchange ${code}
            </button>
          </div>
        </div>
      `;
    }

    function renderRates(){
      const forex = document.getElementById("forexRatesGrid");
      const crypto = document.getElementById("cryptoRatesGrid");
      const time = document.getElementById("rateUpdateTime");

      const stamp = RATES.USD?.updated_at || RATES.GBP?.updated_at || RATES.EUR?.updated_at || new Date().toISOString();
      if(time) time.textContent = "Updated: " + new Date(stamp).toLocaleTimeString();

      forex.innerHTML = rateCard("USD") + rateCard("GBP") + rateCard("EUR");
      crypto.innerHTML = rateCard("BTC", true) + rateCard("ETH", true) + rateCard("USDT", true);
    }

    function calc(from, to, amount){
      const amt = Number(amount||0);
      if(!amt) return {converted:0, rate:0, fee:0, feePct:0};
      if(from===to) return {converted:amt, rate:1, fee:0, feePct:0};

      if(to==="NGN" && RATES[from]){
        const rate = RATES[from].buy;
        const feePct = RATES[from].fee;
        const converted = amt*rate;
        const fee = converted*feePct;
        return {converted: converted-fee, rate, fee, feePct: feePct*100};
      }

      if(from==="NGN" && RATES[to]){
        const rate = 1 / RATES[to].sell;
        const feePct = RATES[to].fee;
        const converted = amt*rate;
        const fee = converted*feePct;
        return {converted: converted-fee, rate, fee, feePct: feePct*100};
      }

      if(RATES[from] && RATES[to]){
        const toNgn = RATES[from].buy;
        const ngnTo = 1 / RATES[to].sell;
        const rate = toNgn * ngnTo;
        const feePct = Math.max(RATES[from].fee, RATES[to].fee);
        const converted = amt*rate;
        const fee = converted*feePct;
        return {converted: converted-fee, rate, fee, feePct: feePct*100};
      }

      return {converted:0, rate:0, fee:0, feePct:0};
    }

    function format(amount, currency){
      const n = Number(amount||0);
      if(currency==="NGN") return "â‚¦" + n.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
      if(currency==="BTC") return n.toFixed(6) + " BTC";
      if(currency==="ETH") return n.toFixed(4) + " ETH";
      if(currency==="USDT") return n.toFixed(2) + " USDT";
      return n.toFixed(2) + " " + currency;
    }

    function updateQuick(){
      const res = calc(
        document.getElementById("quickFrom").value,
        document.getElementById("quickTo").value,
        document.getElementById("quickAmount").value
      );
      document.getElementById("quickResult").textContent = format(res.converted, document.getElementById("quickTo").value);
    }

    function updateAdvanced(){
      const from = document.getElementById("sendCurrency").value;
      const to = document.getElementById("receiveCurrency").value;
      const res = calc(from, to, document.getElementById("sendAmount").value);

      document.getElementById("receiveAmount").textContent = format(res.converted, to);
      document.getElementById("calcRate").textContent = `1 ${from} â‰ˆ ${format(res.rate, to)}`;
      document.getElementById("calcFee").textContent = `${res.feePct.toFixed(1)}% â€¢ ${format(res.fee, to)}`;

      const eta = (from==="BTC"||from==="ETH"||to==="BTC"||to==="ETH") ? "45â€“120 minutes" : "15â€“30 minutes";
      document.getElementById("calcTime").textContent = eta;
    }

    function requestQuote(code){
      const r = RATES[code];
      if(!r){ LARMAH.toast("Rate not available"); return; }
      LARMAH.openWhatsApp(LARMAH.buildMessage("Exchange Quote Request", {
        Pair: `${code} â†’ NGN`,
        BuyRate: fmtNGN(r.buy),
        SellRate: fmtNGN(r.sell),
        Fee: (r.fee*100).toFixed(2) + "%",
        Name: "",
        Phone: ""
      }));
    }

    function swapCurrencies(){
      const from = document.getElementById("sendCurrency");
      const to = document.getElementById("receiveCurrency");
      const tmp = from.value;
      from.value = to.value;
      to.value = tmp;
      updateAdvanced();
    }

    function quickExchange(){
      LARMAH.openWhatsApp(LARMAH.buildMessage("Quick Exchange Quote", {
        From: `${document.getElementById("quickAmount").value} ${document.getElementById("quickFrom").value}`,
        To: document.getElementById("quickTo").value,
        Expected: document.getElementById("quickResult").textContent
      }));
    }

    function initiateExchange(){
      LARMAH.openWhatsApp(LARMAH.buildMessage("Exchange Initiation", {
        Send: `${document.getElementById("sendAmount").value} ${document.getElementById("sendCurrency").value}`,
        Receive: document.getElementById("receiveAmount").textContent,
        Rate: document.getElementById("calcRate").textContent,
        Name: "",
        Phone: ""
      }));
    }

    async function loadRates(){
      const rows = await LARMAH.fetchExchangeRates();
      RATES = buildRatesMap(rows);

      if(!Object.keys(RATES).length){
        document.getElementById("forexRatesGrid").innerHTML = `<div class="notice"><strong>No rates configured.</strong> Admin must set exchange_rates.</div>`;
        document.getElementById("cryptoRatesGrid").innerHTML = "";
        document.getElementById("liveRatesTicker").innerHTML = `<span>Rates not configured (admin).</span>`;
        return;
      }

      renderTicker();
      renderRates();
      updateQuick();
      updateAdvanced();
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await loadRates();
      await LARMAH.subscribeExchangeRates(async () => loadRates());

      ["quickAmount","quickFrom","quickTo"].forEach(id=>{
        const el = document.getElementById(id);
        if(el){ el.addEventListener("input", updateQuick); el.addEventListener("change", updateQuick); }
      });
      ["sendAmount","sendCurrency","receiveCurrency"].forEach(id=>{
        const el = document.getElementById(id);
        if(el){ el.addEventListener("input", updateAdvanced); el.addEventListener("change", updateAdvanced); }
      });

      const form = document.getElementById("exchangeRequestForm");
      if(form){
        form.addEventListener("submit", async (e)=>{
          e.preventDefault();

          const fields = {
            Name: document.getElementById("exName").value.trim(),
            Phone: document.getElementById("exPhone").value.trim(),
            Exchange: document.getElementById("exType").value.trim(),
            Amount: document.getElementById("exAmount").value.trim(),
            Notes: document.getElementById("exNotes").value.trim() || "-"
          };

          if(!fields.Name || !fields.Phone || !fields.Exchange || !fields.Amount){
            LARMAH.toast("Please fill all required fields");
            return;
          }

          const ref = "WEB-EX-" + Math.random().toString(16).slice(2,10).toUpperCase();
          fields.Ref = ref;

          const res = await LARMAH.submitRequest({
            category: "exchange",
            name: fields.Name,
            phone: fields.Phone,
            details: fields
          });
          if(!res.ok) LARMAH.toast("Logging request...");

          LARMAH.openWhatsApp(LARMAH.buildMessage("Exchange Request", fields));
          form.reset();
          LARMAH.toast("Opening WhatsAppâ€¦");
        });
      }

      window.swapCurrencies = swapCurrencies;
      window.quickExchange = quickExchange;
      window.initiateExchange = initiateExchange;
      window.requestQuote = requestQuote;
    });
  </script>
</body>
</html>
