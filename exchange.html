<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <title>Exchange | Larmah Enterprise</title>
  <meta name="description" content="Fast, trust-first currency exchange. Transparent quotes, WhatsApp confirmation, and clean reference tracking." />
  <meta name="keywords" content="Currency Exchange Nigeria, USD to NGN, EUR to NGN, FX Rates Lagos, Larmah Exchange" />
  <meta name="author" content="Larmah Enterprise" />
  <meta name="theme-color" content="#070A12" />
  <meta name="color-scheme" content="dark" />
  <meta name="robots" content="index,follow" />
  <link rel="canonical" href="https://heylarmah.tech/exchange.html" />

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:locale" content="en_NG" />
  <meta property="og:url" content="https://heylarmah.tech/exchange.html" />
  <meta property="og:title" content="Larmah Exchange | Trust-First FX" />
  <meta property="og:description" content="Fast FX with WhatsApp confirmation and transparent quoting." />
  <meta property="og:image" content="https://heylarmah.tech/assets/images/larmah-header.jpeg" />
  <meta property="og:image:alt" content="Larmah Exchange — Trust-First FX" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Larmah Exchange" />
  <meta name="twitter:description" content="Trust-first currency exchange with WhatsApp confirmation." />
  <meta name="twitter:image" content="https://heylarmah.tech/assets/images/larmah-header.jpeg" />

  <link rel="icon" href="assets/images/larmah-favicon.jpeg" type="image/jpeg" />
  <link rel="apple-touch-icon" href="assets/images/larmah-favicon.jpeg" />

  <!-- Performance -->
  <link rel="preload" href="assets/images/larmah-header.jpeg" as="image" fetchpriority="high" />
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />

  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="assets/js/app.js"></script>

  <style>
    .page-wrap{ max-width:1120px; margin:0 auto; }

    .hero-shell{
      position:relative;
      overflow:hidden;
      border-radius: var(--radius2, 28px);
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
      box-shadow:
        0 22px 60px rgba(0,0,0,.40),
        0 1px 0 rgba(255,255,255,.04) inset;
    }
    .hero-shell::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(900px 420px at 10% 0%, rgba(212,175,55,.18), transparent 55%),
        radial-gradient(700px 360px at 90% 10%, rgba(0,217,129,.12), transparent 60%),
        radial-gradient(900px 520px at 50% 100%, rgba(0,122,255,.10), transparent 58%);
      pointer-events:none;
    }
    .hero-inner{ position:relative; }

    .hero .actions{
      display:flex; align-items:stretch; gap:12px; flex-wrap:wrap; margin-top:16px;
    }
    .hero .actions .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      white-space:nowrap; line-height:1; min-height:48px; padding:12px 16px;
    }
    @media(min-width: 920px){ .hero .actions .btn{ min-width: 210px; } }
    @media(max-width: 520px){ .hero .actions{ flex-direction:column; } .hero .actions .btn{ width:100%; } }

    .live-dot { display:inline-flex; align-items:center; gap:8px; font-weight:800; font-size:.85rem; color: var(--ok); }
    .live-dot i { font-size: 8px; }

    .grid2{
      display:grid;
      grid-template-columns: 1.3fr .9fr;
      gap: 14px;
    }
    @media(max-width: 940px){ .grid2{ grid-template-columns: 1fr; } }

    .rates-list{ display:grid; gap:10px; margin-top:10px; }
    .rate-row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items:center;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.09);
      background: rgba(255,255,255,0.03);
    }
    .rate-left{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .pair{
      display:flex; gap:8px; align-items:center;
      font-weight: 950;
      letter-spacing:.2px;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 999px;
      padding: 6px 10px;
      color: var(--muted);
      font-size: .82rem;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: .85rem;
    }
    .rate-right{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;
      text-align:right;
    }
    .rate-val{ font-weight: 950; color: var(--accent); }
    .rate-sub{ font-size:.82rem; color: var(--muted); opacity:.9; }

    .notice{
      border-radius: 16px;
      padding: 12px 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: var(--muted);
    }
    .notice strong{ color: var(--text); }

    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media(max-width: 640px){ .row2{ grid-template-columns: 1fr; } }

    .calc-out{
      margin-top:10px;
      padding:12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .calc-out .big{
      font-weight: 950;
      font-size: 1.2rem;
      color: var(--accent);
      margin-top:6px;
    }

    .cta-strip{
      border: 1px solid rgba(255,255,255,.10) !important;
      background: rgba(255,255,255,.03) !important;
      box-shadow:
        0 18px 50px rgba(0,0,0,.35),
        0 1px 0 rgba(255,255,255,.04) inset;
    }
  </style>
</head>

<body data-page="exchange">

  <!-- Mobile nav overlay -->
  <div id="mobileNavOverlay" aria-hidden="true">
    <div class="msheet" role="dialog" aria-label="Mobile navigation">
      <div class="msheet-head">
        <div class="msheet-brand">
          <img src="assets/images/larmah-header.jpeg" alt="Larmah Logo">
        </div>
        <button class="msheet-close" type="button" onclick="LARMAH.toggleMenu()" aria-label="Close Menu">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <div class="msheet-body">
        <div class="msheet-links">
          <a href="real-estate.html" class="msheet-link">
            <span><i class="fa-solid fa-house" style="width:24px;color:var(--brand)"></i> Real Estate</span>
            <i class="fa-solid fa-chevron-right" style="font-size:12px;opacity:.5"></i>
          </a>
          <a href="logistics.html" class="msheet-link">
            <span><i class="fa-solid fa-truck" style="width:24px;color:var(--brand)"></i> Logistics</span>
            <i class="fa-solid fa-chevron-right" style="font-size:12px;opacity:.5"></i>
          </a>
          <a href="exchange.html" class="msheet-link active">
            <span><i class="fa-solid fa-money-bill-transfer" style="width:24px;color:var(--brand)"></i> Exchange</span>
            <i class="fa-solid fa-check" style="font-size:12px;"></i>
          </a>
        </div>

        <div class="msheet-footer">
          <div class="msheet-hint">Menu</div>
          <a href="dashboard.html" class="msheet-link" style="color:var(--accent);border-color:rgba(212,175,55,.2)">
            <span><i class="fa-solid fa-user-shield" style="width:24px"></i> Dashboard</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header>
    <div class="container header-inner">
      <a class="brand" href="index.html" aria-label="Larmah Home">
        <img src="assets/images/larmah-header.jpeg" alt="Larmah Enterprise" />
      </a>

      <button class="menu-btn" type="button" onclick="LARMAH.toggleMenu()" aria-label="Open menu">
        <i class="fa-solid fa-bars"></i>
      </button>

      <nav id="nav" aria-label="Primary navigation">
        <ul>
          <li><a class="nav-link" href="real-estate.html">Real Estate</a></li>
          <li><a class="nav-link" href="logistics.html">Logistics</a></li>
          <li><a class="nav-link active" href="exchange.html">Exchange</a></li>
        </ul>
      </nav>

      <div class="header-actions" style="margin-left:auto; display:none;">
        <a href="dashboard.html" class="pill primary">Dashboard</a>
      </div>

      <script>
        document.addEventListener("DOMContentLoaded", () => {
          if (window.LARMAH && typeof LARMAH.updateHeaderAuthUI === "function") LARMAH.updateHeaderAuthUI();
        });
      </script>
    </div>
  </header>

  <main class="container page-wrap">
    <!-- Hero -->
    <section class="hero" aria-label="Exchange hero">
      <div class="hero-shell">
        <div class="hero-inner">
          <div>
            <div class="hero-kicker">
              <span class="kicker-pill"><i class="fa-solid fa-shield-halved"></i> Trust-First Exchange</span>
              <span class="kicker-dot">•</span>
              <span class="kicker-sub">Transparent Quotes • WhatsApp Confirmation</span>
            </div>

            <h1>Currency Exchange,<br/>Done Properly.</h1>
            <p class="lead">
              Request a quote, confirm via WhatsApp, and keep a clean reference trail for every transaction.
            </p>

            <div class="actions">
              <a class="btn solid" href="#rates"><i class="fa-solid fa-chart-simple"></i> View Rates</a>
              <button class="btn primary" type="button" onclick="openFXWhatsApp()">
                <i class="fa-brands fa-whatsapp"></i> Get Quote
              </button>
              <button class="btn" type="button" onclick="openFXEmail()">
                <i class="fa-regular fa-envelope"></i> Email
              </button>
            </div>

            <div class="trust-row">
              <div class="trust-badge"><i class="fa-solid fa-circle-check"></i> Clear quoting</div>
              <div class="trust-badge"><i class="fa-solid fa-lock"></i> Scam-resistant flow</div>
              <div class="trust-badge"><i class="fa-solid fa-receipt"></i> Ref tracking</div>
            </div>

            <div class="small live-dot" id="liveStateFX" style="margin-top:12px;opacity:.9" aria-live="polite">
              <i class="fa-solid fa-circle fa-beat"></i> Live updates enabled
            </div>
          </div>

          <div class="hero-badges" aria-label="Quick actions">
            <div class="hero-card">
              <h3><i class="fa-solid fa-bolt" style="color:var(--brand)"></i> Fast Quote</h3>
              <p>Request a rate and confirm instantly.</p>
            </div>
            <div class="hero-card">
              <h3><i class="fa-solid fa-user-check" style="color:var(--brand)"></i> Verified Process</h3>
              <p>We keep it simple, traceable, and clean.</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Rates + Converter -->
    <section class="section" id="rates" aria-label="Rates and converter">
      <div class="section-head-split">
        <div>
          <h2>Live Rates</h2>
          <p class="lead">Reference-only display. Final quote is confirmed via WhatsApp.</p>
        </div>
        <a class="btn small" href="premium.html"><i class="fa-solid fa-crown"></i> Premium</a>
      </div>

      <div class="grid2">
        <!-- Rates -->
        <div class="card">
          <div class="section-titleline">
            <h3 style="margin:0"><i class="fa-solid fa-coins" style="color:var(--brand)"></i> Current Market Board</h3>
            <span class="small" id="fxUpdatedAt" style="opacity:.8"></span>
          </div>

          <div id="ratesMount">
            <div class="notice" style="opacity:.85">Loading rates…</div>
          </div>

          <div class="small" style="margin-top:10px;opacity:.7">
            Note: Rates can change quickly. Confirm final quote via WhatsApp before any transfer.
          </div>
        </div>

        <!-- Converter -->
        <div class="card">
          <div class="section-titleline">
            <h3 style="margin:0"><i class="fa-solid fa-calculator" style="color:var(--brand)"></i> Quick Converter</h3>
            <span class="small" style="opacity:.8">Estimate</span>
          </div>

          <div class="row2" style="margin-top:10px">
            <div>
              <label class="small" for="fxFrom">From</label>
              <select id="fxFrom" class="input">
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
                <option value="GBP">GBP</option>
                <option value="NGN">NGN</option>
              </select>
            </div>
            <div>
              <label class="small" for="fxTo">To</label>
              <select id="fxTo" class="input">
                <option value="NGN">NGN</option>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
                <option value="GBP">GBP</option>
              </select>
            </div>
          </div>

          <div style="margin-top:12px">
            <label class="small" for="fxAmount">Amount</label>
            <input id="fxAmount" class="input" placeholder="e.g., 1000" inputmode="decimal" />
          </div>

          <div class="calc-out" id="fxOut">
            <div class="small" style="opacity:.85">Estimated result</div>
            <div class="big">—</div>
            <div class="small" style="margin-top:8px;opacity:.7">Confirm final quote via WhatsApp.</div>
          </div>

          <div class="actions" style="margin-top:12px">
            <button class="btn solid" type="button" style="flex:1" onclick="openFXWhatsApp(true)">
              <i class="fa-brands fa-whatsapp"></i> Confirm Quote
            </button>
            <button class="btn" type="button" onclick="openFXEmail(true)">
              <i class="fa-regular fa-envelope"></i> Email
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- CTA -->
    <section class="section" aria-label="Exchange CTA">
      <div class="cta-strip">
        <div>
          <h2 style="margin:0">Need a guaranteed rate?</h2>
          <p class="lead" style="margin:6px 0 0">Send the currency pair + amount — we’ll respond with a confirmed quote.</p>
        </div>
        <button class="btn solid" type="button" onclick="openFXWhatsApp()">
          <i class="fa-brands fa-whatsapp"></i> Get Quote
        </button>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="footer-grid">
        <div>
          <div class="brandline">
            <img src="assets/images/larmah-header.jpeg" alt="Larmah Enterprise" />
            <div>
              <div style="font-weight:950">Larmah Enterprise</div>
              <div class="small">Real Estate • Logistics • Exchange</div>
            </div>
          </div>

          <div class="small" style="margin-top:8px">
            Trust-first commerce for Nigeria — verified listings, trackable enquiries, and WhatsApp-first support.
          </div>

          <div class="social-row" aria-label="Social links">
            <a class="social-btn" href="https://instagram.com/hey_larmah" aria-label="Instagram" title="Instagram"><i class="fa-brands fa-instagram"></i></a>
            <a class="social-btn" href="https://x.com/heylarmah_tech" aria-label="X" title="X (Twitter)"><i class="fa-brands fa-x-twitter"></i></a>
            <a class="social-btn" href="https://t.me/heylarmah_tech" aria-label="Telegram" title="Telegram"><i class="fa-brands fa-telegram"></i></a>
            <a class="social-btn" href="https://youtube.com/@heylarmah" aria-label="YouTube" title="YouTube"><i class="fa-brands fa-youtube"></i></a>
          </div>
        </div>

        <div>
          <b>Navigation</b>
          <div class="small" style="margin-top:10px"><a href="real-estate.html">Real Estate</a></div>
          <div class="small"><a href="logistics.html">Logistics</a></div>
          <div class="small"><a href="exchange.html">Exchange</a></div>
          <div class="small"><a href="premium.html">Premium</a></div>
        </div>

        <div>
          <b>Contact</b>
          <div class="small" style="margin-top:10px"><i class="fa-brands fa-whatsapp"></i> +234 706 308 0605</div>
          <div class="small"><i class="fa-regular fa-envelope"></i> <span class="mono">business@heylarmah.tech</span></div>
          <div class="small"><i class="fa-solid fa-location-dot"></i> Lagos, Nigeria</div>

          <div class="actions" style="margin-top:12px">
            <button class="btn small" type="button" onclick="openFXWhatsApp()">
              <i class="fa-brands fa-whatsapp"></i> WhatsApp Support
            </button>
          </div>
        </div>
      </div>

      <div class="small">© <span id="year"></span> Larmah Enterprise. All rights reserved.</div>
    </div>
  </footer>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    const BUSINESS_EMAIL_BASE = "business@heylarmah.tech";

    // ===== FX data model (safe + flexible) =====
    // Supports:
    // 1) Supabase table "rates": { base, quote, buy, sell, mid, updated_at, status }
    // 2) Or if your app.js defines window.__rates / LARMAH.getRates(), we use that.
    let __FX = [];

    function sbClient(){
      return window.supabaseClient || (window.ensureSupabaseClient && window.ensureSupabaseClient()) || null;
    }

    async function waitForSupabaseClient({ tries = 12, delay = 250 } = {}){
      for(let i=0;i<tries;i++){
        const sb = sbClient();
        if(sb) return sb;
        await new Promise(r => setTimeout(r, delay));
      }
      return null;
    }

    function safeText(v){ return (v === null || v === undefined) ? "" : String(v); }
    function upper(v){ return safeText(v).trim().toUpperCase(); }

    function fmtNum(n){
      const x = Number(n);
      if(!isFinite(x)) return "—";
      return x.toLocaleString(undefined, { maximumFractionDigits: 2 });
    }

    function refForFX(base, quote){
      const t = Date.now().toString().slice(-6);
      return `WEB-FX-${upper(base)}-${upper(quote)}-${t}`;
    }

    function openEmailCompose({ to, subject, body }){
      const href = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject||"")}&body=${encodeURIComponent(body||"")}`;
      window.location.href = href;
    }

    function openFXWhatsApp(includeCalc=false){
      const from = document.getElementById("fxFrom")?.value || "USD";
      const to = document.getElementById("fxTo")?.value || "NGN";
      const amt = safeText(document.getElementById("fxAmount")?.value).trim();
      const ref = refForFX(from, to);

      const calcLine = includeCalc && amt ? `Amount: ${amt} ${from} → ${to}` : "";

      const msg = LARMAH.buildMessage("FX Quote Request", {
        Pair: `${from}/${to}`,
        ...(calcLine ? { Estimate: calcLine } : {}),
        Ref: ref,
        Email: BUSINESS_EMAIL_BASE
      });

      LARMAH.openWhatsApp(msg);
    }

    function openFXEmail(includeCalc=false){
      const from = document.getElementById("fxFrom")?.value || "USD";
      const to = document.getElementById("fxTo")?.value || "NGN";
      const amt = safeText(document.getElementById("fxAmount")?.value).trim();
      const ref = refForFX(from, to);

      const subject = `FX Quote Request — ${from}/${to} — ${ref}`;
      const body =
`Hello Larmah Team,

Please confirm a quote for:

Pair: ${from}/${to}
${includeCalc && amt ? `Amount: ${amt} ${from}` : `Amount: `}
Ref: ${ref}

My Name:
My Phone:
Notes:

Thank you.`;

      openEmailCompose({ to: BUSINESS_EMAIL_BASE, subject, body });
    }

    function renderRates(){
      const mount = document.getElementById("ratesMount");
      if(!mount) return;

      if(!__FX.length){
        mount.innerHTML = `<div class="notice"><strong>No rates available yet.</strong> Please request a quote via WhatsApp.</div>`;
        return;
      }

      const updatedAt = __FX
        .map(r => r.updated_at || r.updatedAt || r.created_at || r.createdAt)
        .filter(Boolean)
        .sort()
        .slice(-1)[0];

      const fxUpdatedAt = document.getElementById("fxUpdatedAt");
      if(fxUpdatedAt) fxUpdatedAt.textContent = updatedAt ? `Updated: ${new Date(updatedAt).toLocaleString()}` : "";

      mount.innerHTML = `
        <div class="rates-list">
          ${__FX.map(r => {
            const base = upper(r.base || r.from || r.currency_base);
            const quote = upper(r.quote || r.to || r.currency_quote);
            const buy = r.buy ?? r.buy_rate ?? r.buyRate ?? r.rate_buy;
            const sell = r.sell ?? r.sell_rate ?? r.sellRate ?? r.rate_sell;
            const mid = r.mid ?? r.mid_rate ?? r.midRate ?? r.rate ?? r.value;

            const show = (mid !== undefined && mid !== null && String(mid) !== "") ? mid : (sell ?? buy);

            return `
              <div class="rate-row">
                <div class="rate-left">
                  <div class="pair"><i class="fa-solid fa-arrows-rotate" style="opacity:.85"></i> ${base}/${quote}</div>
                  ${buy ? `<span class="chip">Buy: <span class="mono">${fmtNum(buy)}</span></span>` : ``}
                  ${sell ? `<span class="chip">Sell: <span class="mono">${fmtNum(sell)}</span></span>` : ``}
                </div>
                <div class="rate-right">
                  <div>
                    <div class="rate-val">${fmtNum(show)}</div>
                    <div class="rate-sub">Reference</div>
                  </div>
                </div>
              </div>
            `;
          }).join("")}
        </div>
      `;

      // update converter output after render
      calcEstimate();
    }

    function findRate(from, to){
      const a = upper(from), b = upper(to);
      // try direct match
      const direct = __FX.find(r => upper(r.base||r.from||r.currency_base)===a && upper(r.quote||r.to||r.currency_quote)===b);
      if(direct) return direct;
      // try inverse
      const inv = __FX.find(r => upper(r.base||r.from||r.currency_base)===b && upper(r.quote||r.to||r.currency_quote)===a);
      if(inv) return { ...inv, _inverse:true };
      return null;
    }

    function rateValue(r){
      const mid = r.mid ?? r.mid_rate ?? r.midRate ?? r.rate ?? r.value;
      const sell = r.sell ?? r.sell_rate ?? r.sellRate ?? r.rate_sell;
      const buy  = r.buy ?? r.buy_rate ?? r.buyRate ?? r.rate_buy;
      const v = (mid !== undefined && mid !== null && String(mid) !== "") ? mid : (sell ?? buy);
      const n = Number(v);
      return isFinite(n) ? n : null;
    }

    function calcEstimate(){
      const from = document.getElementById("fxFrom")?.value || "USD";
      const to   = document.getElementById("fxTo")?.value || "NGN";
      const amtS = safeText(document.getElementById("fxAmount")?.value).replace(/,/g,"").trim();
      const out = document.getElementById("fxOut");
      if(!out) return;

      const big = out.querySelector(".big");
      if(!amtS || !big){ big.textContent = "—"; return; }

      const amt = Number(amtS);
      if(!isFinite(amt) || amt <= 0){ big.textContent = "—"; return; }

      if(upper(from) === upper(to)){
        big.textContent = `${amt.toLocaleString()} ${upper(to)}`;
        return;
      }

      const r = findRate(from, to);
      if(!r){
        big.textContent = "Rate not available";
        return;
      }

      const v = rateValue(r);
      if(v === null){
        big.textContent = "Rate not available";
        return;
      }

      const res = r._inverse ? (amt / v) : (amt * v);
      big.textContent = `${res.toLocaleString(undefined,{maximumFractionDigits:2})} ${upper(to)}`;
    }

    async function loadRates(){
      // 1) If app.js exposes rates already
      try{
        if(window.__rates && Array.isArray(window.__rates) && window.__rates.length){
          __FX = window.__rates;
          renderRates();
          return;
        }
        if(window.LARMAH && typeof LARMAH.getRates === "function"){
          const rr = await LARMAH.getRates();
          if(Array.isArray(rr) && rr.length){
            __FX = rr;
            renderRates();
            return;
          }
        }
      }catch(e){ console.warn(e); }

      // 2) Supabase fallback
      const mount = document.getElementById("ratesMount");
      try{
        const sb = await waitForSupabaseClient();
        if(!sb) throw new Error("supabaseClient not ready");

        const { data, error } = await sb
          .from("rates")
          .select("*")
          .order("updated_at", { ascending: false });

        if(error) throw error;

        __FX = (data || []).filter(r => {
          const s = safeText(r.status).toLowerCase();
          return !s || s === "active" || s === "published";
        });

        renderRates();
      }catch(e){
        console.error(e);
        if(mount){
          mount.innerHTML = `
            <div class="notice" style="border-color:rgba(255,90,103,.35)">
              <strong>Unable to load rates.</strong> Please request a quote via WhatsApp.
              <div class="actions" style="margin-top:10px">
                <button class="btn small" type="button" onclick="loadRates()">
                  <i class="fa-solid fa-rotate-right"></i> Retry
                </button>
              </div>
            </div>
          `;
        }
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("fxFrom")?.addEventListener("change", calcEstimate);
      document.getElementById("fxTo")?.addEventListener("change", calcEstimate);
      document.getElementById("fxAmount")?.addEventListener("input", calcEstimate);

      loadRates();

      // If your app.js provides realtime helper, subscribe
      if(window.LARMAH && LARMAH.realtime){
        LARMAH.realtime.subscribe("rates", () => loadRates(), "exchange-rates", { debounceMs: 700, statusElId: "liveStateFX" });
      }
    });
  </script>

  <script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015"
    integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ=="
    data-cf-beacon='{"version":"2024.11.0","token":"d59085ad970f4cac8c9e0279fe03c627","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}'
    crossorigin="anonymous"></script>
</body>
</html>
