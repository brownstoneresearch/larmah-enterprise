<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Command | Larmah Enterprise</title>

  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ✅ Fallback client -->
  <script>
    window.SUPABASE_URL = window.SUPABASE_URL || "https://mskbumvopqnrhddfycfd.supabase.co";
    window.SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1za2J1bXZvcHFucmhkZGZ5Y2ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMjA3ODYsImV4cCI6MjA4MTg5Njc4Nn0.68529BHKUz50dHP0ARptYC_OBXFLzpsvlK1ctbDOdZ4";
    window.ensureSupabaseClient = function () {
      if (window.supabaseClient) return window.supabaseClient;
      if (!window.supabase || typeof window.supabase.createClient !== "function") return null;
      window.supabaseClient = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
      return window.supabaseClient;
    };
    window.ensureSupabaseClient();
  </script>

  <script defer src="assets/js/app.js"></script>

  <style>
    #login-gate{position:fixed;inset:0;z-index:10000;background:#050810;display:flex;align-items:center;justify-content:center}
    .login-box{width:420px;max-width:92vw;background:var(--panel);border:1px solid var(--border);padding:40px;border-radius:20px;text-align:center;box-shadow:0 50px 100px rgba(0,0,0,.5)}
    #admin-interface{display:none;height:100vh}
    body{padding-bottom:0;overflow:hidden}
    .admin-layout{display:grid;grid-template-columns:260px 1fr;height:100%}
    .admin-sidebar{background:#050810;border-right:1px solid var(--border);display:flex;flex-direction:column;padding:20px;z-index:10}
    .admin-nav{list-style:none;margin:26px 0 0;padding:0;display:grid;gap:8px}
    .nav-item{padding:12px 14px;border-radius:12px;color:var(--muted);cursor:pointer;display:flex;align-items:center;gap:12px;font-weight:900;font-size:.92rem;transition:all .2s ease;border:1px solid transparent;user-select:none}
    .nav-item:hover{background:rgba(255,255,255,.05);color:var(--text)}
    .nav-item.active{background:rgba(0,217,129,.10);color:var(--brand);border:1px solid rgba(0,217,129,.25)}
    .admin-main{position:relative;overflow-y:auto;padding:30px;background:var(--bg)}
    .admin-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:22px;padding-bottom:14px;border-bottom:1px solid var(--border);gap:12px;flex-wrap:wrap}
    .data-table-wrapper{background:var(--panel);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    table{width:100%;border-collapse:collapse}
    th{text-align:left;padding:14px 16px;background:rgba(255,255,255,.03);color:var(--muted);font-size:.82rem;text-transform:uppercase;letter-spacing:1px}
    td{padding:14px 16px;border-top:1px solid rgba(255,255,255,.05);font-size:.93rem;vertical-align:middle}
    tr:hover td{background:rgba(255,255,255,.02)}
    .tbl-thumb{width:46px;height:46px;border-radius:10px;object-fit:cover;background:#000}
    .badge{padding:4px 10px;border-radius:999px;font-size:.75rem;font-weight:900;display:inline-block}
    .badge.active{background:rgba(67,209,125,.2);color:var(--ok)}
    .badge.draft{background:rgba(255,176,32,.18);color:var(--warn)}
    .badge.sold{background:rgba(255,90,103,.18);color:var(--bad)}
    .badge.closed{background:rgba(255,90,103,.18);color:var(--bad)}
    .action-btn{width:34px;height:34px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid var(--border);background:rgba(255,255,255,.05);color:var(--text);transition:.2s}
    .action-btn:hover{background:#fff;color:#000}
    .action-btn.danger:hover{background:var(--bad);color:#fff;border-color:var(--bad)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(5px);z-index:9999;display:none;align-items:center;justify-content:center;padding:20px}
    .modal.active{display:flex}
    .editor-box{width:820px;max-width:96vw;background:#0f1218;border:1px solid var(--border);border-radius:20px;padding:26px;box-shadow:0 50px 100px rgba(0,0,0,.6);max-height:90vh;overflow-y:auto}
    .form-group{margin-bottom:14px}
    .form-label{display:block;color:var(--muted);font-size:.85rem;margin-bottom:6px;font-weight:900}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:720px){.row2{grid-template-columns:1fr}}
    .status-select{width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);color:#fff;border-radius:12px;padding:8px 10px;font-weight:900;cursor:pointer}
    .img-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media(max-width:720px){.img-grid{grid-template-columns:1fr}}
    .img-slot{border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:12px;background:rgba(255,255,255,.03)}
    .img-slot .slot-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:10px}
    .img-slot .slot-preview{width:100%;height:140px;border-radius:12px;overflow:hidden;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.08)}
    .img-slot .slot-preview img{width:100%;height:100%;object-fit:cover;display:block}
    .img-slot .slot-actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .tiny{font-size:.78rem;opacity:.75}
    .saving{opacity:.7;pointer-events:none}
    @media(max-width:900px){.admin-layout{grid-template-columns:1fr}.admin-sidebar{display:none}}
  </style>
</head>

<body data-page="admin">
  <!-- LOGIN -->
  <div id="login-gate">
    <div class="login-box">
      <img src="assets/images/larmah-header.jpeg" style="width:60px;border-radius:12px;margin:0 auto 18px;display:block" alt="Larmah">
      <h2 style="margin-bottom:10px">Admin Access</h2>
      <p class="small" style="margin-bottom:18px">Super admin only.</p>

      <form id="adminLoginForm">
        <div style="margin-bottom:14px;text-align:left">
          <label class="form-label">Email</label>
          <input type="email" id="admin_email" class="input" placeholder="luckymomodu60@gmail.com" required>
        </div>
        <div style="margin-bottom:20px;text-align:left">
          <label class="form-label">Password</label>
          <input type="password" id="admin_pass" class="input" placeholder="••••••••" required>
        </div>
        <button type="submit" class="btn solid" style="width:100%" id="loginBtn">Authenticate</button>
      </form>

      <div id="loginMsg" class="small" style="margin-top:14px;color:var(--bad);display:none"></div>
      <div class="small" style="margin-top:12px;opacity:.75">
        Not admin? <a href="auth.html" style="color:var(--accent)">Go to Auth</a>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="admin-interface">
    <div class="admin-layout">
      <aside class="admin-sidebar">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:6px">
          <img src="assets/images/larmah-header.jpeg" style="width:42px;border-radius:12px" alt="Larmah">
          <div>
            <div style="font-weight:950;font-size:1rem;">Larmah Admin</div>
            <div style="font-size:0.75rem;color:var(--muted)">Master Control</div>
          </div>
        </div>

        <ul class="admin-nav">
          <li class="nav-item active" onclick="switchView('overview', this)"><i class="fa-solid fa-gauge-high"></i> Overview</li>
          <li class="nav-item" onclick="switchView('all-listings', this)"><i class="fa-solid fa-layer-group"></i> All Listings</li>
          <li class="nav-item" onclick="switchView('real-estate', this)"><i class="fa-solid fa-building"></i> Real Estate</li>
          <li class="nav-item" onclick="switchView('logistics', this)"><i class="fa-solid fa-truck-fast"></i> Logistics</li>
          <li class="nav-item" onclick="switchView('rates', this)"><i class="fa-solid fa-coins"></i> Rates (Pairs)</li>
          <li class="nav-item" onclick="switchView('insights', this)"><i class="fa-regular fa-newspaper"></i> Insights</li>
          <li class="nav-item" onclick="switchView('requests', this)"><i class="fa-solid fa-inbox"></i> Requests</li>
          <li class="nav-item" onclick="switchView('users', this)"><i class="fa-solid fa-users"></i> Users</li>
        </ul>

        <div style="margin-top:auto">
          <button class="btn small" style="width:100%" onclick="adminLogout()">
            <i class="fa-solid fa-arrow-right-from-bracket"></i> Sign Out
          </button>
        </div>
      </aside>

      <main class="admin-main">
        <!-- OVERVIEW -->
        <div id="view-overview" class="view-section">
          <div class="admin-header">
            <h1>System Overview</h1>
            <div class="small" style="color:var(--ok)"><i class="fa-solid fa-shield-halved"></i> Super Admin</div>
          </div>

          <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom:22px">
            <div class="card">
              <div class="small" style="color:var(--muted)">Total Users</div>
              <div style="font-size:2rem;font-weight:950;margin-top:5px" id="stat_users">—</div>
            </div>
            <div class="card">
              <div class="small" style="color:var(--muted)">Total Listings</div>
              <div style="font-size:2rem;font-weight:950;margin-top:5px" id="stat_listings">—</div>
            </div>
            <div class="card">
              <div class="small" style="color:var(--muted)">Requests (Last 7 Days)</div>
              <div style="font-size:2rem;font-weight:950;margin-top:5px" id="stat_requests">—</div>
            </div>
          </div>

          <div class="card">
            <div style="font-weight:950;margin-bottom:6px">Rates (Pairs)</div>
            <div class="small" style="opacity:.8;line-height:1.7">
              Add pairs like <b>BTC/USDT</b>, <b>BTC/NGN</b>, <b>ETH/USDT</b>, <b>ETH/NGN</b>, <b>USDT/NGN</b>.<br/>
              Use Base + Quote. Pair is auto-generated.
            </div>
          </div>
        </div>

        <!-- ALL LISTINGS -->
        <div id="view-all-listings" class="view-section" style="display:none">
          <div class="admin-header">
            <h1>All Listings</h1>
            <button class="btn solid small" onclick="openEditor('listing', null, 'real-estate')"><i class="fa-solid fa-plus"></i> Add Listing</button>
          </div>
          <div class="data-table-wrapper">
            <table>
              <thead><tr><th width="70">Img</th><th>Title</th><th>Category</th><th>Price</th><th>Status</th><th width="170">Actions</th></tr></thead>
              <tbody id="tbody-all-listings"></tbody>
            </table>
          </div>
        </div>

        <!-- REAL ESTATE -->
        <div id="view-real-estate" class="view-section" style="display:none">
          <div class="admin-header">
            <h1>Real Estate</h1>
            <button class="btn solid small" onclick="openEditor('listing', null, 'real-estate')"><i class="fa-solid fa-plus"></i> Add</button>
          </div>
          <div class="data-table-wrapper">
            <table>
              <thead><tr><th width="70">Img</th><th>Title</th><th>Price</th><th>Status</th><th width="170">Actions</th></tr></thead>
              <tbody id="tbody-real-estate"></tbody>
            </table>
          </div>
        </div>

        <!-- LOGISTICS -->
        <div id="view-logistics" class="view-section" style="display:none">
          <div class="admin-header">
            <h1>Logistics</h1>
            <button class="btn solid small" onclick="openEditor('listing', null, 'logistics')"><i class="fa-solid fa-plus"></i> Add</button>
          </div>
          <div class="data-table-wrapper">
            <table>
              <thead><tr><th width="70">Img</th><th>Title</th><th>Rate</th><th>Status</th><th width="170">Actions</th></tr></thead>
              <tbody id="tbody-logistics"></tbody>
            </table>
          </div>
        </div>

        <!-- RATES -->
        <div id="view-rates" class="view-section" style="display:none">
          <div class="admin-header">
            <h1>Rates (Pairs)</h1>
            <button class="btn solid small" onclick="openEditor('rate', null, null)"><i class="fa-solid fa-plus"></i> Add Pair</button>
          </div>
          <div class="data-table-wrapper">
            <table>
              <thead><tr><th>Pair</th><th>We Buy</th><th>We Sell</th><th>Status</th><th width="120">Actions</th></tr></thead>
              <tbody id="tbody-rates"></tbody>
            </table>
          </div>
        </div>

        <!-- INSIGHTS -->
        <div id="view-insights" class="view-section" style="display:none">
          <div class="admin-header">
            <h1>Insights</h1>
            <button class="btn solid small" onclick="openEditor('insight', null, null)"><i class="fa-solid fa-plus"></i> Add Insight</button>
          </div>
          <div class="data-table-wrapper">
            <table>
              <thead><tr><th>Title</th><th>Category</th><th>Date</th><th>Status</th><th width="170">Actions</th></tr></thead>
              <tbody id="tbody-insights"></tbody>
            </table>
          </div>
        </div>

        <!-- REQUESTS -->
        <div id="view-requests" class="view-section" style="display:none">
          <div class="admin-header">
            <h1>Requests</h1>
            <button class="btn small" onclick="fetchRequests()"><i class="fa-solid fa-rotate"></i> Refresh</button>
          </div>
          <div class="data-table-wrapper">
            <table>
              <thead><tr><th>Category</th><th>Created</th><th>Status</th><th width="170">Update Status</th><th width="70">View</th></tr></thead>
              <tbody id="tbody-requests"></tbody>
            </table>
          </div>
        </div>

        <!-- USERS -->
        <div id="view-users" class="view-section" style="display:none">
          <div class="admin-header">
            <h1>Users</h1>
            <button class="btn small" onclick="fetchUsers()"><i class="fa-solid fa-rotate"></i> Refresh</button>
          </div>
          <div class="data-table-wrapper">
            <table>
              <thead><tr><th>Email / ID</th><th>Full Name</th><th>Joined</th><th>Status</th></tr></thead>
              <tbody id="tbody-users"></tbody>
            </table>
          </div>
        </div>

      </main>
    </div>
  </div>

  <!-- Quick upload (table editor) -->
  <input id="quickUploadInput" type="file" accept="image/*" style="display:none">

  <!-- EDITOR MODAL -->
  <div id="editorModal" class="modal">
    <div class="editor-box">
      <div style="display:flex;justify-content:space-between;margin-bottom:18px;align-items:center;gap:12px">
        <h2 id="editorTitle" style="margin:0">Edit</h2>
        <button class="action-btn" type="button" onclick="closeEditor()"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <form id="editorForm">
        <input type="hidden" id="edit_entity">
        <input type="hidden" id="edit_id">
        <input type="hidden" id="edit_category">

        <!-- LISTING -->
        <div id="fields-listing" style="display:none">
          <div class="form-group">
            <label class="form-label">Category</label>
            <input type="text" id="listing_category" class="input" placeholder="e.g. real-estate, logistics, etc" required>
            <div class="tiny">You can publish to any category. Use <b>real-estate</b> or <b>logistics</b> for main pages.</div>
          </div>

          <div class="form-group">
            <label class="form-label">Title</label>
            <input type="text" id="listing_title" class="input" required>
          </div>

          <div class="row2">
            <div class="form-group">
              <label class="form-label">Price / Rate</label>
              <input type="text" id="listing_price" class="input">
            </div>
            <div class="form-group">
              <label class="form-label">Status</label>
              <select id="listing_status" class="input">
                <option value="active">Active</option>
                <option value="draft">Draft</option>
                <option value="sold">Sold</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Description</label>
            <textarea id="listing_desc" class="input" rows="4"></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Tags (comma separated)</label>
            <input type="text" id="listing_tags" class="input" placeholder="lekki, shortlet, vi">
          </div>

          <div class="form-group">
            <label class="form-label">Images (1–3)</label>
            <div class="tiny">Upload or paste URLs. First image becomes the main image.</div>

            <div class="img-grid" style="margin-top:10px">
              ${[1,2,3].map(i=>`
              <div class="img-slot">
                <div class="slot-head"><b>Image ${i}${i===1?' (Main)':''}</b><button type="button" class="btn small" onclick="clearSlot('listing',${i})">Clear</button></div>
                <input type="file" id="listing_file_${i}" class="input" accept="image/*">
                <div class="slot-preview" style="margin-top:10px"><img id="listing_prev_${i}" src="" alt=""></div>
                <div class="slot-actions"><input type="text" id="listing_url_${i}" class="input" placeholder="or paste URL"></div>
              </div>`).join("")}
            </div>
          </div>
        </div>

        <!-- RATE (PAIRS) -->
        <div id="fields-rate" style="display:none">
          <div class="row2">
            <div class="form-group">
              <label class="form-label">Base (e.g. BTC)</label>
              <input type="text" id="rate_base" class="input" placeholder="BTC" required>
            </div>
            <div class="form-group">
              <label class="form-label">Quote (e.g. USDT / NGN)</label>
              <input type="text" id="rate_quote" class="input" placeholder="USDT" required>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Pair (auto)</label>
            <input type="text" id="rate_pair" class="input" placeholder="BTC/USDT" disabled>
            <div class="tiny">Pair is generated as BASE/QUOTE. Example: BTC/USDT, ETH/NGN, USDT/NGN.</div>
          </div>

          <div class="row2">
            <div class="form-group">
              <label class="form-label">We Buy</label>
              <input type="number" id="rate_buy" class="input" step="0.01">
            </div>
            <div class="form-group">
              <label class="form-label">We Sell</label>
              <input type="number" id="rate_sell" class="input" step="0.01">
            </div>
          </div>

          <div class="row2">
            <div class="form-group">
              <label class="form-label">Status</label>
              <select id="rate_status" class="input">
                <option value="active">Active</option>
                <option value="draft">Draft</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Quick presets</label>
              <select id="rate_preset" class="input">
                <option value="">Select preset…</option>
                <option value="USDT/NGN">USDT/NGN</option>
                <option value="BTC/USDT">BTC/USDT</option>
                <option value="BTC/NGN">BTC/NGN</option>
                <option value="ETH/USDT">ETH/USDT</option>
                <option value="ETH/NGN">ETH/NGN</option>
              </select>
            </div>
          </div>
        </div>

        <!-- INSIGHT -->
        <div id="fields-insight" style="display:none">
          <div class="form-group">
            <label class="form-label">Title</label>
            <input type="text" id="insight_title" class="input" required>
          </div>

          <div class="row2">
            <div class="form-group">
              <label class="form-label">Category</label>
              <select id="insight_category" class="input">
                <option value="real-estate">Real Estate</option>
                <option value="logistics">Logistics</option>
                <option value="exchange">Exchange</option>
                <option value="all">All</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Status</label>
              <select id="insight_status" class="input">
                <option value="active">Active</option>
                <option value="draft">Draft</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Summary</label>
            <textarea id="insight_summary" class="input" rows="4"></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Images (1–3)</label>
            <div class="tiny">Upload or paste URLs. First image becomes the main insight image.</div>

            <div class="img-grid" style="margin-top:10px">
              ${[1,2,3].map(i=>`
              <div class="img-slot">
                <div class="slot-head"><b>Image ${i}${i===1?' (Main)':''}</b><button type="button" class="btn small" onclick="clearSlot('insight',${i})">Clear</button></div>
                <input type="file" id="insight_file_${i}" class="input" accept="image/*">
                <div class="slot-preview" style="margin-top:10px"><img id="insight_prev_${i}" src="" alt=""></div>
                <div class="slot-actions"><input type="text" id="insight_url_${i}" class="input" placeholder="or paste URL"></div>
              </div>`).join("")}
            </div>
          </div>
        </div>

        <!-- REQUEST -->
        <div id="fields-request" style="display:none">
          <div class="form-group"><label class="form-label">Category</label><input type="text" id="req_category" class="input" disabled></div>
          <div class="row2">
            <div class="form-group"><label class="form-label">Created</label><input type="text" id="req_created" class="input" disabled></div>
            <div class="form-group"><label class="form-label">Status</label><input type="text" id="req_status" class="input" disabled></div>
          </div>
          <div class="form-group"><label class="form-label">Payload</label><textarea id="req_payload" class="input" rows="10" disabled></textarea></div>
        </div>

        <div style="margin-top:18px;display:flex;gap:10px">
          <button type="submit" class="btn solid" style="flex:1" id="saveBtn">Save</button>
          <button type="button" class="btn" onclick="closeEditor()">Close</button>
        </div>

        <div class="small" style="margin-top:10px;opacity:.7" id="editorHint"></div>
      </form>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const STORAGE_BUCKET = "larmah-media";
    const ONLY_ADMIN_EMAIL = "luckymomodu60@gmail.com";
    let sb = null;

    const CACHE = { listings:new Map(), rates:new Map(), insights:new Map(), requests:new Map() };

    function toast(msg, type="info"){
      try { if (window.LARMAH && typeof LARMAH.toast === "function") LARMAH.toast(msg, type); } catch {}
      const t = document.getElementById("toast");
      if(!t) return;
      t.textContent = msg;
      t.className = `toast show ${type}`;
      setTimeout(()=> t.className="toast", 4000);
    }

    function showLogin(msg=null){
      document.getElementById("login-gate").style.display = "flex";
      document.getElementById("admin-interface").style.display = "none";
      const el = document.getElementById("loginMsg");
      if(!el) return;
      if(msg){ el.textContent = msg; el.style.display = "block"; }
      else { el.style.display = "none"; }
    }
    function showAdmin(){
      document.getElementById("login-gate").style.display = "none";
      document.getElementById("admin-interface").style.display = "block";
    }

    function badgeClass(status){
      const s = String(status||"").toLowerCase();
      if(s === "active") return "active";
      if(s === "draft") return "draft";
      if(s === "sold") return "sold";
      if(s === "closed") return "closed";
      if(s === "processing") return "draft";
      if(s === "done") return "active";
      return "draft";
    }

    function safeDate(d){ try { return new Date(d).toLocaleString(); } catch { return ""; } }
    function setFieldsVisible(entity){
      ["listing","rate","insight","request"].forEach(k => {
        const el = document.getElementById("fields-" + k);
        if(el) el.style.display = (k === entity) ? "block" : "none";
      });
      document.getElementById("saveBtn").style.display = (entity === "request") ? "none" : "";
    }

    // Storage helpers
    function randomId(len=10){ return Math.random().toString(36).slice(2, 2+len); }
    async function uploadToStorage(file, folder){
      if(!file) return null;
      const maxMb = 10;
      if(file.size > maxMb*1024*1024) throw new Error(`File too large. Max ${maxMb}MB`);

      const ext = (file.name.split(".").pop() || "jpg").toLowerCase().replace(/[^a-z0-9]/g,"") || "jpg";
      const path = `${folder}/${Date.now()}-${randomId(8)}.${ext}`;

      const { error: upErr } = await sb.storage.from(STORAGE_BUCKET).upload(path, file, { cacheControl:"3600", upsert:false });
      if(upErr) throw upErr;

      const { data } = sb.storage.from(STORAGE_BUCKET).getPublicUrl(path);
      const url = data?.publicUrl;
      if(!url) throw new Error("Could not generate public URL");
      return { path, url };
    }

    // Image slots
    function clearSlot(kind, idx){
      const file = document.getElementById(`${kind}_file_${idx}`);
      const url = document.getElementById(`${kind}_url_${idx}`);
      const prev = document.getElementById(`${kind}_prev_${idx}`);
      if(file) file.value = "";
      if(url) url.value = "";
      if(prev) prev.src = "";
    }
    function bindFilePreview(kind, idx){
      const file = document.getElementById(`${kind}_file_${idx}`);
      const prev = document.getElementById(`${kind}_prev_${idx}`);
      if(!file || !prev) return;
      file.addEventListener("change", () => {
        const f = file.files?.[0];
        if(!f) return;
        prev.src = URL.createObjectURL(f);
      });
    }
    function getSlotUrl(kind, idx){ return (document.getElementById(`${kind}_url_${idx}`)?.value || "").trim(); }
    function setSlotUrl(kind, idx, v){ const el = document.getElementById(`${kind}_url_${idx}`); if(el) el.value = v || ""; }
    function setSlotPreview(kind, idx, url){ const el = document.getElementById(`${kind}_prev_${idx}`); if(el) el.src = url || ""; }

    async function collectImages(kind, folder){
      const urls = [];
      const paths = [];
      for(let i=1;i<=3;i++){
        const file = document.getElementById(`${kind}_file_${i}`)?.files?.[0] || null;
        const manual = getSlotUrl(kind, i);

        if(file){
          const up = await uploadToStorage(file, folder);
          urls.push(up.url);
          paths.push(up.path);
          setSlotUrl(kind, i, up.url);
          setSlotPreview(kind, i, up.url);
        } else if(manual){
          urls.push(manual);
          paths.push(null);
          setSlotPreview(kind, i, manual);
        }
      }
      return { urls, paths };
    }

    function pickThumb(it){
      if (Array.isArray(it.image_urls) && it.image_urls[0]) return it.image_urls[0];
      if (it.image_url) return it.image_url;
      return "assets/images/larmah-header.jpeg";
    }

    // Quick upload main image
    async function quickUploadMainImage(entity, id, category=null){
      const input = document.getElementById("quickUploadInput");
      if(!input) return;

      input.value = "";
      input.onchange = async () => {
        const file = input.files?.[0];
        if(!file) return;

        try{
          toast("Uploading image…", "info");
          const folder = (entity === "insight") ? "insights" : "listings";
          const up = await uploadToStorage(file, folder);

          const table = (entity === "insight") ? "insights" : "listings";
          const cacheMap = (entity === "insight") ? CACHE.insights : CACHE.listings;
          const current = cacheMap.get(String(id)) || {};

          const nextUrls = Array.isArray(current.image_urls) ? current.image_urls.slice(0,3) : [];
          const nextPaths = Array.isArray(current.image_paths) ? current.image_paths.slice(0,3) : [];
          nextUrls[0] = up.url;
          nextPaths[0] = up.path;

          const payload = { image_url: up.url, image_path: up.path, image_urls: nextUrls, image_paths: nextPaths };

          const res = await sb.from(table).update(payload).eq("id", id).select().single();
          if(res.error) throw res.error;

          toast("Image updated ✅", "success");
          if(entity === "listing"){
            await fetchListings("all");
            if(category) await fetchListings(category);
          } else {
            await fetchInsights();
          }
        }catch(e){
          console.warn(e);
          toast(e?.message || "Upload failed", "error");
        }
      };

      input.click();
    }

    // Admin check
    async function assertOnlyAdmin(){
      const { data } = await sb.auth.getSession();
      if(!data?.session) throw new Error("No session");

      const email = (data.session.user.email || "").toLowerCase();
      if(email !== ONLY_ADMIN_EMAIL){
        await sb.auth.signOut();
        throw new Error("Access denied: Admins only.");
      }

      const { data: isAdmin, error } = await sb.rpc("is_admin");
      if(error) throw error;
      if(!isAdmin){
        await sb.auth.signOut();
        throw new Error("Access denied: Admins only.");
      }
      return true;
    }

    async function initAdmin(){
      sb = (window.ensureSupabaseClient ? window.ensureSupabaseClient() : window.supabaseClient);
      if(!sb){ showLogin("Supabase not ready."); return; }

      const { data } = await sb.auth.getSession();
      if(!data?.session){ showLogin(); return; }

      try{ await assertOnlyAdmin(); }
      catch(e){ showLogin(e.message || "Access denied"); window.location.href="auth.html"; return; }

      showAdmin();
      await loadStats();
      await fetchListings("all");
    }

    async function adminLogin(email, password){
      const btn = document.getElementById("loginBtn");
      const msg = document.getElementById("loginMsg");
      msg.style.display = "none";

      btn.disabled = true;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Verifying...';

      const { error } = await sb.auth.signInWithPassword({ email, password });

      btn.disabled = false;
      btn.textContent = "Authenticate";

      if(error){
        msg.textContent = "Invalid Credentials: " + error.message;
        msg.style.display = "block";
        return;
      }

      try{
        await assertOnlyAdmin();
        showAdmin();
        await loadStats();
        switchView("overview", document.querySelector(".nav-item"));
      }catch(e){
        await sb.auth.signOut();
        msg.textContent = e.message || "Access denied";
        msg.style.display = "block";
        window.location.href="auth.html";
      }
    }

    async function adminLogout(){
      await sb.auth.signOut();
      window.location.href = "auth.html";
    }

    // Nav
    function switchView(viewId, el){
      document.querySelectorAll(".view-section").forEach(v => v.style.display = "none");
      const view = document.getElementById("view-" + viewId);
      if(view) view.style.display = "block";

      document.querySelectorAll(".nav-item").forEach(n => n.classList.remove("active"));
      if(el) el.classList.add("active");

      if(viewId === "overview") loadStats();
      if(viewId === "all-listings") fetchListings("all");
      if(viewId === "real-estate") fetchListings("real-estate");
      if(viewId === "logistics") fetchListings("logistics");
      if(viewId === "rates") fetchRates();
      if(viewId === "insights") fetchInsights();
      if(viewId === "requests") fetchRequests();
      if(viewId === "users") fetchUsers();
    }

    // Stats
    async function loadStats(){
      try { const { count } = await sb.from("listings").select("*",{count:"exact", head:true}); document.getElementById("stat_listings").textContent = count ?? 0; }
      catch { document.getElementById("stat_listings").textContent = "—"; }

      try { const { count } = await sb.from("profiles").select("*",{count:"exact", head:true}); document.getElementById("stat_users").textContent = count ?? 0; }
      catch { document.getElementById("stat_users").textContent = "—"; }

      try{
        const since = new Date(Date.now()-7*24*60*60*1000).toISOString();
        const { count } = await sb.from("requests").select("*",{count:"exact", head:true}).gte("created_at", since);
        document.getElementById("stat_requests").textContent = count ?? 0;
      }catch{ document.getElementById("stat_requests").textContent = "—"; }
    }

    // Listings fetch
    async function fetchListings(category){
      const isAll = !category || category === "all";
      const tbody = document.getElementById(
        isAll ? "tbody-all-listings" :
        (category === "real-estate" ? "tbody-real-estate" : "tbody-logistics")
      );
      const colspan = isAll ? 6 : 5;
      tbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align:center">Loading...</td></tr>`;

      try{
        let q = sb.from("listings").select("*").order("created_at",{ascending:false});
        if(!isAll) q = q.eq("category", category);
        const { data, error } = await q;
        if(error) throw error;

        CACHE.listings.clear();
        (data||[]).forEach(it => CACHE.listings.set(String(it.id), it));

        if(!data?.length){
          tbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align:center">No items found.</td></tr>`;
          return;
        }

        tbody.innerHTML = data.map(it => {
          const cat = it.category || "";
          const actions = `
            <div style="display:flex;gap:8px">
              <button class="action-btn" title="Edit" onclick="openEditor('listing','${String(it.id)}','${LARMAH.escapeHtml(cat)}')"><i class="fa-solid fa-pen"></i></button>
              <button class="action-btn" title="Upload Image" onclick="quickUploadMainImage('listing','${String(it.id)}','${LARMAH.escapeHtml(cat)}')"><i class="fa-solid fa-image"></i></button>
              <button class="action-btn danger" title="Delete" onclick="deleteEntity('listing','${String(it.id)}','${LARMAH.escapeHtml(cat)}')"><i class="fa-solid fa-trash"></i></button>
            </div>
          `;

          if(isAll){
            return `
              <tr>
                <td><img class="tbl-thumb" src="${LARMAH.escapeHtml(pickThumb(it))}" onerror="this.src='assets/images/larmah-header.jpeg'"></td>
                <td><div style="font-weight:950">${LARMAH.escapeHtml(it.title||"")}</div><div style="font-size:.8rem;opacity:.55;font-family:ui-monospace">${LARMAH.escapeHtml(String(it.id))}</div></td>
                <td>${LARMAH.escapeHtml(cat)}</td>
                <td style="color:var(--accent);font-weight:900">${LARMAH.escapeHtml(it.price||"")}</td>
                <td><span class="badge ${badgeClass(it.status)}">${LARMAH.escapeHtml(it.status||"draft")}</span></td>
                <td>${actions}</td>
              </tr>
            `;
          }

          return `
            <tr>
              <td><img class="tbl-thumb" src="${LARMAH.escapeHtml(pickThumb(it))}" onerror="this.src='assets/images/larmah-header.jpeg'"></td>
              <td><div style="font-weight:950">${LARMAH.escapeHtml(it.title||"")}</div><div style="font-size:.8rem;opacity:.55;font-family:ui-monospace">${LARMAH.escapeHtml(String(it.id))}</div></td>
              <td style="color:var(--accent);font-weight:900">${LARMAH.escapeHtml(it.price||"")}</td>
              <td><span class="badge ${badgeClass(it.status)}">${LARMAH.escapeHtml(it.status||"draft")}</span></td>
              <td>${actions}</td>
            </tr>
          `;
        }).join("");
      }catch(e){
        console.warn(e);
        tbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align:center">Error loading listings.</td></tr>`;
      }
    }

    // ✅ Rates fetch (pairs)
    async function fetchRates(){
      const tbody = document.getElementById("tbody-rates");
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center">Loading...</td></tr>`;

      try{
        const { data, error } = await sb.from("rates").select("*").order("pair",{ascending:true});
        if(error) throw error;

        CACHE.rates.clear();
        (data||[]).forEach(it => CACHE.rates.set(String(it.id), it));

        if(!data?.length){
          tbody.innerHTML = `<tr><td colspan="5" style="text-align:center">No rates found.</td></tr>`;
          return;
        }

        tbody.innerHTML = data.map(it => `
          <tr>
            <td style="font-weight:950">${LARMAH.escapeHtml(String(it.pair || ((it.base||it.asset||"") + "/" + (it.quote||"NGN"))))}</td>
            <td style="color:var(--ok);font-weight:950">${LARMAH.escapeHtml(String(it.buy ?? ""))}</td>
            <td style="color:var(--warn);font-weight:950">${LARMAH.escapeHtml(String(it.sell ?? ""))}</td>
            <td><span class="badge ${badgeClass(it.status)}">${LARMAH.escapeHtml(it.status || "draft")}</span></td>
            <td>
              <div style="display:flex;gap:8px">
                <button class="action-btn" onclick="openEditor('rate','${String(it.id)}',null)"><i class="fa-solid fa-pen"></i></button>
                <button class="action-btn danger" onclick="deleteEntity('rate','${String(it.id)}',null)"><i class="fa-solid fa-trash"></i></button>
              </div>
            </td>
          </tr>
        `).join("");
      }catch(e){
        console.warn(e);
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center">Error loading rates.</td></tr>`;
      }
    }

    async function fetchInsights(){
      const tbody = document.getElementById("tbody-insights");
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center">Loading...</td></tr>`;
      try{
        const { data, error } = await sb.from("insights").select("*").order("created_at",{ascending:false}).limit(250);
        if(error) throw error;

        CACHE.insights.clear();
        (data||[]).forEach(it => CACHE.insights.set(String(it.id), it));

        if(!data?.length){
          tbody.innerHTML = `<tr><td colspan="5" style="text-align:center">No insights found.</td></tr>`;
          return;
        }

        tbody.innerHTML = data.map(it => `
          <tr>
            <td style="font-weight:950">${LARMAH.escapeHtml(it.title || "")}</td>
            <td>${LARMAH.escapeHtml(it.category || "all")}</td>
            <td class="small">${it.created_at ? new Date(it.created_at).toLocaleDateString() : ""}</td>
            <td><span class="badge ${badgeClass(it.status)}">${LARMAH.escapeHtml(it.status || "draft")}</span></td>
            <td>
              <div style="display:flex;gap:8px">
                <button class="action-btn" title="Edit" onclick="openEditor('insight','${String(it.id)}',null)"><i class="fa-solid fa-pen"></i></button>
                <button class="action-btn" title="Upload Image" onclick="quickUploadMainImage('insight','${String(it.id)}',null)"><i class="fa-solid fa-image"></i></button>
                <button class="action-btn danger" title="Delete" onclick="deleteEntity('insight','${String(it.id)}',null)"><i class="fa-solid fa-trash"></i></button>
              </div>
            </td>
          </tr>
        `).join("");
      }catch(e){
        console.warn(e);
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center">Error loading insights.</td></tr>`;
      }
    }

    async function fetchRequests(){
      const tbody = document.getElementById("tbody-requests");
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center">Loading...</td></tr>`;
      try{
        const { data, error } = await sb.from("requests").select("*").order("created_at",{ascending:false}).limit(500);
        if(error) throw error;

        CACHE.requests.clear();
        (data||[]).forEach(it => CACHE.requests.set(String(it.id), it));

        if(!data?.length){
          tbody.innerHTML = `<tr><td colspan="5" style="text-align:center">No requests yet.</td></tr>`;
          return;
        }

        tbody.innerHTML = data.map(it => `
          <tr>
            <td style="font-weight:950">${LARMAH.escapeHtml(it.category || "general")}</td>
            <td class="small">${it.created_at ? new Date(it.created_at).toLocaleString() : ""}</td>
            <td><span class="badge ${badgeClass(it.status)}">${LARMAH.escapeHtml(it.status || "new")}</span></td>
            <td>
              <select class="status-select" onchange="updateRequestStatus('${String(it.id)}', this.value)">
                <option value="new" ${String(it.status||"new")==="new"?"selected":""}>new</option>
                <option value="processing" ${String(it.status||"")==="processing"?"selected":""}>processing</option>
                <option value="done" ${String(it.status||"")==="done"?"selected":""}>done</option>
                <option value="closed" ${String(it.status||"")==="closed"?"selected":""}>closed</option>
              </select>
            </td>
            <td><button class="btn small" onclick="openEditor('request','${String(it.id)}',null)">View</button></td>
          </tr>
        `).join("");
      }catch(e){
        console.warn(e);
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center">Error loading requests.</td></tr>`;
      }
    }

    async function updateRequestStatus(id, status){
      try{
        const { error } = await sb.from("requests").update({ status }).eq("id", id);
        if(error) throw error;
        toast("Request status updated ✅","success");
        await loadStats();
        await fetchRequests();
      }catch(e){
        toast(e.message || "Update failed","error");
      }
    }

    async function fetchUsers(){
      const tbody = document.getElementById("tbody-users");
      tbody.innerHTML = `<tr><td colspan="4" style="text-align:center">Loading...</td></tr>`;
      try{
        const { data, error } = await sb.from("profiles").select("*").order("created_at",{ascending:false}).limit(500);
        if(error) throw error;

        if(!data?.length){
          tbody.innerHTML = `<tr><td colspan="4" style="text-align:center">No profiles found.</td></tr>`;
          return;
        }

        tbody.innerHTML = data.map(u => `
          <tr>
            <td><div>${LARMAH.escapeHtml(u.email || "N/A")}</div><div style="font-size:.8rem;opacity:.55;font-family:ui-monospace">${LARMAH.escapeHtml(String(u.id||""))}</div></td>
            <td>${LARMAH.escapeHtml(u.full_name || "User")}</td>
            <td>${u.created_at ? new Date(u.created_at).toLocaleDateString() : ""}</td>
            <td><span class="badge active">Active</span></td>
          </tr>
        `).join("");
      }catch(e){
        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center">Error loading users.</td></tr>`;
      }
    }

    // Editor
    function resetEditor(){
      document.getElementById("editorForm").reset();
      document.getElementById("edit_entity").value = "";
      document.getElementById("edit_id").value = "";
      document.getElementById("edit_category").value = "";
      document.getElementById("editorHint").textContent = "";
      ["listing","insight"].forEach(kind => { for(let i=1;i<=3;i++) clearSlot(kind,i); });
    }

    function setRatePairPreview(){
      const base = (document.getElementById("rate_base").value || "").trim().toUpperCase();
      const quote = (document.getElementById("rate_quote").value || "").trim().toUpperCase();
      document.getElementById("rate_pair").value = (base && quote) ? `${base}/${quote}` : "";
    }

    function openEditor(entity, id=null, category=null){
      resetEditor();
      document.getElementById("editorModal").classList.add("active");
      document.getElementById("edit_entity").value = entity;
      document.getElementById("edit_id").value = id || "";
      document.getElementById("edit_category").value = category || "";
      setFieldsVisible(entity);

      if(entity === "listing"){
        document.getElementById("editorTitle").textContent = id ? "Edit Listing" : "New Listing";
        document.getElementById("listing_status").value = "active";
        if(id){
          const it = CACHE.listings.get(String(id));
          if(it){
            document.getElementById("listing_category").value = it.category || category || "real-estate";
            document.getElementById("listing_title").value = it.title || "";
            document.getElementById("listing_price").value = it.price || "";
            document.getElementById("listing_status").value = it.status || "draft";
            document.getElementById("listing_desc").value = it.description || "";
            document.getElementById("listing_tags").value = Array.isArray(it.tags) ? it.tags.join(", ") : "";
            const arr = Array.isArray(it.image_urls) ? it.image_urls : (it.image_url ? [it.image_url] : []);
            for(let i=1;i<=3;i++){
              const u = arr[i-1] || "";
              setSlotUrl("listing", i, u);
              setSlotPreview("listing", i, u);
            }
          }
        } else {
          document.getElementById("listing_category").value = category || "real-estate";
        }
      }

      if(entity === "rate"){
        document.getElementById("editorTitle").textContent = id ? "Edit Pair" : "New Pair";
        document.getElementById("rate_status").value = "active";

        if(id){
          const it = CACHE.rates.get(String(id));
          if(it){
            document.getElementById("rate_base").value = String(it.base || it.asset || "").toUpperCase();
            document.getElementById("rate_quote").value = String(it.quote || "NGN").toUpperCase();
            document.getElementById("rate_buy").value = it.buy ?? "";
            document.getElementById("rate_sell").value = it.sell ?? "";
            document.getElementById("rate_status").value = it.status || "active";
            setRatePairPreview();
          }
        } else {
          document.getElementById("rate_base").value = "";
          document.getElementById("rate_quote").value = "NGN";
          setRatePairPreview();
        }
      }

      if(entity === "insight"){
        document.getElementById("editorTitle").textContent = id ? "Edit Insight" : "New Insight";
        document.getElementById("insight_status").value = "active";
        if(id){
          const it = CACHE.insights.get(String(id));
          if(it){
            document.getElementById("insight_title").value = it.title || "";
            document.getElementById("insight_category").value = it.category || "all";
            document.getElementById("insight_status").value = it.status || "active";
            document.getElementById("insight_summary").value = it.summary || "";
            const arr = Array.isArray(it.image_urls) ? it.image_urls : (it.image_url ? [it.image_url] : []);
            for(let i=1;i<=3;i++){
              const u = arr[i-1] || "";
              setSlotUrl("insight", i, u);
              setSlotPreview("insight", i, u);
            }
          }
        }
      }

      if(entity === "request"){
        document.getElementById("editorTitle").textContent = "Request Details";
        const it = CACHE.requests.get(String(id));
        if(it){
          document.getElementById("req_category").value = it.category || "";
          document.getElementById("req_created").value = it.created_at ? safeDate(it.created_at) : "";
          document.getElementById("req_status").value = it.status || "";
          document.getElementById("req_payload").value = JSON.stringify(it.payload || {}, null, 2);
        }
      }
    }

    function closeEditor(){ document.getElementById("editorModal").classList.remove("active"); }

    // Save
    async function saveEditor(e){
      e.preventDefault();
      if(document.body.classList.contains("saving")) return;

      const entity = document.getElementById("edit_entity").value;
      const id = document.getElementById("edit_id").value || null;

      const btn = document.getElementById("saveBtn");
      const original = btn.textContent;

      document.body.classList.add("saving");
      btn.disabled = true;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';

      try{
        if(entity === "listing"){
          const payload = {
            category: document.getElementById("listing_category").value.trim(),
            title: document.getElementById("listing_title").value.trim(),
            price: document.getElementById("listing_price").value.trim(),
            status: document.getElementById("listing_status").value,
            description: document.getElementById("listing_desc").value.trim(),
            tags: document.getElementById("listing_tags").value.split(",").map(s=>s.trim()).filter(Boolean),
          };
          if(!payload.category) throw new Error("Category is required.");
          if(!payload.title) throw new Error("Title is required.");

          const imgs = await collectImages("listing", "listings");
          const urls = imgs.urls.slice(0,3);
          const paths = imgs.paths.slice(0,3);
          payload.image_url = urls[0] || "";
          payload.image_path = paths[0] || null;
          payload.image_urls = urls;
          payload.image_paths = paths;

          const res = id
            ? await sb.from("listings").update(payload).eq("id", id).select().single()
            : await sb.from("listings").insert([payload]).select().single();
          if(res.error) throw res.error;

          toast("Saved listing ✅","success");
          closeEditor();
          await fetchListings("all");
          await loadStats();
          return;
        }

        if(entity === "rate"){
          const base = (document.getElementById("rate_base").value || "").trim().toUpperCase();
          const quote = (document.getElementById("rate_quote").value || "").trim().toUpperCase();
          const pair = (base && quote) ? `${base}/${quote}` : "";

          if(!base || !quote) throw new Error("Base and Quote are required.");
          if(!pair) throw new Error("Pair is required.");

          const payload = {
            base, quote, pair,
            buy: Number(document.getElementById("rate_buy").value || 0),
            sell: Number(document.getElementById("rate_sell").value || 0),
            status: document.getElementById("rate_status").value
          };

          // ✅ UPSERT by pair
          const res = await sb.from("rates")
            .upsert([payload], { onConflict: "pair" })
            .select()
            .single();
          if(res.error) throw res.error;

          toast("Saved pair ✅","success");
          closeEditor();
          await fetchRates();
          return;
        }

        if(entity === "insight"){
          const payload = {
            title: document.getElementById("insight_title").value.trim(),
            category: document.getElementById("insight_category").value,
            status: document.getElementById("insight_status").value,
            summary: document.getElementById("insight_summary").value.trim()
          };
          if(!payload.title) throw new Error("Title is required.");

          const imgs = await collectImages("insight", "insights");
          const urls = imgs.urls.slice(0,3);
          const paths = imgs.paths.slice(0,3);
          payload.image_url = urls[0] || "";
          payload.image_path = paths[0] || null;
          payload.image_urls = urls;
          payload.image_paths = paths;

          const res = id
            ? await sb.from("insights").update(payload).eq("id", id).select().single()
            : await sb.from("insights").insert([payload]).select().single();
          if(res.error) throw res.error;

          toast("Saved insight ✅","success");
          closeEditor();
          await fetchInsights();
          return;
        }
      }catch(err){
        console.warn("SAVE ERROR:", err);
        toast(err?.message || "Save failed","error");
      }finally{
        document.body.classList.remove("saving");
        btn.disabled = false;
        btn.textContent = original;
      }
    }

    async function deleteEntity(entity, id, category=null){
      if(!confirm("Delete this item?")) return;
      try{
        if(entity === "listing"){
          const { error } = await sb.from("listings").delete().eq("id", id);
          if(error) throw error;
          toast("Deleted listing ✅","success");
          await fetchListings("all");
          if(category) await fetchListings(category);
          await loadStats();
          return;
        }
        if(entity === "rate"){
          const { error } = await sb.from("rates").delete().eq("id", id);
          if(error) throw error;
          toast("Deleted pair ✅","success");
          await fetchRates();
          return;
        }
        if(entity === "insight"){
          const { error } = await sb.from("insights").delete().eq("id", id);
          if(error) throw error;
          toast("Deleted insight ✅","success");
          await fetchInsights();
          return;
        }
      }catch(e){
        toast(e.message || "Delete failed","error");
      }
    }

    // Wire up
    document.addEventListener("DOMContentLoaded", async () => {
      sb = (window.ensureSupabaseClient ? window.ensureSupabaseClient() : window.supabaseClient);
      if(!sb){ showLogin("Supabase not ready."); return; }

      ["listing","insight"].forEach(kind => { for(let i=1;i<=3;i++) bindFilePreview(kind,i); });

      // Rate auto pair preview
      document.getElementById("rate_base").addEventListener("input", setRatePairPreview);
      document.getElementById("rate_quote").addEventListener("input", setRatePairPreview);
      document.getElementById("rate_preset").addEventListener("change", () => {
        const v = document.getElementById("rate_preset").value;
        if(!v) return;
        const [b,q] = v.split("/");
        document.getElementById("rate_base").value = (b||"").toUpperCase();
        document.getElementById("rate_quote").value = (q||"").toUpperCase();
        setRatePairPreview();
      });

      document.getElementById("adminLoginForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        await adminLogin(
          document.getElementById("admin_email").value.trim(),
          document.getElementById("admin_pass").value
        );
      });

      document.getElementById("editorForm").addEventListener("submit", saveEditor);

      document.getElementById("editorModal").addEventListener("click", (e) => {
        if(e.target.id === "editorModal") closeEditor();
      });

      document.addEventListener("keydown", (e) => {
        if(e.key === "Escape") closeEditor();
      });

      await initAdmin();
    });
  </script>
</body>
</html>
