<!-- admin.html (UPDATED — pro + smart + 100% mobile responsive + new nav overlay + exchange rates manager) -->
<!-- NOTE: This is the SAME admin you already got with exchange manager; now with upgraded nav overlay -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Command Center | Larmah Enterprise</title>

  <meta name="description" content="Larmah internal management: catalog items, exchange rates, insights posts." />
  <meta name="theme-color" content="#070A12" />

  <link rel="icon" href="assets/images/larmah-favicon.jpeg" type="image/jpeg" />
  <link rel="preload" href="assets/images/larmah-header.jpeg" as="image" />

  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="assets/js/app.js"></script>

  <style>
    .statbar{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:12px}
    .table-wrap{overflow:auto}
    .status-active{color:var(--ok);font-weight:950}
    .status-hidden{color:var(--bad);font-weight:950}

    .rates-toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .rates-toolbar .left{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .rates-toolbar .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .rate-input{
      width: 100%;
      min-width: 120px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      color: var(--text);
      padding: 10px 10px;
      outline: none;
    }
    .rate-input:focus{
      border-color: rgba(212,175,55,.35);
      box-shadow: 0 0 0 4px rgba(212,175,55,.10);
      background: rgba(255,255,255,.03);
    }
    .rate-code{font-weight:950;letter-spacing:.08em;text-transform:uppercase}
    .rate-mini{font-size:.85rem;color:var(--muted);font-weight:900}
    .muted-chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-weight: 900;
      font-size:.85rem;
    }
    .pill-ok{border-color: rgba(0,217,129,.20);background: rgba(0,217,129,.10);color: rgba(245,245,245,.92);}
  </style>
</head>

<body data-page="admin">
  <header>
    <div class="container header-inner">
      <a class="brand" href="index.html" aria-label="Larmah Home">
        <img src="assets/images/larmah-header.jpeg" alt="Larmah Enterprise" />
      </a>

      <button class="menu-btn" onclick="LARMAH.toggleMenu()" aria-label="Open menu">
        <i class="fa-solid fa-bars"></i>
      </button>

      <!-- BEAUTIFUL MOBILE OVERLAY NAV -->
      <nav id="nav" aria-label="Primary navigation">
        <div class="nav-panel">
          <div class="nav-panel-head">
            <div class="nav-brand">
              <img src="assets/images/larmah-header.jpeg" alt="Larmah Enterprise" />
            </div>
            <button class="nav-close" onclick="LARMAH.closeMenu()" aria-label="Close menu">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>

          <div class="nav-panel-body">
            <ul>
              <li><a class="nav-link" href="real-estate.html" data-link="real-estate">Real Estate <i class="fa-solid fa-chevron-right" style="opacity:.55"></i></a></li>
              <li><a class="nav-link" href="logistics.html" data-link="logistics">Logistics <i class="fa-solid fa-chevron-right" style="opacity:.55"></i></a></li>
              <li><a class="nav-link" href="insights.html" data-link="insights">Insights <i class="fa-solid fa-chevron-right" style="opacity:.55"></i></a></li>
              <li><a class="nav-link" href="exchange.html" data-link="exchange">Exchange <i class="fa-solid fa-chevron-right" style="opacity:.55"></i></a></li>
            </ul>

            <div class="nav-panel-footer">
              <div class="nav-hint">Tip: Tap a section to open. Press ESC to close.</div>
              <a class="btn solid" href="premium.html"><i class="fa-solid fa-star"></i> Premium</a>
              <button class="btn" onclick="LARMAH.openWhatsApp(LARMAH.buildMessage('Admin Help', { Name:'', Phone:'', Message:'Hello Larmah, I need admin help.' }))">
                <i class="fa-brands fa-whatsapp"></i> WhatsApp Support
              </button>
            </div>
          </div>
        </div>
      </nav>

      <div class="header-actions">
        <button class="pill" onclick="LARMAH.signOut()"><i class="fa-solid fa-power-off"></i> Logout</button>
      </div>
    </div>
  </header>

  <!-- Keep the rest of your Admin (catalog + exchange rates + insights + modal) exactly as provided earlier -->
  <main class="container">
    <section class="hero">
      <div class="hero-shell">
        <div class="hero-inner" style="grid-template-columns:1fr">
          <div>
            <div class="hero-kicker">
              <span class="kicker-pill"><i class="fa-solid fa-terminal"></i> Internal Terminal</span>
              <span class="kicker-dot">•</span>
              <span class="kicker-sub">Catalog • Exchange Rates • Insights</span>
            </div>

            <h1>Command Center</h1>

            <div id="adminStatus" class="notice" style="margin-top:12px;display:none;border-color:rgba(0,217,129,.30)"></div>
            <div id="adminGate" class="notice" style="margin-top:12px;display:none;border-color:rgba(255,90,103,.35);background:rgba(255,90,103,.08)"></div>
            <div id="adminError" class="notice" style="margin-top:12px;display:none;border-color:rgba(255,90,103,.35);background:rgba(255,90,103,.08)"></div>
          </div>
        </div>
      </div>
    </section>

    <div class="statbar">
      <div class="card">
        <div class="small">Session</div>
        <div id="user_email" style="font-weight:950;color:var(--brand)">Admin User</div>
        <div class="small" style="opacity:.8">Role-gated access</div>
      </div>
      <div class="card">
        <div class="small">Connection</div>
        <div style="font-weight:950">Live</div>
        <div class="small" style="opacity:.8">Supabase enabled</div>
      </div>
    </div>

    <!-- CATALOG MANAGER -->
    <section class="section" id="catalogAdmin">
      <div class="section-head-split">
        <div>
          <h2>Catalogue Manager</h2>
          <p class="lead">Manage inventory for Real Estate, Logistics, and Exchange.</p>
        </div>
        <button class="btn solid" onclick="openEditor()"><i class="fa-solid fa-plus"></i> New Item</button>
      </div>

      <div class="card">
        <div class="row2">
          <div>
            <label class="small">Category</label>
            <select id="catCategory" class="input" onchange="loadCatalog()">
              <option value="real-estate">Real Estate</option>
              <option value="logistics">Logistics</option>
              <option value="exchange">Exchange</option>
            </select>
          </div>
          <div>
            <label class="small">Search</label>
            <input id="catSearch" class="input" placeholder="Filter by title / description..." oninput="loadCatalog()" />
          </div>
        </div>

        <div class="table-wrap" style="margin-top:12px">
          <div id="catTable"></div>
        </div>
      </div>
    </section>

    <!-- EXCHANGE RATES MANAGER -->
    <section class="section" id="exchangeRatesAdmin" style="margin-top:24px">
      <div class="section-head-split">
        <div>
          <h2>Exchange Rates Manager</h2>
          <p class="lead">Live rates for Exchange page (public read). Admin updates apply immediately.</p>
        </div>
        <span class="muted-chip pill-ok"><i class="fa-solid fa-bolt"></i> Realtime-ready</span>
      </div>

      <div class="card">
        <div class="rates-toolbar">
          <div class="left">
            <button class="btn solid" onclick="loadExchangeRates()"><i class="fa-solid fa-rotate"></i> Refresh</button>
            <button class="btn primary" onclick="saveAllRates()"><i class="fa-solid fa-floppy-disk"></i> Save All</button>
          </div>
          <div class="right">
            <span class="small" id="ratesUpdatedAt" style="opacity:.75">Updated: —</span>
          </div>
        </div>

        <div style="height:1px;background:rgba(255,255,255,.08);margin:12px 0"></div>

        <div class="row2">
          <div>
            <label class="small">Add / Update Currency Code</label>
            <input id="new_code" class="input" placeholder="e.g., USD" />
          </div>
          <div>
            <label class="small">Name</label>
            <input id="new_name" class="input" placeholder="US Dollar (USD)" />
          </div>
        </div>

        <div class="row2" style="margin-top:12px">
          <div><label class="small">Buy NGN</label><input id="new_buy" class="input" placeholder="1450" /></div>
          <div><label class="small">Sell NGN</label><input id="new_sell" class="input" placeholder="1480" /></div>
        </div>

        <div class="row2" style="margin-top:12px">
          <div><label class="small">Fee Rate (0.005 = 0.5%)</label><input id="new_fee" class="input" placeholder="0.005" /></div>
          <div>
            <label class="small">Min / Max</label>
            <div class="row2" style="gap:10px">
              <input id="new_min" class="input" placeholder="100" />
              <input id="new_max" class="input" placeholder="50000" />
            </div>
          </div>
        </div>

        <div class="actions" style="margin-top:12px">
          <button class="btn solid" onclick="upsertNewRate()"><i class="fa-solid fa-plus"></i> Add / Update</button>
        </div>

        <div style="height:1px;background:rgba(255,255,255,.08);margin:12px 0"></div>

        <div class="table-wrap">
          <div id="ratesTableMount"></div>
        </div>
      </div>
    </section>

    <!-- INSIGHTS PUBLISHER -->
    <section class="section" id="insightsAdmin" style="margin-top:24px">
      <h2>Insights Publisher</h2>
      <p class="lead">Create and edit community updates.</p>

      <div class="card">
        <input id="ip_id" class="input" style="display:none" disabled />
        <div class="notice" id="ip_mode" style="display:none;margin-bottom:12px;border-color:rgba(0,217,129,.30)">
          <i class="fa-solid fa-pen-to-square"></i> <strong>Editing Post Mode</strong>
        </div>

        <label class="small">Post Title</label>
        <input id="ip_title" class="input" placeholder="Post headline" />

        <div style="margin-top:12px">
          <label class="small">Body</label>
          <textarea id="ip_body" class="input" placeholder="What's the update for the community?"></textarea>
        </div>

        <div class="actions" style="margin-top:12px">
          <button class="btn solid" id="ip_publish_btn" onclick="publishInsight()"><i class="fa-solid fa-paper-plane"></i> Publish Now</button>
          <button class="btn solid" id="ip_update_btn" onclick="updateInsight()" style="display:none"><i class="fa-solid fa-floppy-disk"></i> Save Changes</button>
          <button class="btn" id="ip_cancel_btn" onclick="cancelInsightEdit()" style="display:none">Cancel</button>
        </div>
      </div>

      <div id="insightsAdminList" style="margin-top:12px"></div>
    </section>

    <!-- MODAL OVERLAY -->
    <div id="editorOverlay" class="modal-overlay" onclick="closeEditor()">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-head">
          <div>
            <h3 id="modalTitle" style="margin:0">Item Editor</h3>
            <div class="small">Upload images to Supabase Storage bucket: <b>catalog</b></div>
          </div>
          <button class="btn small" onclick="closeEditor()"><i class="fa-solid fa-xmark"></i></button>
        </div>

        <div class="modal-body">
          <div class="row2">
            <div>
              <label class="small">Item ID</label>
              <input id="e_id" class="input" disabled value="new" />
            </div>
            <div>
              <label class="small">Visibility</label>
              <select id="e_active" class="input">
                <option value="true">Active (Visible)</option>
                <option value="false">Disabled (Hidden)</option>
              </select>
            </div>
          </div>

          <div class="row2" style="margin-top:12px">
            <div><label class="small">Title</label><input id="e_title" class="input" placeholder="Luxury 2 Bed Flat / Exchange Offer" /></div>
            <div><label class="small">Price</label><input id="e_price" class="input" placeholder="₦150,000 / Day" /></div>
          </div>

          <div style="margin-top:12px">
            <label class="small">Description</label>
            <textarea id="e_desc" class="input" placeholder="Key features, location, offer details..."></textarea>
          </div>

          <div class="row2" style="margin-top:12px">
            <div><label class="small">Image URL (External)</label><input id="e_image_url" class="input" placeholder="https://..." /></div>
            <div><label class="small">Upload Image</label><input id="e_image_file" class="input" type="file" accept="image/*" /></div>
          </div>

          <div style="margin-top:12px">
            <label class="small">Tags (comma separated)</label>
            <input id="e_tags" class="input" placeholder="Lekki, VIP, Security, Rate" />
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn danger" id="btnDelete" onclick="deleteItem()"><i class="fa-solid fa-trash"></i> Delete</button>
          <button class="btn solid" onclick="saveItem()"><i class="fa-solid fa-check"></i> Save Record</button>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <div class="footer-grid">
        <div>
          <div class="brandline">
            <img src="assets/images/larmah-header.jpeg" alt="Larmah Enterprise" />
            <div>
              <div style="font-weight:950">Larmah Enterprise</div>
              <div class="small">Administration</div>
            </div>
          </div>
          <div class="small" style="margin-top:8px">Authorized staff access only.</div>
        </div>

        <div>
          <b>Operations</b>
          <div class="small" style="margin-top:10px"><a href="index.html">Main Site</a></div>
          <div class="small"><a href="insights.html">Public Insights</a></div>
          <div class="small"><a href="exchange.html">Exchange</a></div>
        </div>
      </div>

      <div class="small">© <span id="year"></span> Larmah Enterprise Administration.</div>
    </div>
  </footer>

  <div id="toast" class="toast"></div>

  <!-- Admin logic: same exchange manager logic you already received -->
  <script>
    let editing = null;
    let __ratesRows = [];

    function showAdminError(msg){
      const el = document.getElementById("adminError");
      if(!el) return;
      el.style.display = "block";
      el.innerHTML = "<strong>Operation Error:</strong> " + (msg || "Unknown failure");
    }
    function clearAdminError(){
      const el = document.getElementById("adminError");
      if(el){ el.style.display = "none"; el.textContent = ""; }
    }

    async function requireAdmin(){
      const sb = await LARMAH.initSupabase();
      const session = await LARMAH.getSession();

      if(!session){
        const g = document.getElementById("adminGate");
        g.style.display = "block";
        g.innerHTML = "<strong>Access Required.</strong> Redirecting to login...";
        setTimeout(()=> location.href="auth.html", 1200);
        return false;
      }

      document.getElementById("user_email").textContent = session.user.email;

      const r = await sb.from("profiles").select("role").eq("id", session.user.id).single();
      if(r.error || !r.data || r.data.role !== "admin"){
        const g = document.getElementById("adminGate");
        g.style.display = "block";
        g.innerHTML = "<strong>Unauthorized.</strong> This account does not have Admin permissions.";
        return false;
      }

      const st = document.getElementById("adminStatus");
      st.style.display = "block";
      st.innerHTML = "<strong>Verified Admin Session:</strong> " + session.user.email;
      return true;
    }

    async function loadCatalog(){
      clearAdminError();
      const sb = await LARMAH.initSupabase();
      const category = document.getElementById("catCategory").value;
      const q = (document.getElementById("catSearch").value || "").toLowerCase();

      const r = await sb.from("catalog_items").select("*").eq("category", category).order("updated_at", {ascending:false});
      if(r.error){ showAdminError(r.error.message); return; }

      const items = (r.data || []).filter(it => {
        const hay = (it.title + " " + (it.description || "") + " " + (it.tags || []).join(" ")).toLowerCase();
        return !q || hay.includes(q);
      });

      const mount = document.getElementById("catTable");
      if(!items.length){
        mount.innerHTML = `<div class="notice"><strong>No items found.</strong> Add a new item above.</div>`;
        return;
      }

      mount.innerHTML = `
        <table class="table">
          <thead><tr><th>Asset</th><th>Price</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody>
            ${items.map(it => {
              const statusText = it.active ? "Active" : "Hidden";
              const statusClass = it.active ? "status-active" : "status-hidden";
              return `
                <tr>
                  <td>
                    ${it.image_url ? `<span class="thumb-mini"><img src="${LARMAH.escapeHtml(it.image_url)}" alt=""></span>` : ""}
                    <div style="display:inline-block;vertical-align:middle">
                      <b>${LARMAH.escapeHtml(it.title)}</b>
                      <div class="small" style="max-width:520px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
                        ${LARMAH.escapeHtml(it.description || "")}
                      </div>
                    </div>
                  </td>
                  <td><b>${LARMAH.escapeHtml(it.price || "-")}</b></td>
                  <td><span class="${statusClass}">${statusText}</span></td>
                  <td><button class="btn small" onclick="editItem('${it.id}')">Edit</button></td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      `;
    }

    function openEditor(id){
      document.getElementById("editorOverlay").style.display = "flex";
      document.getElementById("btnDelete").style.display = id ? "inline-flex" : "none";
      document.getElementById("modalTitle").textContent = id ? "Modify Asset" : "Register New Asset";
      document.getElementById("e_id").value = id || "System Generated";

      document.getElementById("e_title").value = "";
      document.getElementById("e_price").value = "";
      document.getElementById("e_desc").value = "";
      document.getElementById("e_tags").value = "";
      document.getElementById("e_image_url").value = "";
      document.getElementById("e_active").value = "true";
      document.getElementById("e_image_file").value = "";
      editing = id ? { id } : null;
    }
    function closeEditor(){ document.getElementById("editorOverlay").style.display = "none"; }

    async function editItem(id){
      const sb = await LARMAH.initSupabase();
      const r = await sb.from("catalog_items").select("*").eq("id", id).single();
      if(r.error) return;

      editing = r.data;
      openEditor(id);
      document.getElementById("e_title").value = r.data.title || "";
      document.getElementById("e_price").value = r.data.price || "";
      document.getElementById("e_desc").value = r.data.description || "";
      document.getElementById("e_tags").value = (r.data.tags || []).join(", ");
      document.getElementById("e_image_url").value = r.data.image_url || "";
      document.getElementById("e_active").value = String(r.data.active);
    }

    async function saveItem(){
      clearAdminError();
      const sb = await LARMAH.initSupabase();
      const category = document.getElementById("catCategory").value;
      const title = document.getElementById("e_title").value.trim();
      if(!title){ LARMAH.toast("Title is required"); return; }

      const payload = {
        category,
        title,
        price: document.getElementById("e_price").value.trim(),
        description: document.getElementById("e_desc").value.trim(),
        tags: document.getElementById("e_tags").value.split(",").map(s=>s.trim()).filter(Boolean),
        active: (document.getElementById("e_active").value === "true"),
        image_url: document.getElementById("e_image_url").value.trim(),
        updated_at: new Date().toISOString()
      };

      try{
        const file = document.getElementById("e_image_file").files[0];
        if(file){
          LARMAH.toast("Uploading asset...");
          const path = "catalog/" + Date.now() + "_" + file.name;
          const up = await sb.storage.from("catalog").upload(path, file, { upsert: false });
          if(up.error) throw up.error;
          const pub = sb.storage.from("catalog").getPublicUrl(path);
          payload.image_url = pub.data.publicUrl;
        }

        let res;
        if(editing && editing.id){
          res = await sb.from("catalog_items").update(payload).eq("id", editing.id);
        }else{
          res = await sb.from("catalog_items").insert([payload]);
        }
        if(res.error) throw res.error;

        LARMAH.toast("Saved");
        closeEditor();
        loadCatalog();
      }catch(err){
        showAdminError(err.message);
      }
    }

    async function deleteItem(){
      if(!confirm("Delete this asset forever?")) return;
      const sb = await LARMAH.initSupabase();
      const d = await sb.from("catalog_items").delete().eq("id", editing.id);
      if(d.error){ showAdminError(d.error.message); return; }
      LARMAH.toast("Deleted");
      closeEditor();
      loadCatalog();
    }

    function parseNum(v){
      const n = Number(String(v || "").replace(/,/g,"").trim());
      return Number.isFinite(n) ? n : null;
    }
    function normalizeCode(v){
      return String(v || "").trim().toUpperCase().replace(/[^A-Z0-9]/g, "");
    }

    function renderRatesTable(rows){
      const mount = document.getElementById("ratesTableMount");
      if(!rows || !rows.length){
        mount.innerHTML = `<div class="notice"><strong>No rates found.</strong> Add a new currency above.</div>`;
        return;
      }

      mount.innerHTML = `
        <table class="table">
          <thead>
            <tr>
              <th>Code</th><th>Name</th><th>Buy NGN</th><th>Sell NGN</th><th>Fee</th><th>Min</th><th>Max</th><th>Updated</th><th>Action</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r => `
              <tr data-code="${LARMAH.escapeHtml(r.code)}">
                <td class="rate-code">${LARMAH.escapeHtml(r.code)}</td>
                <td><input class="rate-input" data-field="name" value="${LARMAH.escapeHtml(r.name || "")}"></td>
                <td><input class="rate-input" data-field="buy_ngn" value="${LARMAH.escapeHtml(String(r.buy_ngn ?? ""))}"></td>
                <td><input class="rate-input" data-field="sell_ngn" value="${LARMAH.escapeHtml(String(r.sell_ngn ?? ""))}"></td>
                <td><input class="rate-input" data-field="fee_rate" value="${LARMAH.escapeHtml(String(r.fee_rate ?? ""))}"></td>
                <td><input class="rate-input" data-field="min_amount" value="${LARMAH.escapeHtml(String(r.min_amount ?? ""))}"></td>
                <td><input class="rate-input" data-field="max_amount" value="${LARMAH.escapeHtml(String(r.max_amount ?? ""))}"></td>
                <td class="rate-mini">${r.updated_at ? new Date(r.updated_at).toLocaleString() : "-"}</td>
                <td><button class="btn small primary" onclick="saveRateRow('${LARMAH.escapeHtml(r.code)}')"><i class="fa-solid fa-floppy-disk"></i> Save</button></td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    async function loadExchangeRates(){
      clearAdminError();
      const sb = await LARMAH.initSupabase();
      const r = await sb.from("exchange_rates")
        .select("code,name,buy_ngn,sell_ngn,fee_rate,min_amount,max_amount,updated_at")
        .order("code", { ascending: true });

      if(r.error){ showAdminError(r.error.message); return; }

      __ratesRows = r.data || [];
      renderRatesTable(__ratesRows);

      const latest = (__ratesRows || [])
        .map(x => x.updated_at ? new Date(x.updated_at).getTime() : 0)
        .reduce((a,b)=> Math.max(a,b), 0);
      document.getElementById("ratesUpdatedAt").textContent = latest ? ("Updated: " + new Date(latest).toLocaleString()) : "Updated: —";
    }

    function readRowFromDOM(code){
      const tr = document.querySelector(`tr[data-code="${CSS.escape(code)}"]`);
      if(!tr) return null;
      const get = (field) => tr.querySelector(`[data-field="${field}"]`)?.value ?? "";

      const payload = {
        code: normalizeCode(code),
        name: String(get("name")).trim() || `${code}`,
        buy_ngn: parseNum(get("buy_ngn")),
        sell_ngn: parseNum(get("sell_ngn")),
        fee_rate: parseNum(get("fee_rate")),
        min_amount: parseNum(get("min_amount")),
        max_amount: parseNum(get("max_amount")),
        updated_at: new Date().toISOString()
      };

      const required = ["buy_ngn","sell_ngn","fee_rate","min_amount","max_amount"];
      for(const k of required){ if(payload[k] === null) return { error:`Invalid number in ${k} for ${code}` }; }
      if(!payload.code) return { error:"Invalid code" };
      return payload;
    }

    async function saveRateRow(code){
      clearAdminError();
      const sb = await LARMAH.initSupabase();
      const payloadOrErr = readRowFromDOM(code);
      if(payloadOrErr?.error){ showAdminError(payloadOrErr.error); return; }
      const u = await sb.from("exchange_rates").upsert([payloadOrErr], { onConflict: "code" });
      if(u.error){ showAdminError(u.error.message); return; }
      LARMAH.toast("Rate saved: " + code);
      loadExchangeRates();
    }

    async function saveAllRates(){
      clearAdminError();
      const sb = await LARMAH.initSupabase();

      const rows = [];
      for(const r of (__ratesRows || [])){
        const payloadOrErr = readRowFromDOM(r.code);
        if(payloadOrErr?.error){ showAdminError(payloadOrErr.error); return; }
        rows.push(payloadOrErr);
      }
      if(!rows.length){ LARMAH.toast("No rows to save"); return; }

      const u = await sb.from("exchange_rates").upsert(rows, { onConflict: "code" });
      if(u.error){ showAdminError(u.error.message); return; }

      LARMAH.toast("All rates saved");
      loadExchangeRates();
    }

    async function upsertNewRate(){
      clearAdminError();
      const sb = await LARMAH.initSupabase();

      const code = normalizeCode(document.getElementById("new_code").value);
      const name = String(document.getElementById("new_name").value || "").trim() || code;
      const buy = parseNum(document.getElementById("new_buy").value);
      const sell = parseNum(document.getElementById("new_sell").value);
      const fee = parseNum(document.getElementById("new_fee").value);
      const min = parseNum(document.getElementById("new_min").value);
      const max = parseNum(document.getElementById("new_max").value);

      if(!code){ showAdminError("Currency code required (e.g., USD)"); return; }
      if([buy,sell,fee,min,max].some(v => v === null)){ showAdminError("Enter valid numbers for Buy/Sell/Fee/Min/Max"); return; }

      const payload = { code, name, buy_ngn: buy, sell_ngn: sell, fee_rate: fee, min_amount: min, max_amount: max, updated_at: new Date().toISOString() };
      const u = await sb.from("exchange_rates").upsert([payload], { onConflict: "code" });
      if(u.error){ showAdminError(u.error.message); return; }

      ["new_code","new_name","new_buy","new_sell","new_fee","new_min","new_max"].forEach(id => document.getElementById(id).value = "");
      LARMAH.toast("Rate added/updated: " + code);
      loadExchangeRates();
    }

    async function subscribeRatesRealtime(){
      const sb = await LARMAH.initSupabase();
      if(!sb) return;
      if(window.__ratesChan) return;
      window.__ratesChan = sb
        .channel("exchange_rates_admin")
        .on("postgres_changes", { event: "*", schema: "public", table: "exchange_rates" }, () => loadExchangeRates())
        .subscribe();
    }

    async function publishInsight(){
      const sb = await LARMAH.initSupabase();
      const title = document.getElementById("ip_title").value.trim();
      const body = document.getElementById("ip_body").value.trim();
      if(!title || !body){ LARMAH.toast("Both fields are required"); return; }

      const ins = await sb.from("insights_posts").insert([{ title, body, created_at: new Date().toISOString() }]);
      if(ins.error){ showAdminError(ins.error.message); return; }

      document.getElementById("ip_title").value = "";
      document.getElementById("ip_body").value = "";
      LARMAH.toast("Published");
      loadInsightsAdmin();
    }

    async function loadInsightsAdmin(){
      const sb = await LARMAH.initSupabase();
      const r = await sb.from("insights_posts").select("*").order("created_at", {ascending:false});
      const mount = document.getElementById("insightsAdminList");

      if(!r.data || !r.data.length){ mount.innerHTML = "<div class='notice'><strong>No community insights.</strong></div>"; return; }

      mount.innerHTML =
        "<div class='grid'>" +
        r.data.map(p => `
          <div class="card">
            <h3 style="font-size:1rem">${LARMAH.escapeHtml(p.title)}</h3>
            <p class="small" style="opacity:.9;margin-top:8px">${LARMAH.escapeHtml(p.body)}</p>
            <div class="meta">Created: ${new Date(p.created_at).toLocaleString()}</div>
            <div class="actions">
              <button class="btn small" onclick="startInsightEditFromId('${p.id}')">Edit</button>
              <button class="btn small danger" onclick="deleteInsight('${p.id}')"><i class="fa-solid fa-trash"></i> Delete</button>
            </div>
          </div>
        `).join("") +
        "</div>";
    }

    async function startInsightEditFromId(id){
      const sb = await LARMAH.initSupabase();
      const r = await sb.from("insights_posts").select("*").eq("id", id).single();
      if(r.error) return;

      document.getElementById("ip_id").value = r.data.id;
      document.getElementById("ip_mode").style.display = "block";
      document.getElementById("ip_title").value = r.data.title;
      document.getElementById("ip_body").value = r.data.body;

      document.getElementById("ip_publish_btn").style.display = "none";
      document.getElementById("ip_update_btn").style.display = "inline-flex";
      document.getElementById("ip_cancel_btn").style.display = "inline-flex";

      window.scrollTo({ top: document.getElementById("insightsAdmin").offsetTop - 90, behavior: "smooth" });
    }

    function cancelInsightEdit(){
      document.getElementById("ip_mode").style.display = "none";
      document.getElementById("ip_id").value = "";
      document.getElementById("ip_title").value = "";
      document.getElementById("ip_body").value = "";
      document.getElementById("ip_publish_btn").style.display = "inline-flex";
      document.getElementById("ip_update_btn").style.display = "none";
      document.getElementById("ip_cancel_btn").style.display = "none";
    }

    async function updateInsight(){
      const sb = await LARMAH.initSupabase();
      const id = document.getElementById("ip_id").value;
      const title = document.getElementById("ip_title").value.trim();
      const body = document.getElementById("ip_body").value.trim();
      const u = await sb.from("insights_posts").update({ title, body }).eq("id", id);
      if(u.error){ showAdminError(u.error.message); return; }
      LARMAH.toast("Updated");
      cancelInsightEdit();
      loadInsightsAdmin();
    }

    async function deleteInsight(id){
      if(!confirm("Delete this insight forever?")) return;
      const sb = await LARMAH.initSupabase();
      const d = await sb.from("insights_posts").delete().eq("id", id);
      if(d.error){ showAdminError(d.error.message); return; }
      LARMAH.toast("Deleted");
      loadInsightsAdmin();
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const ok = await requireAdmin();
      if(!ok) return;
      loadCatalog();
      loadExchangeRates();
      subscribeRatesRealtime();
      loadInsightsAdmin();
    });
  </script>
</body>
</html>
