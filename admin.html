<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Command | Larmah Enterprise</title>

  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="assets/js/app.js"></script>

  <style>
    /* --- AUTH GATE STYLES --- */
    #login-gate {
      position: fixed; inset: 0; z-index: 10000;
      background: #050810;
      display: flex; align-items: center; justify-content: center;
    }
    .login-box {
      width: 420px; max-width: 92vw;
      background: var(--panel); border: 1px solid var(--border);
      padding: 40px; border-radius: 20px;
      text-align: center;
      box-shadow: 0 50px 100px rgba(0,0,0,0.5);
    }

    /* --- ADMIN LAYOUT --- */
    #admin-interface { display: none; height: 100vh; }
    body { padding-bottom: 0; overflow: hidden; }

    .admin-layout {
      display: grid; grid-template-columns: 260px 1fr;
      height: 100%;
    }

    /* Sidebar */
    .admin-sidebar {
      background: #050810;
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column;
      padding: 20px;
      z-index: 10;
    }
    .admin-nav { list-style: none; margin: 26px 0 0; padding: 0; display: grid; gap: 8px; }
    .nav-item {
      padding: 12px 14px; border-radius: 12px;
      color: var(--muted); cursor: pointer;
      display: flex; align-items: center; gap: 12px;
      font-weight: 800; font-size: 0.92rem;
      transition: all 0.2s ease;
      border: 1px solid transparent;
      user-select: none;
    }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: var(--text); }
    .nav-item.active {
      background: rgba(0, 217, 129, 0.10);
      color: var(--brand);
      border: 1px solid rgba(0, 217, 129, 0.25);
    }

    /* Main */
    .admin-main {
      position: relative;
      overflow-y: auto;
      padding: 30px;
      background: var(--bg);
    }
    .admin-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 22px; padding-bottom: 14px;
      border-bottom: 1px solid var(--border);
      gap: 12px;
    }

    /* Tables */
    .data-table-wrapper {
      background: var(--panel); border: 1px solid var(--border);
      border-radius: 16px; overflow: hidden;
    }
    table { width: 100%; border-collapse: collapse; }
    th {
      text-align: left; padding: 14px 16px;
      background: rgba(255,255,255,0.03);
      color: var(--muted); font-size: 0.82rem;
      text-transform: uppercase; letter-spacing: 1px;
    }
    td {
      padding: 14px 16px;
      border-top: 1px solid rgba(255,255,255,0.05);
      font-size: 0.93rem;
      vertical-align: middle;
    }
    tr:hover td { background: rgba(255,255,255,0.02); }

    .tbl-thumb { width: 46px; height: 46px; border-radius: 10px; object-fit: cover; background: #000; }

    .badge { padding: 4px 10px; border-radius: 999px; font-size: 0.75rem; font-weight: 900; display: inline-block; }
    .badge.active { background: rgba(67, 209, 125, 0.2); color: var(--ok); }
    .badge.draft { background: rgba(255, 176, 32, 0.18); color: var(--warn); }
    .badge.sold { background: rgba(255, 90, 103, 0.18); color: var(--bad); }
    .badge.closed { background: rgba(255, 90, 103, 0.18); color: var(--bad); }

    .action-btn {
      width: 34px; height: 34px; border-radius: 10px;
      display: inline-flex; align-items: center; justify-content: center;
      cursor: pointer; border: 1px solid var(--border);
      background: rgba(255,255,255,0.05); color: var(--text);
      transition: 0.2s;
    }
    .action-btn:hover { background: #fff; color: #000; }
    .action-btn.danger:hover { background: var(--bad); color: #fff; border-color: var(--bad); }

    /* Modal */
    .modal {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.85);
      backdrop-filter: blur(5px);
      z-index: 9999;
      display: none; align-items: center; justify-content: center;
      padding: 20px;
    }
    .modal.active { display: flex; }
    .editor-box {
      width: 680px; max-width: 95vw;
      background: #0f1218;
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 26px;
      box-shadow: 0 50px 100px rgba(0,0,0,0.6);
      max-height: 90vh;
      overflow-y: auto;
    }
    .form-group { margin-bottom: 14px; }
    .form-label {
      display: block;
      color: var(--muted);
      font-size: 0.85rem;
      margin-bottom: 6px;
      font-weight: 900;
    }

    .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media(max-width: 720px){ .row2 { grid-template-columns: 1fr; } }

    .notice-admin {
      padding: 12px 14px; border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.03);
      color: var(--muted);
    }

    @media(max-width: 900px) {
      .admin-layout { grid-template-columns: 1fr; }
      .admin-sidebar { display: none; }
    }
  </style>
</head>

<body data-page="admin">
  <!-- LOGIN GATE -->
  <div id="login-gate">
    <div class="login-box">
      <img src="assets/images/larmah-header.jpeg" style="width:60px; border-radius:12px; margin:0 auto 18px; display:block">
      <h2 style="margin-bottom:10px">Admin Access</h2>
      <p class="small" style="margin-bottom:22px">Authorized personnel only.</p>

      <form id="adminLoginForm">
        <div style="margin-bottom:14px; text-align:left">
          <label class="form-label">Email</label>
          <input type="email" id="admin_email" class="input" placeholder="admin@heylarmah.tech" required>
        </div>
        <div style="margin-bottom:20px; text-align:left">
          <label class="form-label">Password</label>
          <input type="password" id="admin_pass" class="input" placeholder="••••••••" required>
        </div>
        <button type="submit" class="btn solid" style="width:100%" id="loginBtn">Authenticate</button>
      </form>

      <div id="loginMsg" class="small" style="margin-top:14px; color:var(--bad); display:none"></div>
    </div>
  </div>

  <!-- ADMIN INTERFACE -->
  <div id="admin-interface">
    <div class="admin-layout">
      <aside class="admin-sidebar">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:6px">
          <img src="assets/images/larmah-header.jpeg" style="width:42px; border-radius:12px">
          <div>
            <div style="font-weight:900; font-size:1rem;">Larmah Admin</div>
            <div style="font-size:0.75rem; color:var(--muted)">Master Control</div>
          </div>
        </div>

        <ul class="admin-nav">
          <li class="nav-item active" onclick="switchView('overview', this)"><i class="fa-solid fa-gauge-high"></i> Overview</li>
          <li class="nav-item" onclick="switchView('real-estate', this)"><i class="fa-solid fa-building"></i> Real Estate</li>
          <li class="nav-item" onclick="switchView('logistics', this)"><i class="fa-solid fa-truck-fast"></i> Logistics</li>
          <li class="nav-item" onclick="switchView('rates', this)"><i class="fa-solid fa-coins"></i> Rates</li>
          <li class="nav-item" onclick="switchView('insights', this)"><i class="fa-regular fa-newspaper"></i> Insights</li>
          <li class="nav-item" onclick="switchView('requests', this)"><i class="fa-solid fa-inbox"></i> Requests</li>
          <li class="nav-item" onclick="switchView('users', this)"><i class="fa-solid fa-users"></i> Users</li>
        </ul>

        <div style="margin-top:auto">
          <button class="btn small" style="width:100%" onclick="adminLogout()">
            <i class="fa-solid fa-arrow-right-from-bracket"></i> Sign Out
          </button>
        </div>
      </aside>

      <main class="admin-main">
        <!-- OVERVIEW -->
        <div id="view-overview" class="view-section">
          <div class="admin-header">
            <h1>System Overview</h1>
            <div class="small" style="color:var(--ok)"><i class="fa-solid fa-shield-halved"></i> Secure Session Active</div>
          </div>

          <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom:22px">
            <div class="card">
              <div class="small" style="color:var(--muted)">Total Users</div>
              <div style="font-size:2rem; font-weight:950; margin-top:5px" id="stat_users">—</div>
            </div>
            <div class="card">
              <div class="small" style="color:var(--muted)">Total Listings</div>
              <div style="font-size:2rem; font-weight:950; margin-top:5px" id="stat_listings">—</div>
            </div>
            <div class="card">
              <div class="small" style="color:var(--muted)">Requests (Last 7 Days)</div>
              <div style="font-size:2rem; font-weight:950; margin-top:5px" id="stat_requests">—</div>
            </div>
          </div>

          <div class="notice-admin">
            <b>Tip:</b> For true security, enforce Supabase RLS so only admins can write to <code>listings</code>, <code>rates</code>, and <code>insights</code>.
          </div>
        </div>

        <!-- REAL ESTATE -->
        <div id="view-real-estate" class="view-section" style="display:none">
          <div class="admin-header">
            <h1>Real Estate Catalog</h1>
            <button class="btn solid small" onclick="openEditor('listing', null, 'real-estate')"><i class="fa-solid fa-plus"></i> Add Property</button>
          </div>
          <div class="data-table-wrapper">
            <table>
              <thead>
                <tr>
                  <th width="70">Img</th>
                  <th>Title</th>
                  <th>Price</th>
                  <th>Status</th>
                  <th width="120">Actions</th>
                </tr>
              </thead>
              <tbody id="tbody-real-estate"></tbody>
            </table>
          </div>
        </div>

        <!-- LOGISTICS -->
        <div id="view-logistics" class="view-section" style="display:none">
          <div class="admin-header">
            <h1>Logistics Fleet</h1>
            <button class="btn solid small" onclick="openEditor('listing', null, 'logistics')"><i class="fa-solid fa-plus"></i> Add Service</button>
          </div>
          <div class="data-table-wrapper">
            <table>
              <thead>
                <tr>
                  <th width="70">Img</th>
                  <th>Title</th>
                  <th>Rate</th>
                  <th>Status</th>
                  <th width="120">Actions</th>
                </tr>
              </thead>
              <tbody id="tbody-logistics"></tbody>
            </table>
          </div>
        </div

        <!-- RATES -->
        <div id="view-rates" class="view-section" style="display:none">
          <div class="admin-header">
            <h1>Desk Rates</h1>
            <button class="btn solid small" onclick="openEditor('rate', null, null)"><i class="fa-solid fa-plus"></i> Add Rate</button>
          </div>
          <div class="data-table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Asset</th>
                  <th>Buy</th>
                  <th>Sell</th>
                  <th>Status</th>
                  <th width="120">Actions</th>
                </tr>
              </thead>
              <tbody id="tbody-rates"></tbody>
            </table>
          </div>
        </div>

        <!-- INSIGHTS -->
        <div id="view-insights" class="view-section" style="display:none">
          <div class="admin-header">
            <h1>Insights</h1>
            <button class="btn solid small" onclick="openEditor('insight', null, null)"><i class="fa-solid fa-plus"></i> Add Insight</button>
          </div>
          <div class="data-table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Category</th>
                  <th>Date</th>
                  <th>Status</th>
                  <th width="120">Actions</th>
                </tr>
              </thead>
              <tbody id="tbody-insights"></tbody>
            </table>
          </div>
        </div>

        <!-- REQUESTS -->
        <div id="view-requests" class="view-section" style="display:none">
          <div class="admin-header">
            <h1>Requests Inbox</h1>
            <button class="btn small" onclick="fetchRequests()"><i class="fa-solid fa-rotate"></i> Refresh</button>
          </div>
          <div class="data-table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Created</th>
                  <th>Status</th>
                  <th width="120">Action</th>
                </tr>
              </thead>
              <tbody id="tbody-requests"></tbody>
            </table>
          </div>
        </div>

        <!-- USERS -->
        <div id="view-users" class="view-section" style="display:none">
          <div class="admin-header">
            <h1>User Profiles</h1>
            <button class="btn small" onclick="fetchUsers()"><i class="fa-solid fa-rotate"></i> Refresh</button>
          </div>
          <div class="data-table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Email / ID</th>
                  <th>Full Name</th>
                  <th>Joined</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="tbody-users"></tbody>
            </table>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- EDITOR MODAL -->
  <div id="editorModal" class="modal">
    <div class="editor-box">
      <div style="display:flex; justify-content:space-between; margin-bottom:18px; align-items:center; gap:12px">
        <h2 id="editorTitle" style="margin:0">Edit</h2>
        <button class="action-btn" onclick="closeEditor()"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <form id="editorForm">
        <input type="hidden" id="edit_entity">
        <input type="hidden" id="edit_id">
        <input type="hidden" id="edit_category">

        <!-- LISTING FIELDS -->
        <div id="fields-listing" style="display:none">
          <div class="form-group">
            <label class="form-label">Title</label>
            <input type="text" id="listing_title" class="input" required>
          </div>

          <div class="row2">
            <div class="form-group">
              <label class="form-label">Price / Rate</label>
              <input type="text" id="listing_price" class="input">
            </div>
            <div class="form-group">
              <label class="form-label">Status</label>
              <select id="listing_status" class="input">
                <option value="active">Active</option>
                <option value="draft">Draft</option>
                <option value="sold">Sold</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Image URL</label>
            <input type="text" id="listing_image" class="input" placeholder="https://...">
          </div>

          <div class="form-group">
            <label class="form-label">Tags (comma separated)</label>
            <input type="text" id="listing_tags" class="input" placeholder="lekki, shortlet, vi">
          </div>

          <div class="form-group">
            <label class="form-label">Description</label>
            <textarea id="listing_desc" class="input" rows="4"></textarea>
          </div>
        </div>

        <!-- RATE FIELDS -->
        <div id="fields-rate" style="display:none">
          <div class="row2">
            <div class="form-group">
              <label class="form-label">Asset</label>
              <select id="rate_asset" class="input">
                <option value="USD">USD</option>
                <option value="GBP">GBP</option>
                <option value="EUR">EUR</option>
                <option value="USDT">USDT</option>
                <option value="BTC">BTC</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Status</label>
              <select id="rate_status" class="input">
                <option value="active">Active</option>
                <option value="draft">Draft</option>
              </select>
            </div>
          </div>

          <div class="row2">
            <div class="form-group">
              <label class="form-label">Buy</label>
              <input type="number" id="rate_buy" class="input" step="0.01">
            </div>
            <div class="form-group">
              <label class="form-label">Sell</label>
              <input type="number" id="rate_sell" class="input" step="0.01">
            </div>
          </div>
        </div>

        <!-- INSIGHT FIELDS -->
        <div id="fields-insight" style="display:none">
          <div class="form-group">
            <label class="form-label">Title</label>
            <input type="text" id="insight_title" class="input" required>
          </div>

          <div class="row2">
            <div class="form-group">
              <label class="form-label">Category</label>
              <select id="insight_category" class="input">
                <option value="real-estate">Real Estate</option>
                <option value="logistics">Logistics</option>
                <option value="exchange">Exchange</option>
                <option value="all">All</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Status</label>
              <select id="insight_status" class="input">
                <option value="active">Active</option>
                <option value="draft">Draft</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Image URL (optional)</label>
            <input type="text" id="insight_image" class="input" placeholder="https://...">
          </div>

          <div class="form-group">
            <label class="form-label">Summary</label>
            <textarea id="insight_summary" class="input" rows="4"></textarea>
          </div>
        </div>

        <!-- REQUEST VIEW (READ ONLY) -->
        <div id="fields-request" style="display:none">
          <div class="form-group">
            <label class="form-label">Category</label>
            <input type="text" id="req_category" class="input" disabled>
          </div>
          <div class="row2">
            <div class="form-group">
              <label class="form-label">Created</label>
              <input type="text" id="req_created" class="input" disabled>
            </div>
            <div class="form-group">
              <label class="form-label">Status</label>
              <input type="text" id="req_status" class="input" disabled>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Payload</label>
            <textarea id="req_payload" class="input" rows="10" disabled></textarea>
          </div>
        </div>

        <div style="margin-top:18px; display:flex; gap:10px">
          <button type="submit" class="btn solid" style="flex:1" id="saveBtn">Save</button>
          <button type="button" class="btn" onclick="closeEditor()">Close</button>
        </div>

        <div class="small" style="margin-top:10px;opacity:.7" id="editorHint"></div>
      </form>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ---------------------------
    // GLOBAL STATE
    // ---------------------------
    let sb = null;
    const CACHE = {
      listings: new Map(),
      rates: new Map(),
      insights: new Map(),
      requests: new Map()
    };

    // ---------------------------
    // HELPERS
    // ---------------------------
    function toast(msg, type="info"){
      if (window.LARMAH && LARMAH.toast) return LARMAH.toast(msg, type);
      const t = document.getElementById("toast");
      if(!t) return;
      t.textContent = msg;
      t.className = `toast show ${type}`;
      setTimeout(()=> t.className="toast", 4000);
    }

    function showLogin(msg=null){
      document.getElementById("login-gate").style.display = "flex";
      document.getElementById("admin-interface").style.display = "none";
      if(msg){
        const el = document.getElementById("loginMsg");
        el.textContent = msg;
        el.style.display = "block";
      }
    }

    function showAdmin(){
      document.getElementById("login-gate").style.display = "none";
      document.getElementById("admin-interface").style.display = "block";
    }

    function badgeClass(status){
      const s = String(status||"").toLowerCase();
      if(s === "active") return "active";
      if(s === "draft") return "draft";
      if(s === "sold") return "sold";
      if(s === "closed") return "closed";
      return "draft";
    }

    function safeDate(d){
      try { return new Date(d).toLocaleString(); } catch { return ""; }
    }

    // ---------------------------
    // AUTH
    // ---------------------------
    async function initAdmin(){
      sb = window.supabaseClient;
      if(!sb){
        showLogin("Supabase client not ready. Confirm assets/js/app.js is loading.");
        return;
      }

      const { data, error } = await sb.auth.getSession();
      if(error){
        showLogin("Session error: " + error.message);
        return;
      }
      if(!data?.session){
        showLogin();
        return;
      }

      // ✅ ADMIN CHECK
      const { data: isAdmin, error: adminErr } = await sb.rpc("is_admin");
      if(adminErr){
        showLogin("Admin check failed: " + adminErr.message);
        return;
      }
      if(!isAdmin){
        await sb.auth.signOut();
        showLogin("Access denied: Admins only.");
        return;
      }

      showAdmin();
      await loadStats();
      await fetchListings("real-estate");
    }

    // ✅ FIXED: adminLogin must also check is_admin
    async function adminLogin(email, password){
      const btn = document.getElementById("loginBtn");
      const msg = document.getElementById("loginMsg");

      msg.style.display = "none";
      btn.disabled = true;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Verifying...';

      const { data, error } = await sb.auth.signInWithPassword({ email, password });

      btn.disabled = false;
      btn.textContent = "Authenticate";

      if (error) {
        msg.textContent = "Invalid Credentials: " + error.message;
        msg.style.display = "block";
        return;
      }

      const { data: isAdmin, error: adminErr } = await sb.rpc("is_admin");

      if (adminErr) {
        await sb.auth.signOut();
        msg.textContent = "Admin check failed: " + adminErr.message;
        msg.style.display = "block";
        return;
      }

      if (!isAdmin) {
        await sb.auth.signOut();
        msg.textContent = "Access denied: Admins only.";
        msg.style.display = "block";
        return;
      }

      showAdmin();
      await loadStats();
      switchView("overview", document.querySelector(".nav-item"));
    }

    async function adminLogout(){
      if(!sb) sb = window.supabaseClient;
      await sb.auth.signOut();
      location.reload();
    }

    // ---------------------------
    // NAV
    // ---------------------------
    function switchView(viewId, el){
      document.querySelectorAll(".view-section").forEach(v => v.style.display = "none");
      const view = document.getElementById("view-" + viewId);
      if(view) view.style.display = "block";

      document.querySelectorAll(".nav-item").forEach(n => n.classList.remove("active"));
      if(el) el.classList.add("active");

      if(viewId === "overview") loadStats();
      if(viewId === "real-estate") fetchListings("real-estate");
      if(viewId === "logistics") fetchListings("logistics");
      if(viewId === "rates") fetchRates();
      if(viewId === "insights") fetchInsights();
      if(viewId === "requests") fetchRequests();
      if(viewId === "users") fetchUsers();
    }

    // ---------------------------
    // STATS
    // ---------------------------
    async function loadStats(){
      try {
        const { count: cListings } = await sb.from("listings").select("*", { count: "exact", head: true });
        document.getElementById("stat_listings").textContent = cListings ?? 0;
      } catch {
        document.getElementById("stat_listings").textContent = "—";
      }

      try {
        const { count: cUsers } = await sb.from("profiles").select("*", { count: "exact", head: true });
        document.getElementById("stat_users").textContent = cUsers ?? 0;
      } catch {
        document.getElementById("stat_users").textContent = "—";
      }

      try {
        const since = new Date(Date.now() - 7*24*60*60*1000).toISOString();
        const { count: cReq } = await sb
          .from("requests")
          .select("*", { count: "exact", head: true })
          .gte("created_at", since);
        document.getElementById("stat_requests").textContent = cReq ?? 0;
      } catch {
        document.getElementById("stat_requests").textContent = "—";
      }
    }

    // ---------------------------
    // PLACEHOLDERS (keep your existing CRUD functions here)
    // ---------------------------
    async function fetchListings(category){ /* ... keep your existing ... */ }
    async function fetchRates(){ /* ... keep your existing ... */ }
    async function fetchInsights(){ /* ... keep your existing ... */ }
    async function fetchRequests(){ /* ... keep your existing ... */ }
    async function fetchUsers(){ /* ... keep your existing ... */ }
    function openEditor(){ /* ... keep your existing ... */ }
    function closeEditor(){ document.getElementById("editorModal").classList.remove("active"); }

    // ---------------------------
    // WIRE UP
    // ---------------------------
    document.addEventListener("DOMContentLoaded", async () => {
      sb = window.supabaseClient;
      if(!sb){
        showLogin("Supabase client not ready. Confirm assets/js/app.js is loading.");
        return;
      }

      document.getElementById("adminLoginForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        await adminLogin(
          document.getElementById("admin_email").value.trim(),
          document.getElementById("admin_pass").value
        );
      });

      document.getElementById("editorModal").addEventListener("click", (e) => {
        if(e.target.id === "editorModal") closeEditor();
      });

      await initAdmin();
    });
  </script>
</body>
</html>
