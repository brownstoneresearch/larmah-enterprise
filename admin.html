<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin Command Center | Larmah</title>
    <link rel="icon" href="assets/images/larmah-favicon.jpeg" type="image/jpeg"/>
    <meta name="description" content="Larmah Internal Management: Catalogues, Insights, and Operations."/>
    
    <link rel="stylesheet" href="assets/css/style.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script defer src="assets/js/app.js"></script>

    <style>
        :root {
            --primary: #00a86b;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
        }

        /* Admin Specific UI */
        .admin-stat-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--glass);
            border: 1px solid var(--border);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .thumb-mini img {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            object-fit: cover;
            margin-right: 10px;
            vertical-align: middle;
            border: 1px solid var(--border);
        }

        .table-responsive {
            overflow-x: auto;
            background: var(--glass);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; padding: 15px; border-bottom: 1px solid var(--border); color: #888; text-transform: uppercase; font-size: 0.75rem; }
        td { padding: 15px; border-bottom: 1px solid var(--border); vertical-align: middle; }

        .status-pill {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        .status-active { background: rgba(0, 168, 107, 0.15); color: var(--primary); }
        .status-disabled { background: rgba(255, 90, 103, 0.15); color: #ff5a67; }

        /* Social Links */
        .social-links { display: flex; gap: 12px; margin-top: 15px; }
        .social-link {
            width: 35px; height: 35px;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: #fff; transition: 0.3s;
        }
        .social-link:hover { background: var(--primary); transform: scale(1.1); color: #000; }
    </style>
</head>
<body data-page="admin">

<header>
    <div class="container header-inner">
        <a class="brand" href="index.html">
            <img src="assets/images/larmah-header.jpeg" alt="Larmah"/>
        </a>

        <button class="menu-btn" onclick="LARMAH.toggleMenu()">
            <i class="fa-solid fa-bars"></i>
        </button>

        <nav id="nav">
            <ul>
                <li><a class="nav-link" href="real-estate.html">Real Estate</a></li>
                <li><a class="nav-link" href="logistics.html">Logistics</a></li>
                <li><a class="nav-link" href="fintech.html">FinTech</a></li>
                <li><a class="nav-link" href="insights.html">Insights</a></li>
            </ul>
        </nav>

        <div class="header-actions">
            <button class="pill outline small" onclick="LARMAH.signOut()"><i class="fa-solid fa-power-off"></i> Logout</button>
        </div>
    </div>
</header>

<main class="container">
    <section class="hero" style="padding: 40px 0 20px;">
        <div class="hero-shell">
            <div class="hero-inner" style="grid-template-columns:1fr;">
                <div>
                    <span style="color: var(--primary); font-weight: 700; text-transform: uppercase; letter-spacing: 2px;">Internal Terminal</span>
                    <h1 style="font-size: 2.5rem; margin-top: 10px;">Command Center</h1>
                    <div id="adminStatus" class="notice" style="margin-top:15px; display:none; border-color: var(--primary);"></div>
                    <div id="adminGate" class="notice" style="margin-top:12px; display:none; border-color: #ff5a67;"></div>
                    <div id="adminError" class="notice" style="margin-top:12px; display:none; background: rgba(255,90,103,.1);"></div>
                </div>
            </div>
        </div>
    </section>

    <div class="admin-stat-bar">
        <div class="stat-card">
            <div class="small">Session</div>
            <div id="user_email" style="font-weight: 700; color: var(--primary);">Admin User</div>
        </div>
        <div class="stat-card">
            <div class="small">Status</div>
            <div style="font-weight: 700;">Live Connection</div>
        </div>
    </div>

    <section class="section" id="catalogAdmin">
        <div class="section-header" style="display:flex; justify-content: space-between; align-items: flex-end;">
            <div>
                <h2>Catalogue Manager</h2>
                <p>Manage inventory for Real Estate, Logistics, and Fintech.</p>
            </div>
            <button class="btn primary" onclick="openEditor()"><i class="fa-solid fa-plus"></i> New Item</button>
        </div>

        <div class="card" style="margin-top: 20px;">
            <div class="row2">
                <select id="catCategory" class="input" onchange="loadCatalog()">
                    <option value="real-estate">Real Estate</option>
                    <option value="logistics">Logistics</option>
                    <option value="fintech">FinTech</option>
                </select>
                <input id="catSearch" class="input" placeholder="Filter items by title..." oninput="loadCatalog()"/>
            </div>

            <div class="table-responsive" style="margin-top:20px;">
                <div id="catTable">
                    </div>
            </div>
        </div>
    </section>

    <section class="section" id="insightsAdmin" style="margin-top: 60px;">
        <div class="section-header">
            <h2>Insights Publisher</h2>
            <p>Create and edit real-time community updates.</p>
        </div>

        <div class="card">
            <input id="ip_id" class="input" style="display:none;" disabled/>
            <div class="notice" id="ip_mode" style="display:none; margin-bottom: 15px;">
                <i class="fa-solid fa-pen-to-square"></i> <strong>Editing Post Mode</strong>
            </div>

            <input id="ip_title" class="input" placeholder="Post Title (Headline)" style="margin-top:10px;"/>
            <textarea id="ip_body" class="input" style="margin-top:15px; height: 120px;" placeholder="What's the update for the community?"></textarea>

            <div class="actions" style="margin-top:20px;">
                <button class="btn primary" id="ip_publish_btn" onclick="publishInsight()"><i class="fa-solid fa-paper-plane"></i> Publish Now</button>
                <button class="btn primary" id="ip_update_btn" onclick="updateInsight()" style="display:none;"><i class="fa-solid fa-floppy-disk"></i> Save Changes</button>
                <button class="btn outline" id="ip_cancel_btn" onclick="cancelInsightEdit()" style="display:none;">Cancel</button>
            </div>
        </div>

        <div id="insightsAdminList" style="margin-top:30px;">
            </div>
    </section>

    <div id="editorOverlay" class="modal-overlay" onclick="closeEditor()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-head">
                <div>
                    <h3 id="modalTitle" style="margin:0;">Item Editor</h3>
                    <div class="small">Catalog image files upload to Supabase Storage.</div>
                </div>
                <button class="btn small outline" onclick="closeEditor()"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="modal-body">
                <div class="row2">
                    <div style="flex:1">
                        <label class="small">Item ID</label>
                        <input id="e_id" class="input" disabled value="new"/>
                    </div>
                    <div style="flex:1">
                        <label class="small">Visibility</label>
                        <select id="e_active" class="input">
                            <option value="true">Active (Visible)</option>
                            <option value="false">Disabled (Hidden)</option>
                        </select>
                    </div>
                </div>

                <div class="row2" style="margin-top:15px;">
                    <div style="flex:1">
                        <label class="small">Headline Title</label>
                        <input id="e_title" class="input" placeholder="Luxury 2 Bed Flat"/>
                    </div>
                    <div style="flex:1">
                        <label class="small">Price Label</label>
                        <input id="e_price" class="input" placeholder="₦150,000 / Day"/>
                    </div>
                </div>

                <div style="margin-top:15px;">
                    <label class="small">Short Description</label>
                    <textarea id="e_desc" class="input" placeholder="Key features, location, etc." style="height: 80px;"></textarea>
                </div>

                <div class="row2" style="margin-top:15px;">
                    <div style="flex:1">
                        <label class="small">Image URL (External)</label>
                        <input id="e_image_url" class="input" placeholder="https://..."/>
                    </div>
                    <div style="flex:1">
                        <label class="small">Direct Upload</label>
                        <input id="e_image_file" class="input" type="file" accept="image/*"/>
                    </div>
                </div>

                <div style="margin-top:15px;">
                    <label class="small">Search Tags (Comma separated)</label>
                    <input id="e_tags" class="input" placeholder="Lekki, VIP, Security, SUV"/>
                </div>
            </div>

            <div class="modal-actions" style="border-top: 1px solid var(--border); padding-top: 20px;">
                <button class="btn outline" id="btnDelete" onclick="deleteItem()" style="color: #ff5a67;"><i class="fa-solid fa-trash"></i> Delete</button>
                <button class="btn primary" onclick="saveItem()"><i class="fa-solid fa-check"></i> Save Record</button>
            </div>
        </div>
    </div>
</main>

<footer>
    <div class="container">
        <div class="footer-grid">
            <div>
                <img src="assets/images/larmah-header.jpeg" alt="Larmah" style="height:40px; margin-bottom:15px;"/>
                <p class="small">Internal Control Panel. Authorized staff access only.</p>
                <div class="social-links">
                    <a href="https://instagram.com/hey_larmah" class="social-link"><i class="fa-brands fa-instagram"></i></a>
                    <a href="https://x.com/heylarmah_tech" class="social-link"><i class="fa-brands fa-x-twitter"></i></a>
                    <a href="https://t.me/heylarmah_tech" class="social-link"><i class="fa-brands fa-telegram"></i></a>
                    <a href="https://youtube.com/@heylarmah" class="social-link"><i class="fa-brands fa-youtube"></i></a>
                </div>
            </div>
            <div>
                <b>Operations</b>
                <div class="small" style="margin-top:10px;"><a href="index.html">Main Site</a></div>
                <div class="small"><a href="insights.html">Public Insights</a></div>
            </div>
        </div>
        <div style="text-align: center; margin-top: 40px; font-size: 0.8rem; opacity: 0.5; border-top: 1px solid var(--border); padding-top: 20px;">
            © <span id="year"></span> Larmah Enterprise Administration.
        </div>
    </div>
</footer>

<div id="toast" class="toast"></div>

<script>
document.getElementById('year').textContent = new Date().getFullYear();

var editing = null;

function showAdminError(msg){
    var el = document.getElementById('adminError');
    if(!el) return;
    el.style.display = 'block';
    el.innerHTML = '<strong>Operation Error:</strong> ' + (msg || 'Unknown failure');
}

function clearAdminError(){
    var el = document.getElementById('adminError');
    if(el){ el.style.display = 'none'; el.textContent = ''; }
}

async function requireAdmin(){
    var sb = await LARMAH.initSupabase();
    var session = await LARMAH.getSession();
    
    if(!session){
        document.getElementById("adminGate").style.display = "block";
        document.getElementById("adminGate").innerHTML = "<strong>Access Required.</strong> Redirecting to login...";
        setTimeout(() => { location.href = "auth.html"; }, 1500);
        return false;
    }

    document.getElementById("user_email").textContent = session.user.email;
    
    var r = await sb.from("profiles").select("role").eq("id", session.user.id).single();
    if(r.error || !r.data || r.data.role !== "admin"){
        document.getElementById("adminGate").style.display = "block";
        document.getElementById("adminGate").innerHTML = "<strong>Unauthorized.</strong> This account does not have Admin permissions.";
        return false;
    }

    var st = document.getElementById("adminStatus");
    if(st){ st.style.display = "block"; st.innerHTML = "<strong>Verified Admin Session:</strong> " + session.user.email; }
    return true;
}

// Catalog Management
async function loadCatalog(){
    var sb = await LARMAH.initSupabase();
    var category = document.getElementById("catCategory").value;
    var q = (document.getElementById("catSearch").value || "").toLowerCase();

    var r = await sb.from("catalog_items")
        .select("*")
        .eq("category", category)
        .order("updated_at", {ascending: false});

    if(r.error){ LARMAH.toast(r.error.message); return; }

    var items = (r.data || []).filter(it => {
        var hay = (it.title + " " + (it.description || "")).toLowerCase();
        return !q || hay.indexOf(q) >= 0;
    });

    var mount = document.getElementById("catTable");
    if(!items.length){ mount.innerHTML = "<div class='notice'>No items found in " + category + "</div>"; return; }

    mount.innerHTML = 
        "<table><thead><tr><th>Asset Detail</th><th>Price Point</th><th>Status</th><th>Actions</th></tr></thead><tbody>" +
        items.map(it => {
            var statusClass = it.active ? "status-active" : "status-disabled";
            var statusText = it.active ? "Active" : "Hidden";
            return `<tr>
                <td>
                    ${it.image_url ? `<span class="thumb-mini"><img src="${it.image_url}"></span>` : ""}
                    <div style="display:inline-block; vertical-align:middle;">
                        <b>${LARMAH.escapeHtml(it.title)}</b>
                        <div class="small" style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${LARMAH.escapeHtml(it.description || "")}</div>
                    </div>
                </td>
                <td><b>${LARMAH.escapeHtml(it.price || "-")}</b></td>
                <td><span class="status-pill ${statusClass}">${statusText}</span></td>
                <td><button class="btn small outline" onclick="editItem('${it.id}')">Edit</button></td>
            </tr>`;
        }).join("") + "</tbody></table>";
}

function openEditor(id){
    document.getElementById("editorOverlay").style.display = "flex";
    document.getElementById("btnDelete").style.display = id ? "inline-flex" : "none";
    document.getElementById("modalTitle").textContent = id ? "Modify Asset" : "Register New Asset";
    document.getElementById("e_id").value = id || "System Generated";
    
    // Reset Form
    document.getElementById("e_title").value = "";
    document.getElementById("e_price").value = "";
    document.getElementById("e_desc").value = "";
    document.getElementById("e_tags").value = "";
    document.getElementById("e_image_url").value = "";
    document.getElementById("e_active").value = "true";
    document.getElementById("e_image_file").value = "";
    
    editing = id ? { id: id } : null;
}

function closeEditor(){ document.getElementById("editorOverlay").style.display = "none"; }

async function editItem(id){
    var sb = await LARMAH.initSupabase();
    var r = await sb.from("catalog_items").select("*").eq("id", id).single();
    if(r.error) return;
    
    editing = r.data;
    openEditor(id);
    
    document.getElementById("e_title").value = r.data.title || "";
    document.getElementById("e_price").value = r.data.price || "";
    document.getElementById("e_desc").value = r.data.description || "";
    document.getElementById("e_tags").value = (r.data.tags || []).join(", ");
    document.getElementById("e_image_url").value = r.data.image_url || "";
    document.getElementById("e_active").value = String(r.data.active);
}

async function saveItem(){
    clearAdminError();
    var sb = await LARMAH.initSupabase();
    var category = document.getElementById("catCategory").value;
    var title = document.getElementById("e_title").value.trim();
    if(!title){ LARMAH.toast("Title is required"); return; }

    var payload = {
        category: category,
        title: title,
        price: document.getElementById("e_price").value.trim(),
        description: document.getElementById("e_desc").value.trim(),
        tags: document.getElementById("e_tags").value.split(",").map(s => s.trim()).filter(Boolean),
        active: (document.getElementById("e_active").value === "true"),
        image_url: document.getElementById("e_image_url").value.trim(),
        updated_at: new Date().toISOString()
    };

    try {
        var file = document.getElementById("e_image_file").files[0];
        if(file){
            LARMAH.toast("Uploading asset...");
            var path = "catalog/" + Date.now() + "_" + file.name;
            await sb.storage.from("catalog").upload(path, file);
            var pub = sb.storage.from("catalog").getPublicUrl(path);
            payload.image_url = pub.data.publicUrl;
        }

        var res;
        if(editing && editing.id){
            res = await sb.from("catalog_items").update(payload).eq("id", editing.id);
        } else {
            res = await sb.from("catalog_items").insert([payload]);
        }

        if(res.error) throw res.error;
        
        LARMAH.toast("Asset Recorded Successfully");
        closeEditor();
        loadCatalog();
    } catch(err) {
        showAdminError(err.message);
    }
}

async function deleteItem(){
    if(!confirm("Are you sure you want to delete this asset forever?")) return;
    var sb = await LARMAH.initSupabase();
    var d = await sb.from("catalog_items").delete().eq("id", editing.id);
    if(d.error){ LARMAH.toast(d.error.message); return; }
    LARMAH.toast("Asset Removed");
    closeEditor();
    loadCatalog();
}

// Insights Management
async function publishInsight(){
    var sb = await LARMAH.initSupabase();
    var title = document.getElementById("ip_title").value.trim();
    var body = document.getElementById("ip_body").value.trim();
    
    if(!title || !body){ LARMAH.toast("Both fields are required"); return; }
    
    var ins = await sb.from("insights_posts").insert([{ title, body, created_at: new Date().toISOString() }]);
    if(ins.error){ LARMAH.toast(ins.error.message); return; }
    
    document.getElementById("ip_title").value = "";
    document.getElementById("ip_body").value = "";
    LARMAH.toast("Insight Published Live");
    loadInsightsAdmin();
}

async function loadInsightsAdmin(){
    var sb = await LARMAH.initSupabase();
    var r = await sb.from("insights_posts").select("*").order("created_at", {ascending: false});
    var mount = document.getElementById("insightsAdminList");
    
    if(!r.data || !r.data.length){ mount.innerHTML = "<div class='small'>No community insights found.</div>"; return; }

    mount.innerHTML = "<div class='grid'>" + r.data.map(p => `
        <div class="card">
            <h3 style="font-size: 1rem;">${LARMAH.escapeHtml(p.title)}</h3>
            <p class="small" style="opacity: 0.8; margin: 10px 0;">${LARMAH.escapeHtml(p.body)}</p>
            <div class="meta" style="font-size: 0.7rem;">Created: ${new Date(p.created_at).toLocaleDateString()}</div>
            <div class="actions" style="margin-top:15px;">
                <button class="btn small outline" onclick="startInsightEditFromId('${p.id}')">Edit</button>
                <button class="btn small" onclick="deleteInsight('${p.id}')" style="color:#ff5a67;">Delete</button>
            </div>
        </div>
    `).join("") + "</div>";
}

async function startInsightEditFromId(id){
    var sb = await LARMAH.initSupabase();
    var r = await sb.from("insights_posts").select("*").eq("id", id).single();
    if(r.error) return;
    
    document.getElementById("ip_id").value = r.data.id;
    document.getElementById("ip_mode").style.display = "block";
    document.getElementById("ip_title").value = r.data.title;
    document.getElementById("ip_body").value = r.data.body;
    
    document.getElementById("ip_publish_btn").style.display = "none";
    document.getElementById("ip_update_btn").style.display = "inline-flex";
    document.getElementById("ip_cancel_btn").style.display = "inline-flex";
    
    window.scrollTo({ top: document.getElementById('insightsAdmin').offsetTop - 100, behavior: 'smooth' });
}

function cancelInsightEdit(){
    document.getElementById("ip_mode").style.display = "none";
    document.getElementById("ip_title").value = "";
    document.getElementById("ip_body").value = "";
    document.getElementById("ip_publish_btn").style.display = "inline-flex";
    document.getElementById("ip_update_btn").style.display = "none";
    document.getElementById("ip_cancel_btn").style.display = "none";
}

async function updateInsight(){
    var sb = await LARMAH.initSupabase();
    var id = document.getElementById("ip_id").value;
    var title = document.getElementById("ip_title").value.trim();
    var body = document.getElementById("ip_body").value.trim();

    var u = await sb.from("insights_posts").update({ title, body }).eq("id", id);
    if(u.error){ LARMAH.toast(u.error.message); return; }
    
    LARMAH.toast("Insight Updated");
    cancelInsightEdit();
    loadInsightsAdmin();
}

async function deleteInsight(id){
    if(!confirm("Delete this Insight forever?")) return;
    var sb = await LARMAH.initSupabase();
    await sb.from("insights_posts").delete().eq("id", id);
    loadInsightsAdmin();
    LARMAH.toast("Insight Deleted");
}

document.addEventListener("DOMContentLoaded", async function(){
    var ok = await requireAdmin();
    if(!ok) return;
    loadCatalog();
    loadInsightsAdmin();
});
</script>
</body>
</html>
