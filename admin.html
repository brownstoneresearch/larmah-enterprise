<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Command Center | Larmah Enterprise</title>
  <meta name="description" content="Larmah Admin: Catalog, Exchange Rates, Requests, and Insights." />
  <meta name="theme-color" content="#070A12" />

  <link rel="icon" href="assets/images/larmah-favicon.jpeg" type="image/jpeg" />
  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="assets/js/app.js"></script>

  <style>
    :root {
      --brand: #00d981;
      --ok: #00d981;
      --bad: #ff5a67;
      --muted: #888;
      --bg-card: rgba(255, 255, 255, 0.03);
    }
    .statbar{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:12px}
    .table-wrap{overflow-x:auto; background: var(--bg-card); border-radius: 12px; border: 1px solid rgba(255,255,255,.05);}
    .status-active{color:var(--ok);font-weight:700}
    .status-hidden{color:var(--bad);font-weight:700}
    .chips{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: var(--bg-card);
      color: var(--muted);
      font-weight: 600;
      font-size:.8rem;
    }
    .chip.ok{border-color:rgba(0,217,129,.3);background:rgba(0,217,129,.1);color:#fff}
    .rate-input{
      width: 100%; min-width: 80px;
      border-radius: 8px; border: 1px solid rgba(255,255,255,.1);
      background: rgba(0,0,0,.2); color: #fff; padding: 8px;
    }
    .img3-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media(max-width:768px){.img3-grid{grid-template-columns:1fr}}
    .img-preview{border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.02);border-radius:12px;overflow:hidden;height:100px;display:flex;align-items:center;justify-content:center}
    .img-preview img{width:100%;height:100%;object-fit:cover}
    .req-note{min-height:60px; font-size: 0.85rem;}
    .modal { max-height: 90vh; overflow-y: auto; }
  </style>
</head>

<body data-page="admin">
  <header>
    <div class="container header-inner">
      <a class="brand" href="index.html">
        <img src="assets/images/larmah-header.jpeg" alt="Larmah Enterprise" />
      </a>
      <div class="header-actions">
        <button class="pill" onclick="LARMAH.signOut()"><i class="fa-solid fa-power-off"></i> Logout</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <div class="hero-shell">
        <h1>Command Center</h1>
        <div id="adminStatus" class="notice" style="display:none; border-color:var(--ok)"></div>
        <div id="adminGate" class="notice" style="display:none; border-color:var(--bad); background:rgba(255,90,103,.1)"></div>
        <div id="adminError" class="notice" style="display:none; border-color:var(--bad)"></div>
        
        <div class="chips">
          <span class="chip ok"><i class="fa-solid fa-shield-halved"></i> Admin Mode</span>
          <span id="user_email" class="chip"><i class="fa-solid fa-user"></i> Loading user...</span>
          <span id="user_role" class="chip"><i class="fa-solid fa-key"></i> Role</span>
        </div>
      </div>
    </section>

    <div class="statbar">
      <div class="card">
        <div class="small">System Status</div>
        <div style="font-weight:900; color:var(--ok)">Operational</div>
        <div class="small">Supabase Live</div>
      </div>
    </div>

    <section class="section" id="catalogAdmin">
      <div class="section-head-split">
        <div>
          <h2>Catalogue Manager</h2>
          <p class="lead">Manage listings with up to 3 images.</p>
        </div>
        <button class="btn solid" onclick="openEditor()"><i class="fa-solid fa-plus"></i> New Item</button>
      </div>

      <div class="card">
        <div class="row2">
          <select id="catCategory" class="input" onchange="loadCatalog()">
            <option value="real-estate">Real Estate</option>
            <option value="logistics">Logistics</option>
            <option value="exchange">Exchange</option>
          </select>
          <input id="catSearch" class="input" placeholder="Search title or tags..." oninput="loadCatalog()" />
        </div>
        <div class="table-wrap" style="margin-top:16px" id="catTable">
          <div class="notice">Loading catalog...</div>
        </div>
      </div>
    </section>

    <section class="section" id="requestsAdmin" style="margin-top:32px">
      <div class="section-head-split">
        <h2>Requests Inbox</h2>
        <button class="btn" onclick="loadRequests()"><i class="fa-solid fa-rotate"></i> Refresh</button>
      </div>
      <div class="card">
        <div class="table-wrap" id="reqTable">
          <div class="notice">Loading requests...</div>
        </div>
      </div>
    </section>

    <section class="section" id="exchangeRatesAdmin" style="margin-top:32px">
      <div class="section-head-split">
        <h2>Exchange Rates</h2>
        <span class="small" id="ratesUpdatedAt">Last Updated: —</span>
      </div>
      <div class="card">
        <div class="table-wrap" id="ratesTableMount"></div>
        <hr style="opacity:0.1; margin:20px 0">
        <h3>Add New Currency</h3>
        <div class="row2">
          <input id="new_code" class="input" placeholder="USD" />
          <input id="new_name" class="input" placeholder="US Dollar" />
          <input id="new_buy" class="input" placeholder="Buy NGN" />
          <input id="new_sell" class="input" placeholder="Sell NGN" />
        </div>
        <button class="btn solid" style="margin-top:12px" onclick="upsertNewRate()">Add Currency</button>
      </div>
    </section>

    <section class="section" id="insightsAdmin" style="margin-top:32px">
      <div class="section-head-split">
        <h2>Insights Publisher</h2>
      </div>
      <div class="card">
        <input id="ip_id" type="hidden" />
        <input id="ip_title" class="input" placeholder="Headline" style="margin-bottom:10px" />
        <textarea id="ip_body" class="input" placeholder="Content..."></textarea>
        <div class="actions" style="margin-top:10px">
          <button class="btn solid" id="ip_publish_btn" onclick="publishInsight()">Publish</button>
          <button class="btn primary" id="ip_update_btn" style="display:none" onclick="updateInsight()">Save Changes</button>
          <button class="btn" id="ip_cancel_btn" style="display:none" onclick="cancelInsightEdit()">Cancel</button>
        </div>
      </div>
      <div id="insightsAdminList" style="margin-top:16px"></div>
    </section>

    <div id="editorOverlay" class="modal-overlay" style="display:none" onclick="closeEditor()">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-head">
          <h3 id="modalTitle">Item Editor</h3>
          <button class="btn small" onclick="closeEditor()"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="modal-body">
          <div class="row2">
            <input id="e_title" class="input" placeholder="Title" />
            <input id="e_price" class="input" placeholder="Price (e.g. ₦100k)" />
          </div>
          <textarea id="e_desc" class="input" style="margin-top:12px" placeholder="Description"></textarea>
          <input id="e_tags" class="input" style="margin-top:12px" placeholder="Tags (comma separated)" />
          
          <div style="margin-top:12px">
            <label class="small">Visibility</label>
            <select id="e_active" class="input">
              <option value="true">Active</option>
              <option value="false">Hidden</option>
            </select>
          </div>

          <div class="img3-grid" style="margin-top:12px">
            <div>
              <input id="e_img_url1" class="input small" placeholder="Image 1 URL" />
              <input id="e_img_file1" type="file" class="small" style="margin-top:5px" />
              <div class="img-preview" id="prev1"></div>
            </div>
            <div>
              <input id="e_img_url2" class="input small" placeholder="Image 2 URL" />
              <input id="e_img_file2" type="file" class="small" style="margin-top:5px" />
              <div class="img-preview" id="prev2"></div>
            </div>
            <div>
              <input id="e_img_url3" class="input small" placeholder="Image 3 URL" />
              <input id="e_img_file3" type="file" class="small" style="margin-top:5px" />
              <div class="img-preview" id="prev3"></div>
            </div>
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn danger" id="btnDelete" onclick="deleteItem()">Delete</button>
          <button class="btn solid" onclick="saveItem()">Save Record</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    let editing = null;

    async function requireAdmin() {
      const sb = await LARMAH.initSupabase();
      const { data: { session } } = await sb.auth.getSession();

      if (!session) {
        window.location.href = "auth.html";
        return false;
      }

      const { data: profile } = await sb.from("profiles").select("role").eq("id", session.user.id).single();
      const role = profile?.role?.toLowerCase();
      
      if (role !== "admin" && role !== "super_admin") {
        document.getElementById("adminGate").style.display = "block";
        document.getElementById("adminGate").innerHTML = "Access Denied: Admin role required.";
        return false;
      }

      document.getElementById("user_email").textContent = session.user.email;
      document.getElementById("user_role").textContent = "Role: " + role;
      return true;
    }

    // CATALOG LOGIC
    async function loadCatalog() {
      const sb = await LARMAH.initSupabase();
      const cat = document.getElementById("catCategory").value;
      const search = document.getElementById("catSearch").value.toLowerCase();

      const { data, error } = await sb.from("catalog_items").select("*").eq("category", cat).order("created_at", { ascending: false });
      if (error) return;

      const filtered = data.filter(it => it.title.toLowerCase().includes(search));
      const mount = document.getElementById("catTable");

      mount.innerHTML = `
        <table class="table">
          <thead><tr><th>Item</th><th>Price</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody>
            ${filtered.map(it => `
              <tr>
                <td><b>${it.title}</b></td>
                <td>${it.price || '-'}</td>
                <td class="${it.active ? 'status-active' : 'status-hidden'}">${it.active ? 'Active' : 'Hidden'}</td>
                <td><button class="btn small" onclick="editItem('${it.id}')">Edit</button></td>
              </tr>
            `).join('')}
          </tbody>
        </table>`;
    }

    function openEditor(id = null) {
      editing = id;
      document.getElementById("editorOverlay").style.display = "flex";
      document.getElementById("btnDelete").style.display = id ? "block" : "none";
      if(!id) {
        document.getElementById("e_title").value = "";
        document.getElementById("e_price").value = "";
        document.getElementById("e_desc").value = "";
        document.getElementById("e_tags").value = "";
        ["1","2","3"].forEach(n => {
           document.getElementById(`e_img_url${n}`).value = "";
           document.getElementById(`prev${n}`).innerHTML = "";
        });
      }
    }

    function closeEditor() { document.getElementById("editorOverlay").style.display = "none"; }

    async function editItem(id) {
      const sb = await LARMAH.initSupabase();
      const { data } = await sb.from("catalog_items").select("*").eq("id", id).single();
      if (!data) return;
      
      openEditor(id);
      document.getElementById("e_title").value = data.title;
      document.getElementById("e_price").value = data.price;
      document.getElementById("e_desc").value = data.description;
      document.getElementById("e_tags").value = (data.tags || []).join(", ");
      document.getElementById("e_active").value = String(data.active);
      
      const urls = data.image_urls || [];
      ["1","2","3"].forEach((n, i) => {
        const val = urls[i] || "";
        document.getElementById(`e_img_url${n}`).value = val;
        document.getElementById(`prev${n}`).innerHTML = val ? `<img src="${val}">` : "";
      });
    }

    async function saveItem() {
      const sb = await LARMAH.initSupabase();
      const title = document.getElementById("e_title").value;
      if (!title) return LARMAH.toast("Title required");

      const category = document.getElementById("catCategory").value;
      const image_urls = [
        document.getElementById("e_img_url1").value.trim(),
        document.getElementById("e_img_url2").value.trim(),
        document.getElementById("e_img_url3").value.trim()
      ].filter(Boolean);

      const payload = {
        title,
        category,
        price: document.getElementById("e_price").value,
        description: document.getElementById("e_desc").value,
        tags: document.getElementById("e_tags").value.split(",").map(t => t.trim()),
        active: document.getElementById("e_active").value === "true",
        image_urls,
        image_url: image_urls[0] || null,
        updated_at: new Date()
      };

      const { error } = editing 
        ? await sb.from("catalog_items").update(payload).eq("id", editing)
        : await sb.from("catalog_items").insert([payload]);

      if (error) return alert(error.message);
      LARMAH.toast("Success");
      closeEditor();
      loadCatalog();
    }

    // Initial Load
    document.addEventListener("DOMContentLoaded", async () => {
      const ok = await requireAdmin();
      if (ok) {
        loadCatalog();
        // Add other loaders here (loadRequests, etc.)
      }
    });
  </script>
</body>
</html>
