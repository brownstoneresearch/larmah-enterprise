<!-- =========================
     admin.html (CATALOGUE + FEATURED ONLY)
     - Premium gating:
       * must be logged in
       * must be Premium (premium_members)
       * must be Admin allowlist (window.__LARMAH_ADMIN_EMAILS OR DB is_admin() in app.js)
     - ✅ Only manages: public.listings
     - ✅ Includes: featured toggle + sort_rank
     - ❌ Removes: RSS, Insights, Rates, Users, Requests
========================= -->
<!DOCTYPE html>
<html lang="en-NG" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index,follow" />
  <title>Admin Command | Larmah Enterprise</title>

  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ✅ Configure BEFORE app.js loads -->
  <script>
    window.__SUPABASE_URL = "https://mskbumvopqnrhddfycfd.supabase.co";
    window.__SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1za2J1bXZvcHFucmhkZGZ5Y2ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMjA3ODYsImV4cCI6MjA4MTg5Njc4Nn0.68529BHKUz50dHP0ARptYC_OBXFLzpsvlK1ctbDOdZ4";
    window.__LARMAH_ADMIN_EMAILS = ["luckymomodu60@gmail.com"];
  </script>

  <script defer src="assets/js/app.js"></script>

  <style>
    #login-gate{position:fixed;inset:0;z-index:10000;background:#050810;display:flex;align-items:center;justify-content:center}
    .login-box{width:420px;max-width:92vw;background:var(--panel);border:1px solid var(--border);padding:40px;border-radius:20px;text-align:center;box-shadow:0 50px 100px rgba(0,0,0,.5)}
    #admin-interface{display:none;height:100vh}
    body{padding-bottom:0;overflow:hidden}
    .admin-layout{display:grid;grid-template-columns:260px 1fr;height:100%}
    .admin-sidebar{background:#050810;border-right:1px solid var(--border);display:flex;flex-direction:column;padding:20px;z-index:10}
    .admin-nav{list-style:none;margin:26px 0 0;padding:0;display:grid;gap:8px}
    .nav-item{padding:12px 14px;border-radius:12px;color:var(--muted);cursor:pointer;display:flex;align-items:center;gap:12px;font-weight:900;font-size:.92rem;transition:all .2s ease;border:1px solid transparent;user-select:none}
    .nav-item:hover{background:rgba(255,255,255,.05);color:var(--text)}
    .nav-item.active{background:rgba(0,217,129,.10);color:var(--brand);border:1px solid rgba(0,217,129,.25)}
    .admin-main{position:relative;overflow-y:auto;padding:30px;background:var(--bg)}
    .admin-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:22px;padding-bottom:14px;border-bottom:1px solid var(--border);gap:12px;flex-wrap:wrap}
    .data-table-wrapper{background:var(--panel);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    table{width:100%;border-collapse:collapse}
    th{text-align:left;padding:14px 16px;background:rgba(255,255,255,.03);color:var(--muted);font-size:.82rem;text-transform:uppercase;letter-spacing:1px}
    td{padding:14px 16px;border-top:1px solid rgba(255,255,255,.05);font-size:.93rem;vertical-align:middle}
    tr:hover td{background:rgba(255,255,255,.02)}
    .tbl-thumb{width:46px;height:46px;border-radius:10px;object-fit:cover;background:#000}

    .badge{padding:4px 10px;border-radius:999px;font-size:.75rem;font-weight:900;display:inline-block}
    .badge.active{background:rgba(67,209,125,.2);color:var(--ok)}
    .badge.draft{background:rgba(255,176,32,.18);color:var(--warn)}
    .badge.featured{background:rgba(212,175,55,.16);color:var(--accent);border:1px solid rgba(212,175,55,.22)}
    .badge.notfeatured{background:rgba(255,255,255,.06);color:rgba(233,237,247,.75);border:1px solid rgba(255,255,255,.10)}

    .action-btn{width:34px;height:34px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid var(--border);background:rgba(255,255,255,.05);color:var(--text);transition:.2s}
    .action-btn:hover{background:#fff;color:#000}
    .action-btn.danger:hover{background:var(--bad);color:#fff;border-color:var(--bad)}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(5px);z-index:9999;display:none;align-items:center;justify-content:center;padding:20px}
    .modal.active{display:flex}
    .editor-box{width:860px;max-width:96vw;background:#0f1218;border:1px solid var(--border);border-radius:20px;padding:26px;box-shadow:0 50px 100px rgba(0,0,0,.6);max-height:90vh;overflow-y:auto}

    .form-group{margin-bottom:14px}
    .form-label{display:block;color:var(--muted);font-size:.85rem;margin-bottom:6px;font-weight:900}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    @media(max-width:840px){.row3{grid-template-columns:1fr}}
    @media(max-width:720px){.row2{grid-template-columns:1fr}}
    .img-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media(max-width:720px){.img-grid{grid-template-columns:1fr}}
    .img-slot{border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:12px;background:rgba(255,255,255,.03)}
    .img-slot .slot-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;gap:10px}
    .img-slot .slot-preview{width:100%;height:140px;border-radius:12px;overflow:hidden;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.08)}
    .img-slot .slot-preview img{width:100%;height:100%;object-fit:cover;display:block}
    .img-slot .slot-actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}

    .tiny{font-size:.78rem;opacity:.75}
    .saving{opacity:.7;pointer-events:none}

    @media(max-width:900px){.admin-layout{grid-template-columns:1fr}.admin-sidebar{display:none}}

    .quick-actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-weight:900;font-size:.82rem;
    }

    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      min-width:220px; max-width:min(560px, calc(100vw - 28px));
      padding:10px 12px; border-radius:14px; border:1px solid rgba(255,255,255,.12);
      background: rgba(5,8,16,.92);
      color:#fff; display:none; z-index:20000;
    }
    .toast.show{display:block}

    .toggle{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
    }
    .toggle input{ width:18px; height:18px; }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}
  </style>
</head>

<body data-page="admin">
  <!-- LOGIN -->
  <div id="login-gate">
    <div class="login-box">
      <img src="assets/images/larmah-header.jpeg" style="width:60px;border-radius:12px;margin:0 auto 18px;display:block" alt="Larmah">
      <h2 style="margin-bottom:10px">Admin Access</h2>
      <p class="small" style="margin-bottom:18px">Premium + Admin allowlist only.</p>

      <form id="adminLoginForm">
        <div style="margin-bottom:14px;text-align:left">
          <label class="form-label">Email</label>
          <input type="email" id="admin_email" class="input" placeholder="admin@email.com" required>
        </div>
        <div style="margin-bottom:20px;text-align:left">
          <label class="form-label">Password</label>
          <input type="password" id="admin_pass" class="input" placeholder="••••••••" required>
        </div>
        <button type="submit" class="btn solid" style="width:100%" id="loginBtn">Authenticate</button>
      </form>

      <div id="loginMsg" class="small" style="margin-top:14px;color:var(--bad);display:none"></div>
      <div class="small" style="margin-top:12px;opacity:.75">
        Not admin? <a href="auth.html" style="color:var(--accent)">Go to Login</a>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="admin-interface">
    <div class="admin-layout">
      <aside class="admin-sidebar">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:6px">
          <img src="assets/images/larmah-header.jpeg" style="width:42px;border-radius:12px" alt="Larmah">
          <div>
            <div style="font-weight:950;font-size:1rem;">Larmah Admin</div>
            <div style="font-size:0.75rem;color:var(--muted)">Catalogue Control</div>
          </div>
        </div>

        <ul class="admin-nav">
          <li class="nav-item active" onclick="switchView('overview', this)"><i class="fa-solid fa-gauge-high"></i> Overview</li>
          <li class="nav-item" onclick="switchView('catalogue-all', this)"><i class="fa-solid fa-layer-group"></i> Catalogue (All)</li>
          <li class="nav-item" onclick="switchView('catalogue-real-estate', this)"><i class="fa-solid fa-building"></i> Real Estate</li>
          <li class="nav-item" onclick="switchView('catalogue-logistics', this)"><i class="fa-solid fa-truck-fast"></i> Logistics</li>
          <li class="nav-item" onclick="switchView('catalogue-featured', this)"><i class="fa-solid fa-star"></i> Featured</li>
        </ul>

        <div style="margin-top:auto">
          <button class="btn small" style="width:100%" onclick="adminLogout()">
            <i class="fa-solid fa-arrow-right-from-bracket"></i> Sign Out
          </button>
        </div>
      </aside>

      <main class="admin-main">
        <!-- OVERVIEW -->
        <div id="view-overview" class="view-section">
          <div class="admin-header">
            <div>
              <h1 style="margin:0">Catalogue Overview</h1>
              <div class="small" style="margin-top:6px;color:var(--muted)">Listings + Featured • Premium Admin-only access</div>
            </div>
            <div class="quick-actions">
              <span class="chip"><i class="fa-solid fa-shield-halved"></i> Admin</span>
              <button class="btn small" onclick="loadStats()"><i class="fa-solid fa-rotate"></i> Refresh</button>
              <button class="btn solid small" onclick="openEditor('listing', null, 'real-estate')"><i class="fa-solid fa-plus"></i> Add Listing</button>
            </div>
          </div>

          <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); margin-bottom:22px">
            <div class="card">
              <div class="small" style="color:var(--muted)">Total Listings</div>
              <div style="font-size:2rem;font-weight:950;margin-top:5px" id="stat_listings">—</div>
            </div>
            <div class="card">
              <div class="small" style="color:var(--muted)">Active Listings</div>
              <div style="font-size:2rem;font-weight:950;margin-top:5px" id="stat_active">—</div>
            </div>
            <div class="card">
              <div class="small" style="color:var(--muted)">Featured (Active)</div>
              <div style="font-size:2rem;font-weight:950;margin-top:5px" id="stat_featured">—</div>
            </div>
          </div>

          <div class="card">
            <div style="font-weight:950;margin-bottom:6px">Featured rules</div>
            <div class="small" style="opacity:.85;line-height:1.7">
              Homepage "Featured Shortlets" pulls items where <b>featured = true</b> and <b>status = active</b>.<br/>
              Ordering uses <b>sort_rank</b> (highest first), then newest.
            </div>
          </div>
        </div>

        <!-- CATALOGUE: ALL -->
        <div id="view-catalogue-all" class="view-section" style="display:none">
          <div class="admin-header">
            <h1>Catalogue (All)</h1>
            <div class="quick-actions">
              <button class="btn small" onclick="fetchListings('all')"><i class="fa-solid fa-rotate"></i> Refresh</button>
              <button class="btn solid small" onclick="openEditor('listing', null, 'real-estate')"><i class="fa-solid fa-plus"></i> Add</button>
            </div>
          </div>
          <div class="data-table-wrapper">
            <table>
              <thead>
                <tr>
                  <th width="70">Img</th>
                  <th>Title</th>
                  <th>Category</th>
                  <th>Price</th>
                  <th>Featured</th>
                  <th>Rank</th>
                  <th>Status</th>
                  <th width="170">Actions</th>
                </tr>
              </thead>
              <tbody id="tbody-catalogue-all"></tbody>
            </table>
          </div>
        </div>

        <!-- CATALOGUE: REAL ESTATE -->
        <div id="view-catalogue-real-estate" class="view-section" style="display:none">
          <div class="admin-header">
            <h1>Real Estate</h1>
            <div class="quick-actions">
              <button class="btn small" onclick="fetchListings('real-estate')"><i class="fa-solid fa-rotate"></i> Refresh</button>
              <button class="btn solid small" onclick="openEditor('listing', null, 'real-estate')"><i class="fa-solid fa-plus"></i> Add</button>
            </div>
          </div>
          <div class="data-table-wrapper">
            <table>
              <thead>
                <tr>
                  <th width="70">Img</th>
                  <th>Title</th>
                  <th>Price</th>
                  <th>Featured</th>
                  <th>Rank</th>
                  <th>Status</th>
                  <th width="170">Actions</th>
                </tr>
              </thead>
              <tbody id="tbody-catalogue-real-estate"></tbody>
            </table>
          </div>
        </div>

        <!-- CATALOGUE: LOGISTICS -->
        <div id="view-catalogue-logistics" class="view-section" style="display:none">
          <div class="admin-header">
            <h1>Logistics</h1>
            <div class="quick-actions">
              <button class="btn small" onclick="fetchListings('logistics')"><i class="fa-solid fa-rotate"></i> Refresh</button>
              <button class="btn solid small" onclick="openEditor('listing', null, 'logistics')"><i class="fa-solid fa-plus"></i> Add</button>
            </div>
          </div>
          <div class="data-table-wrapper">
            <table>
              <thead>
                <tr>
                  <th width="70">Img</th>
                  <th>Title</th>
                  <th>Rate</th>
                  <th>Featured</th>
                  <th>Rank</th>
                  <th>Status</th>
                  <th width="170">Actions</th>
                </tr>
              </thead>
              <tbody id="tbody-catalogue-logistics"></tbody>
            </table>
          </div>
        </div>

        <!-- CATALOGUE: FEATURED -->
        <div id="view-catalogue-featured" class="view-section" style="display:none">
          <div class="admin-header">
            <h1>Featured (Homepage)</h1>
            <div class="quick-actions">
              <button class="btn small" onclick="fetchFeatured()"><i class="fa-solid fa-rotate"></i> Refresh</button>
              <button class="btn small" onclick="fetchListings('all')"><i class="fa-solid fa-layer-group"></i> All Listings</button>
            </div>
          </div>
          <div class="data-table-wrapper">
            <table>
              <thead>
                <tr>
                  <th width="70">Img</th>
                  <th>Title</th>
                  <th>Category</th>
                  <th>Price</th>
                  <th>Rank</th>
                  <th>Status</th>
                  <th width="170">Actions</th>
                </tr>
              </thead>
              <tbody id="tbody-catalogue-featured"></tbody>
            </table>
          </div>
          <div class="small" style="margin-top:12px;opacity:.8">
            Tip: Set higher <b>sort_rank</b> for items you want shown more often on the homepage.
          </div>
        </div>

      </main>
    </div>
  </div>

  <input id="quickUploadInput" type="file" accept="image/*" style="display:none">

  <!-- EDITOR MODAL -->
  <div id="editorModal" class="modal">
    <div class="editor-box">
      <div style="display:flex;justify-content:space-between;margin-bottom:18px;align-items:center;gap:12px">
        <h2 id="editorTitle" style="margin:0">Edit</h2>
        <button class="action-btn" type="button" onclick="closeEditor()"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <form id="editorForm">
        <input type="hidden" id="edit_entity">
        <input type="hidden" id="edit_id">
        <input type="hidden" id="edit_category">

        <!-- LISTING -->
        <div id="fields-listing" style="display:none">
          <div class="row3">
            <div class="form-group">
              <label class="form-label">Category</label>
              <select id="listing_category" class="input" required>
                <option value="real-estate">real-estate</option>
                <option value="logistics">logistics</option>
              </select>
              <div class="tiny">Website reads only <b>real-estate</b> and <b>logistics</b>.</div>
            </div>

            <div class="form-group">
              <label class="form-label">Status</label>
              <select id="listing_status" class="input">
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Sort Rank (Featured order)</label>
              <input type="number" id="listing_sort_rank" class="input" placeholder="e.g. 100" inputmode="numeric" />
              <div class="tiny">Higher shows first.</div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Title</label>
            <input type="text" id="listing_title" class="input" required>
          </div>

          <div class="row2">
            <div class="form-group">
              <label class="form-label">Price / Rate</label>
              <input type="text" id="listing_price" class="input" placeholder="₦120,000/night or Contact for quote">
            </div>

            <div class="form-group">
              <label class="form-label">Location / Coverage</label>
              <input type="text" id="listing_location" class="input" placeholder="Lekki / Ikoyi / Lagos / Nationwide">
              <div class="tiny">Used by cards as Location/Area.</div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Featured on homepage</label>
            <div class="toggle">
              <input type="checkbox" id="listing_featured" />
              <div>
                <div style="font-weight:900">Mark as Featured</div>
                <div class="tiny">Shows in homepage Featured section (if active).</div>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Description</label>
            <textarea id="listing_desc" class="input" rows="4" placeholder="Short description shown on cards..."></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Tags (comma separated)</label>
            <input type="text" id="listing_tags" class="input" placeholder="lekki, shortlet, vi">
          </div>

          <div class="form-group">
            <label class="form-label">Images (1–3)</label>
            <div class="tiny">Upload or paste URLs. First image becomes main.</div>

            <div class="img-grid" style="margin-top:10px">
              <div class="img-slot">
                <div class="slot-head"><b>Image 1 (Main)</b><button type="button" class="btn small" onclick="clearSlot('listing',1)">Clear</button></div>
                <input type="file" id="listing_file_1" class="input" accept="image/*">
                <div class="slot-preview" style="margin-top:10px"><img id="listing_prev_1" src="" alt=""></div>
                <div class="slot-actions"><input type="text" id="listing_url_1" class="input" placeholder="or paste URL"></div>
              </div>
              <div class="img-slot">
                <div class="slot-head"><b>Image 2</b><button type="button" class="btn small" onclick="clearSlot('listing',2)">Clear</button></div>
                <input type="file" id="listing_file_2" class="input" accept="image/*">
                <div class="slot-preview" style="margin-top:10px"><img id="listing_prev_2" src="" alt=""></div>
                <div class="slot-actions"><input type="text" id="listing_url_2" class="input" placeholder="or paste URL"></div>
              </div>
              <div class="img-slot">
                <div class="slot-head"><b>Image 3</b><button type="button" class="btn small" onclick="clearSlot('listing',3)">Clear</button></div>
                <input type="file" id="listing_file_3" class="input" accept="image/*">
                <div class="slot-preview" style="margin-top:10px"><img id="listing_prev_3" src="" alt=""></div>
                <div class="slot-actions"><input type="text" id="listing_url_3" class="input" placeholder="or paste URL"></div>
              </div>
            </div>
          </div>

          <div class="tiny" style="margin-top:10px">
            ID: <span class="mono" id="listing_id_hint">—</span>
          </div>
        </div>

        <div style="margin-top:18px;display:flex;gap:10px">
          <button type="submit" class="btn solid" style="flex:1" id="saveBtn">Save</button>
          <button type="button" class="btn" onclick="closeEditor()">Close</button>
        </div>

        <div class="small" style="margin-top:10px;opacity:.7" id="editorHint"></div>
      </form>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ===== minimal helpers
    const esc = (s) => (s ?? "").toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    function toast(msg){
      const t = document.getElementById("toast");
      if(!t) return;
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(window.__toastT);
      window.__toastT = setTimeout(()=>t.classList.remove("show"), 2600);
    }

    let sb = null;

    const CACHE = { listings:new Map() };

    function showLogin(msg=null){
      document.getElementById("login-gate").style.display = "flex";
      document.getElementById("admin-interface").style.display = "none";
      const el = document.getElementById("loginMsg");
      if(!el) return;
      if(msg){ el.textContent = msg; el.style.display = "block"; }
      else { el.style.display = "none"; }
    }
    function showAdmin(){
      document.getElementById("login-gate").style.display = "none";
      document.getElementById("admin-interface").style.display = "block";
    }

    function badgeClass(status){
      const s = String(status||"").toLowerCase();
      if(s === "active") return "active";
      return "draft";
    }

    function featuredBadge(v){
      return v ? `<span class="badge featured"><i class="fa-solid fa-star" style="margin-right:6px"></i> Featured</span>`
               : `<span class="badge notfeatured">Not Featured</span>`;
    }

    /* ===== Storage helpers ===== */
    function randomId(len=10){ return Math.random().toString(36).slice(2, 2+len); }

    async function uploadToStorage(file, folder){
      if(!file) return null;
      const maxMb = 10;
      if(file.size > maxMb*1024*1024) throw new Error(`File too large. Max ${maxMb}MB`);

      const ext = (file.name.split(".").pop() || "jpg").toLowerCase().replace(/[^a-z0-9]/g,"") || "jpg";
      const path = `${folder}/${Date.now()}-${randomId(8)}.${ext}`;

      const { error: upErr } = await sb.storage.from("larmah-media").upload(path, file, { cacheControl:"3600", upsert:false });
      if(upErr) throw upErr;

      const { data } = sb.storage.from("larmah-media").getPublicUrl(path);
      const url = data?.publicUrl;
      if(!url) throw new Error("Could not generate public URL");
      return { path, url };
    }

    function clearSlot(kind, idx){
      const file = document.getElementById(`${kind}_file_${idx}`);
      const url = document.getElementById(`${kind}_url_${idx}`);
      const prev = document.getElementById(`${kind}_prev_${idx}`);
      if(file) file.value = "";
      if(url) url.value = "";
      if(prev) prev.src = "";
    }
    function bindFilePreview(kind, idx){
      const file = document.getElementById(`${kind}_file_${idx}`);
      const prev = document.getElementById(`${kind}_prev_${idx}`);
      if(!file || !prev) return;
      file.addEventListener("change", () => {
        const f = file.files?.[0];
        if(!f) return;
        prev.src = URL.createObjectURL(f);
      });
    }
    function getSlotUrl(kind, idx){ return (document.getElementById(`${kind}_url_${idx}`)?.value || "").trim(); }
    function setSlotUrl(kind, idx, v){ const el = document.getElementById(`${kind}_url_${idx}`); if(el) el.value = v || ""; }
    function setSlotPreview(kind, idx, url){ const el = document.getElementById(`${kind}_prev_${idx}`); if(el) el.src = url || ""; }

    async function collectImages(kind, folder){
      const urls = [];
      for(let i=1;i<=3;i++){
        const file = document.getElementById(`${kind}_file_${i}`)?.files?.[0] || null;
        const manual = getSlotUrl(kind, i);

        if(file){
          const up = await uploadToStorage(file, folder);
          urls.push(up.url);
          setSlotUrl(kind, i, up.url);
          setSlotPreview(kind, i, up.url);
        } else if(manual){
          urls.push(manual);
          setSlotPreview(kind, i, manual);
        }
      }
      return { urls: urls.slice(0,3) };
    }

    function pickThumb(it){
      if (Array.isArray(it.image_urls) && it.image_urls[0]) return it.image_urls[0];
      if (it.image_url) return it.image_url;
      return "assets/images/larmah-header.jpeg";
    }

    async function quickUploadMainImage(id, category=null){
      const input = document.getElementById("quickUploadInput");
      if(!input) return;

      input.value = "";
      input.onchange = async () => {
        const file = input.files?.[0];
        if(!file) return;

        try{
          toast("Uploading image…");
          const up = await uploadToStorage(file, "listings");

          const current = CACHE.listings.get(String(id)) || {};
          const nextUrls = Array.isArray(current.image_urls) ? current.image_urls.slice(0,3) : [];
          nextUrls[0] = up.url;

          const payload = { image_url: up.url, image_urls: nextUrls };
          const res = await sb.from("listings").update(payload).eq("id", id).select().single();
          if(res.error) throw res.error;

          toast("Image updated ✅");
          await fetchListings("all");
          if(category) await fetchListings(category);
          await fetchFeatured();
        }catch(e){
          console.warn(e);
          toast(e?.message || "Upload failed");
        }
      };

      input.click();
    }

    /* ===========================
       ✅ ADMIN GATE (Premium + allowlist)
       =========================== */
    async function initAdminGate(){
      sb = window.supabaseClient || (window.ensureSupabaseClient && window.ensureSupabaseClient());
      if(!sb){
        showLogin("Supabase not ready.");
        return false;
      }

      const ok = await LARMAH.requireAdmin({
        redirectTo: "auth.html",
        onFail: ({ reason }) => {
          showLogin(reason === "not-admin" ? "Access denied: Admin allowlist only." : "Please sign in.");
        }
      });

      if(!ok) return false;
      showAdmin();
      return true;
    }

    async function adminLogin(email, password){
      const btn = document.getElementById("loginBtn");
      const msg = document.getElementById("loginMsg");
      if(msg) msg.style.display = "none";

      btn.disabled = true;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Verifying...';

      try{
        const { error } = await sb.auth.signInWithPassword({ email, password });
        if(error) throw error;

        const ok = await initAdminGate();
        if(!ok) throw new Error("Access denied.");

        toast("Admin authenticated ✅");
        await loadStats();
        switchView("overview", document.querySelector(".nav-item"));
      }catch(e){
        try { await sb.auth.signOut(); } catch {}
        if(msg){
          msg.textContent = e?.message || "Access denied";
          msg.style.display = "block";
        }
        showLogin(e?.message || "Access denied");
      }finally{
        btn.disabled = false;
        btn.textContent = "Authenticate";
      }
    }

    async function adminLogout(){
      try { await sb.auth.signOut(); } catch {}
      window.location.href = "auth.html";
    }

    /* ===========================
       NAV
       =========================== */
    function switchView(viewId, el){
      document.querySelectorAll(".view-section").forEach(v => v.style.display = "none");
      const view = document.getElementById("view-" + viewId);
      if(view) view.style.display = "block";

      document.querySelectorAll(".nav-item").forEach(n => n.classList.remove("active"));
      if(el) el.classList.add("active");

      if(viewId === "overview") loadStats();
      if(viewId === "catalogue-all") fetchListings("all");
      if(viewId === "catalogue-real-estate") fetchListings("real-estate");
      if(viewId === "catalogue-logistics") fetchListings("logistics");
      if(viewId === "catalogue-featured") fetchFeatured();
    }

    /* ===========================
       STATS
       =========================== */
    async function loadStats(){
      try {
        const { count } = await sb.from("listings").select("*",{count:"exact", head:true});
        document.getElementById("stat_listings").textContent = count ?? 0;
      } catch { document.getElementById("stat_listings").textContent = "—"; }

      try {
        const { count } = await sb.from("listings").select("*",{count:"exact", head:true}).eq("status","active");
        document.getElementById("stat_active").textContent = count ?? 0;
      } catch { document.getElementById("stat_active").textContent = "—"; }

      try {
        const { count } = await sb.from("listings").select("*",{count:"exact", head:true}).eq("status","active").eq("featured", true);
        document.getElementById("stat_featured").textContent = count ?? 0;
      } catch { document.getElementById("stat_featured").textContent = "—"; }
    }

    /* ===========================
       LISTINGS
       =========================== */
    function getTbodyFor(category){
      if(!category || category === "all") return document.getElementById("tbody-catalogue-all");
      if(category === "real-estate") return document.getElementById("tbody-catalogue-real-estate");
      if(category === "logistics") return document.getElementById("tbody-catalogue-logistics");
      return document.getElementById("tbody-catalogue-all");
    }

    async function fetchListings(category){
      const isAll = !category || category === "all";
      const tbody = getTbodyFor(category);
      if(!tbody) return;

      const colspan = isAll ? 8 : 7;
      tbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align:center">Loading...</td></tr>`;

      try{
        let q = sb.from("listings").select("*").order("created_at",{ascending:false});
        if(!isAll) q = q.eq("category", category);
        const { data, error } = await q;
        if(error) throw error;

        CACHE.listings.clear();
        (data||[]).forEach(it => CACHE.listings.set(String(it.id), it));

        if(!data?.length){
          tbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align:center">No items found.</td></tr>`;
          return;
        }

        const rows = (data||[]).map(it => renderListingRow(it, category, isAll)).join("");
        tbody.innerHTML = rows;
      }catch(e){
        console.warn(e);
        tbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align:center">Error loading listings.</td></tr>`;
      }
    }

    function renderListingRow(it, category, isAll){
      const cat = it.category || "";
      const statusText = String(it.status || "inactive");
      const statusBadge = `<span class="badge ${badgeClass(statusText)}">${esc(statusText)}</span>`;
      const featBadge = featuredBadge(!!it.featured);
      const rank = Number(it.sort_rank || 0);

      const actions = `
        <div style="display:flex;gap:8px">
          <button class="action-btn" title="Edit" onclick="openEditor('listing','${String(it.id)}','${esc(cat)}')"><i class="fa-solid fa-pen"></i></button>
          <button class="action-btn" title="Upload Image" onclick="quickUploadMainImage('${String(it.id)}','${esc(cat)}')"><i class="fa-solid fa-image"></i></button>
          <button class="action-btn danger" title="Delete" onclick="deleteListing('${String(it.id)}','${esc(cat)}')"><i class="fa-solid fa-trash"></i></button>
        </div>
      `;

      const baseCols = `
        <td><img class="tbl-thumb" src="${esc(pickThumb(it))}" onerror="this.src='assets/images/larmah-header.jpeg'"></td>
        <td>
          <div style="font-weight:950">${esc(it.title||"")}</div>
          <div style="font-size:.8rem;opacity:.55" class="mono">${esc(String(it.id))}</div>
        </td>
      `;

      if(isAll){
        return `
          <tr>
            ${baseCols}
            <td>${esc(cat)}</td>
            <td style="color:var(--accent);font-weight:900">${esc(it.price||"")}</td>
            <td>${featBadge}</td>
            <td class="mono">${esc(String(rank))}</td>
            <td>${statusBadge}</td>
            <td>${actions}</td>
          </tr>
        `;
      }

      // category-specific (RE/LOG) tables
      return `
        <tr>
          ${baseCols}
          <td style="color:var(--accent);font-weight:900">${esc(it.price||"")}</td>
          <td>${featBadge}</td>
          <td class="mono">${esc(String(rank))}</td>
          <td>${statusBadge}</td>
          <td>${actions}</td>
        </tr>
      `;
    }

    async function fetchFeatured(){
      const tbody = document.getElementById("tbody-catalogue-featured");
      if(!tbody) return;
      tbody.innerHTML = `<tr><td colspan="7" style="text-align:center">Loading...</td></tr>`;

      try{
        const { data, error } = await sb
          .from("listings")
          .select("*")
          .eq("featured", true)
          .order("sort_rank", { ascending:false })
          .order("created_at", { ascending:false })
          .limit(300);

        if(error) throw error;

        if(!data?.length){
          tbody.innerHTML = `<tr><td colspan="7" style="text-align:center">No featured items yet.</td></tr>`;
          return;
        }

        (data||[]).forEach(it => CACHE.listings.set(String(it.id), it));

        tbody.innerHTML = (data||[]).map(it => {
          const statusText = String(it.status || "inactive");
          const statusBadge = `<span class="badge ${badgeClass(statusText)}">${esc(statusText)}</span>`;
          const rank = Number(it.sort_rank || 0);

          const actions = `
            <div style="display:flex;gap:8px">
              <button class="action-btn" title="Edit" onclick="openEditor('listing','${String(it.id)}','${esc(it.category||"")}')"><i class="fa-solid fa-pen"></i></button>
              <button class="action-btn" title="Upload Image" onclick="quickUploadMainImage('${String(it.id)}','${esc(it.category||"")}')"><i class="fa-solid fa-image"></i></button>
              <button class="action-btn danger" title="Delete" onclick="deleteListing('${String(it.id)}','${esc(it.category||"")}')"><i class="fa-solid fa-trash"></i></button>
            </div>
          `;

          return `
            <tr>
              <td><img class="tbl-thumb" src="${esc(pickThumb(it))}" onerror="this.src='assets/images/larmah-header.jpeg'"></td>
              <td>
                <div style="font-weight:950">${esc(it.title||"")}</div>
                <div style="font-size:.8rem;opacity:.55" class="mono">${esc(String(it.id))}</div>
              </td>
              <td>${esc(it.category||"")}</td>
              <td style="color:var(--accent);font-weight:900">${esc(it.price||"")}</td>
              <td class="mono">${esc(String(rank))}</td>
              <td>${statusBadge}</td>
              <td>${actions}</td>
            </tr>
          `;
        }).join("");
      }catch(e){
        console.warn(e);
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center">Error loading featured list.</td></tr>`;
      }
    }

    /* ===========================
       EDITOR
       =========================== */
    function setFieldsVisible(entity){
      const fields = document.getElementById("fields-listing");
      if(fields) fields.style.display = (entity === "listing") ? "block" : "none";
    }

    function resetEditor(){
      document.getElementById("editorForm").reset();
      document.getElementById("edit_entity").value = "";
      document.getElementById("edit_id").value = "";
      document.getElementById("edit_category").value = "";
      document.getElementById("editorHint").textContent = "";
      document.getElementById("listing_id_hint").textContent = "—";
      for(let i=1;i<=3;i++) clearSlot("listing",i);
    }

    function openEditor(entity, id=null, category=null){
      resetEditor();
      document.getElementById("editorModal").classList.add("active");
      document.getElementById("edit_entity").value = entity;
      document.getElementById("edit_id").value = id || "";
      document.getElementById("edit_category").value = category || "";
      setFieldsVisible(entity);

      if(entity !== "listing") return;

      document.getElementById("editorTitle").textContent = id ? "Edit Listing" : "New Listing";
      document.getElementById("listing_status").value = "active";
      document.getElementById("listing_sort_rank").value = "0";
      document.getElementById("listing_featured").checked = false;

      if(id){
        const it = CACHE.listings.get(String(id));
        if(it){
          document.getElementById("listing_id_hint").textContent = String(it.id || id);

          document.getElementById("listing_category").value = it.category || category || "real-estate";
          document.getElementById("listing_title").value = it.title || "";
          document.getElementById("listing_price").value = it.price || "";
          document.getElementById("listing_status").value = (it.status || "inactive");
          document.getElementById("listing_desc").value = it.description || "";
          document.getElementById("listing_tags").value = Array.isArray(it.tags) ? it.tags.join(", ") : "";
          document.getElementById("listing_featured").checked = !!it.featured;
          document.getElementById("listing_sort_rank").value = String(it.sort_rank ?? 0);
          document.getElementById("listing_location").value = it.location || it.coverage || it.area || it.city || it.state || "";

          const arr = Array.isArray(it.image_urls) ? it.image_urls : (it.image_url ? [it.image_url] : []);
          for(let i=1;i<=3;i++){
            const u = arr[i-1] || "";
            setSlotUrl("listing", i, u);
            setSlotPreview("listing", i, u);
          }
        }
      } else {
        document.getElementById("listing_category").value = category || "real-estate";
      }
    }

    function closeEditor(){ document.getElementById("editorModal").classList.remove("active"); }

    /* ===========================
       SAVE / DELETE
       =========================== */
    async function saveEditor(e){
      e.preventDefault();
      if(document.body.classList.contains("saving")) return;

      const entity = document.getElementById("edit_entity").value;
      const id = document.getElementById("edit_id").value || null;
      if(entity !== "listing") return;

      const btn = document.getElementById("saveBtn");
      const original = btn.textContent;

      document.body.classList.add("saving");
      btn.disabled = true;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';

      try{
        const payload = {
          category: document.getElementById("listing_category").value,
          title: document.getElementById("listing_title").value.trim(),
          price: document.getElementById("listing_price").value.trim(),
          status: document.getElementById("listing_status").value,
          description: document.getElementById("listing_desc").value.trim(),
          tags: document.getElementById("listing_tags").value.split(",").map(s=>s.trim()).filter(Boolean),
          featured: !!document.getElementById("listing_featured").checked,
          sort_rank: Number(document.getElementById("listing_sort_rank").value || 0),
        };

        const loc = (document.getElementById("listing_location").value || "").trim();
        // store in BOTH fields so your pages can read either
        payload.location = loc || null;
        payload.coverage = loc || null;

        if(!payload.category) throw new Error("Category is required.");
        if(!payload.title) throw new Error("Title is required.");

        const imgs = await collectImages("listing", "listings");
        payload.image_url = imgs.urls[0] || "";
        payload.image_urls = imgs.urls;

        const res = id
          ? await sb.from("listings").update(payload).eq("id", id).select().single()
          : await sb.from("listings").insert([payload]).select().single();

        if(res.error) throw res.error;

        toast("Saved ✅");
        closeEditor();

        await loadStats();
        await fetchListings("all");
        await fetchFeatured();

        // If homepage is open somewhere and using realtime, it will refresh automatically;
        // but if you want instant refresh in this session too:
        try { window.LARMAH?.featured?.load?.({ limit: 12 }); } catch {}

      }catch(err){
        console.warn("SAVE ERROR:", err);
        toast(err?.message || "Save failed");
      }finally{
        document.body.classList.remove("saving");
        btn.disabled = false;
        btn.textContent = original;
      }
    }

    async function deleteListing(id, category=null){
      if(!confirm("Delete this item?")) return;
      try{
        const { error } = await sb.from("listings").delete().eq("id", id);
        if(error) throw error;
        toast("Deleted ✅");
        await loadStats();
        await fetchListings("all");
        if(category) await fetchListings(category);
        await fetchFeatured();
      }catch(e){
        toast(e.message || "Delete failed");
      }
    }

    /* ===========================
       WIRE UP
       =========================== */
    document.addEventListener("DOMContentLoaded", async () => {
      sb = window.supabaseClient || (window.ensureSupabaseClient && window.ensureSupabaseClient());
      if(!sb){ showLogin("Supabase not ready."); return; }

      for(let i=1;i<=3;i++) bindFilePreview("listing", i);

      document.getElementById("adminLoginForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        await adminLogin(
          document.getElementById("admin_email").value.trim(),
          document.getElementById("admin_pass").value
        );
      });

      document.getElementById("editorForm").addEventListener("submit", saveEditor);

      document.getElementById("editorModal").addEventListener("click", (e) => {
        if(e.target.id === "editorModal") closeEditor();
      });

      document.addEventListener("keydown", (e) => {
        if(e.key === "Escape") closeEditor();
      });

      const ok = await initAdminGate();
      if(ok){
        await loadStats();
        await fetchListings("all");
      }else{
        showLogin();
      }
    });

    // expose for inline handlers
    window.switchView = switchView;
    window.loadStats = loadStats;
    window.fetchListings = fetchListings;
    window.fetchFeatured = fetchFeatured;

    window.openEditor = openEditor;
    window.closeEditor = closeEditor;

    window.clearSlot = clearSlot;
    window.quickUploadMainImage = quickUploadMainImage;

    window.deleteListing = deleteListing;
    window.adminLogout = adminLogout;
  </script>
</body>
</html>
