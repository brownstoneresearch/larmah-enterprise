<!DOCTYPE html>
<html lang="en-NG" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="robots" content="index,follow" />
  <title>Login | Larmah Premium</title>

  <meta name="theme-color" content="#070A12" />
  <meta name="color-scheme" content="dark light" />

  <link rel="icon" href="assets/images/larmah-favicon.jpeg" type="image/jpeg" />
  <link rel="apple-touch-icon" href="assets/images/larmah-favicon.jpeg" />
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="assets/js/app.js"></script>

  <style>
    :root{
      --gold:#D4AF37; --gold2:#F5D57A;
      --radius: 18px; --radius2: 22px; --max: 980px;
      --ease: cubic-bezier(.2,.8,.2,1);
      --shadow: 0 18px 50px rgba(0,0,0,.42);
      --shadow2: 0 12px 34px rgba(0,0,0,.30);
      --safeB: env(safe-area-inset-bottom, 0px);
    }
    html[data-theme="dark"]{
      --bg:#070A12; --bg2:#050810;
      --panel: rgba(255,255,255,.03);
      --panel2: rgba(255,255,255,.02);
      --line: rgba(255,255,255,.10);
      --line2: rgba(255,255,255,.08);
      --text:#E9EDF7;
      --muted: rgba(233,237,247,.72);
      --muted2: rgba(233,237,247,.60);
      --headerBg: rgba(7,10,18,.72);
      --focus: rgba(245,213,122,.28);
      --good: rgba(0,217,129,.95);
      --bad: rgba(255,90,103,.95);
      --warn: rgba(255,187,0,.95);
    }
    html[data-theme="light"]{
      --bg:#F7F7FB; --bg2:#FFFFFF;
      --panel: rgba(10,14,26,.04);
      --panel2: rgba(10,14,26,.03);
      --line: rgba(10,14,26,.12);
      --line2: rgba(10,14,26,.08);
      --text:#0E1526;
      --muted: rgba(14,21,38,.68);
      --muted2: rgba(14,21,38,.56);
      --headerBg: rgba(255,255,255,.78);
      --focus: rgba(212,175,55,.26);
      --good: rgba(0,140,90,.92);
      --bad: rgba(200,34,60,.90);
      --shadow: 0 16px 46px rgba(0,0,0,.12);
      --shadow2: 0 10px 26px rgba(0,0,0,.10);
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(900px 420px at 18% 6%, rgba(212,175,55,.10), transparent 60%),
        radial-gradient(900px 420px at 85% 10%, rgba(0,217,129,.06), transparent 62%),
        linear-gradient(180deg, var(--bg2), var(--bg));
      color: var(--text);
      overflow-x:hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    a{ color: var(--text); text-decoration:none; }
    a:hover{ color: var(--gold); }
    :focus-visible{ outline:2px solid var(--focus); outline-offset:3px; border-radius:12px; }

    header{
      position:sticky; top:0; z-index:50;
      background: var(--headerBg);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line2);
    }
    .container{ max-width: var(--max); margin: 0 auto; padding: 0 16px; }
    .header-inner{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 12px 0; }
    .brand{ display:flex; align-items:center; gap:10px; min-width:0; }
    .logo{
      width:44px; height:44px; border-radius:14px;
      border:1px solid var(--line2);
      overflow:hidden;
      background: var(--panel);
      flex:0 0 auto;
    }
    .logo img{ width:100%; height:100%; object-fit:cover; display:block; }
    .btxt{ display:flex; flex-direction:column; gap:4px; line-height:1.05; min-width:0; }
    .bname{ font-weight:950; letter-spacing:-.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .bsub{ color: var(--muted); font-weight:850; font-size:.86rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .icon-btn{
      width: 42px; height: 42px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: var(--panel);
      color: var(--text);
      display:inline-flex; align-items:center; justify-content:center;
      cursor:pointer;
      transition: transform .16s var(--ease), filter .16s var(--ease);
      flex:0 0 auto;
    }
    .icon-btn:hover{ transform: translateY(-1px); filter: brightness(1.05); }

    main{ padding: 18px 0; }
    .hero{
      border-radius: var(--radius2);
      border: 1px solid var(--line);
      background: var(--panel2);
      box-shadow: var(--shadow);
      padding: 16px;
      overflow:hidden;
      position:relative;
      isolation:isolate;
    }
    .hero::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(380px 180px at 18% 0%, rgba(212,175,55,.18), transparent 60%),
        radial-gradient(420px 220px at 86% 12%, rgba(0,217,129,.10), transparent 65%);
      pointer-events:none;
      z-index:-1;
    }
    h1{ margin: 6px 0 10px; font-size: clamp(1.8rem, 3.5vw, 2.6rem); letter-spacing:-.6px; }
    .lead{ margin:0; color: var(--muted); line-height:1.55; }

    .grid{ margin-top: 14px; display:grid; gap: 14px; grid-template-columns: 1fr .9fr; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      border-radius: var(--radius);
      border: 1px solid var(--line);
      background: var(--panel);
      box-shadow: var(--shadow2);
      padding: 14px;
    }

    label{ display:block; margin-top: 10px; font-size:.78rem; letter-spacing:.12em; text-transform:uppercase; color: var(--muted2); }
    input{
      width:100%;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: var(--panel2);
      color: var(--text);
      padding: 12px;
      min-height: 46px;
      outline:none;
      font-family: inherit;
      margin-top: 6px;
      font-size: 16px; /* prevent iOS zoom */
    }

    .btn{
      display:inline-flex; gap:10px; align-items:center; justify-content:center;
      border-radius: 14px; padding: 12px 16px; min-height: 46px;
      border: 1px solid var(--line);
      background: var(--panel2);
      color: var(--text);
      cursor:pointer;
      font-weight: 950;
      transition: transform .16s var(--ease), filter .16s var(--ease);
      width: 100%;
      margin-top: 12px;
    }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.03); }
    .btn.solid{
      background: var(--gold);
      color: #111;
      border-color: color-mix(in oklab, var(--gold) 55%, #000 45%);
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none !important; filter:none !important; }

    .notice{
      margin-top: 12px;
      border-radius: 16px;
      padding: 12px;
      border: 1px solid var(--line);
      background: var(--panel2);
      color: var(--muted);
      line-height: 1.5;
    }
    .notice strong{ color: var(--text); }

    .state{
      display:flex; gap:10px; align-items:center;
      margin-top: 12px;
      color: var(--muted);
      font-weight: 850;
      font-size:.92rem;
      display:none;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.25);
      border: 1px solid var(--line2);
    }
    .dot.good{ background: var(--good); }
    .dot.bad{ background: var(--bad); }
    .dot.warn{ background: var(--warn); }

    .toast{
      position: fixed;
      left: 50%;
      bottom: calc(18px + var(--safeB));
      transform: translateX(-50%);
      min-width: 220px;
      max-width: min(560px, calc(100vw - 28px));
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: color-mix(in oklab, var(--bg2) 88%, #000 12%);
      box-shadow: var(--shadow2);
      color: var(--text);
      display:none;
      z-index: 120;
    }
    .toast.show{ display:block; }
  </style>
</head>

<body>
  <header>
    <div class="container header-inner">
      <a class="brand" href="index.html#home" aria-label="Back to Home">
        <span class="logo"><img src="assets/images/larmah-favicon.jpeg" alt="Larmah" /></span>
        <span class="btxt">
          <span class="bname">Larmah Enterprise</span>
          <span class="bsub">Premium Access</span>
        </span>
      </a>

      <button class="icon-btn" type="button" onclick="toggleTheme()" aria-label="Toggle theme" title="Toggle theme">
        <i class="fa-solid fa-circle-half-stroke"></i>
      </button>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <h1 id="pageTitle">Login to your Premium account</h1>
      <p class="lead" id="pageLead">
        Accounts are Premium-only. If you haven’t paid, go Premium first to receive your unique registration link.
      </p>

      <div class="grid">
        <!-- LEFT: LOGIN / REGISTER -->
        <div class="card">

          <!-- REGISTER (invite-only) -->
          <div id="registerBox" style="display:none;">
            <div style="font-weight:950; letter-spacing:-.2px;">Create your Premium account</div>
            <div style="margin-top:8px; color:var(--muted); line-height:1.5;">
              Your email is locked to your Premium membership. Set your password to activate your account.
            </div>

            <label for="reg_email">Email</label>
            <input id="reg_email" type="email" readonly />

            <label for="reg_name">Full Name (optional)</label>
            <input id="reg_name" type="text" placeholder="Your name" autocomplete="name" />

            <label for="reg_pass">Password</label>
            <input id="reg_pass" type="password" placeholder="Min 8 characters" autocomplete="new-password" />

            <label for="reg_pass2">Confirm Password</label>
            <input id="reg_pass2" type="password" placeholder="Repeat password" autocomplete="new-password" />

            <button class="btn solid" id="createBtn" type="button" onclick="registerWithInvite()">
              <i class="fa-solid fa-user-plus"></i> Create Account
            </button>

            <div class="notice">
              <strong>Secure access:</strong> this link is single-use and expires. If it expires, go back to <a href="premium.html#pay">Premium</a> and use “Resend Registration Link”.
            </div>
          </div>

          <!-- LOGIN -->
          <div id="loginBox">
            <label for="email">Email</label>
            <input id="email" type="email" placeholder="you@email.com" autocomplete="email" />

            <label for="password">Password</label>
            <input id="password" type="password" placeholder="Your password" autocomplete="current-password" />

            <button class="btn solid" id="loginBtn" type="button" onclick="login()">
              <i class="fa-solid fa-right-to-bracket"></i> Login
            </button>

            <button class="btn" id="resetBtn" type="button" onclick="resetPassword()">
              <i class="fa-solid fa-key"></i> Forgot password
            </button>

            <div class="notice">
              <strong>No signup here.</strong><br/>
              To create an account: Pay on <a href="premium.html#pay">Premium</a> → check email → open your unique registration link.
            </div>
          </div>

          <div class="state" id="state">
            <span class="dot" id="dot"></span>
            <span id="stateText">—</span>
          </div>
        </div>

        <!-- RIGHT: HELP -->
        <div class="card">
          <div style="font-weight:950; letter-spacing:-.2px;">Need help?</div>
          <div style="margin-top:8px; color: var(--muted); line-height:1.5;">
            If you paid and didn’t receive your registration email, return to <b>Premium</b> and tap “Resend Registration Link”.
          </div>

          <a class="btn solid" href="premium.html#pay" style="margin-top:12px;">
            <i class="fa-solid fa-crown"></i> Go Premium
          </a>

          <button class="btn" type="button" onclick="waHelp()">
            <i class="fa-brands fa-whatsapp"></i> WhatsApp Support
          </button>

          <div class="notice">
            <strong>Support:</strong> business@heylarmah.tech<br/>
            <strong>WhatsApp:</strong> +234 706 308 0605
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // theme
    const THEME_KEY = "larmah_theme_v6";
    function setTheme(theme){
      document.documentElement.setAttribute("data-theme", theme);
      try{ localStorage.setItem(THEME_KEY, theme); }catch{}
      const metaTheme = document.querySelector('meta[name="theme-color"]');
      if(metaTheme) metaTheme.setAttribute("content", theme === "light" ? "#F7F7FB" : "#070A12");
    }
    function toggleTheme(){
      if(window.LARMAH?.toggleTheme) return window.LARMAH.toggleTheme();
      const cur = document.documentElement.getAttribute("data-theme") || "dark";
      setTheme(cur === "dark" ? "light" : "dark");
    }
    (function initTheme(){
      if(window.LARMAH?.setTheme) return;
      try{
        const saved = localStorage.getItem(THEME_KEY);
        if(saved === "light" || saved === "dark"){ setTheme(saved); return; }
      }catch{}
      const prefersLight = window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches;
      setTheme(prefersLight ? "light" : "dark");
    })();

    function toast(msg){
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(window.__t);
      window.__t = setTimeout(()=>t.classList.remove("show"), 2600);
    }

    function setState(kind, text){
      const wrap = document.getElementById("state");
      const dot = document.getElementById("dot");
      const txt = document.getElementById("stateText");
      wrap.style.display = "flex";
      dot.classList.remove("good","bad","warn");
      dot.classList.add(kind === "good" ? "good" : kind === "warn" ? "warn" : "bad");
      txt.textContent = text;
    }

    function getInviteToken(){
      const u = new URL(window.location.href);
      const t = u.searchParams.get("invite");
      return (t || "").trim();
    }

    function fnHeaders(){
      const anon = window.__SUPABASE_ANON_KEY || "";
      return {
        "Content-Type": "application/json",
        "apikey": anon,
        "Authorization": `Bearer ${anon}`
      };
    }

    function functionsBase(){
      if(window.LARMAH?.functionsBase) return window.LARMAH.functionsBase;
      const url = window.__SUPABASE_URL || "";
      return `${String(url).replace(/\/$/,"")}/functions/v1`;
    }

    async function waHelp(){
      const msg = (window.LARMAH?.buildMessage)
        ? LARMAH.buildMessage("Premium Login Help", { Message:"Hello Larmah, I need help accessing my Premium account." })
        : "Premium Login Help\n\nHello Larmah, I need help accessing my Premium account.";
      if(window.LARMAH?.openWhatsApp) return LARMAH.openWhatsApp(msg);
      window.open(`https://wa.me/2347063080605?text=${encodeURIComponent(msg)}`, "_blank", "noopener,noreferrer");
    }

    async function registerWithInvite(){
      const sb = await (window.LARMAH?.supabase?.wait ? LARMAH.supabase.wait() : null);
      if(!sb) return toast("Supabase not ready.");

      const token = getInviteToken();
      const full_name = document.getElementById("reg_name").value.trim();
      const email = document.getElementById("reg_email").value.trim();
      const pass = document.getElementById("reg_pass").value;
      const pass2 = document.getElementById("reg_pass2").value;

      if(!token) return toast("Missing invite token.");
      if(!email) return toast("Email missing.");
      if(!pass || pass.length < 8) return toast("Password must be at least 8 characters.");
      if(pass !== pass2) return toast("Passwords do not match.");

      const btn = document.getElementById("createBtn");
      btn.disabled = true;
      setState("warn", "Creating your account…");

      try{
        const url = `${functionsBase()}/premium-register`;
        const res = await fetch(url, {
          method: "POST",
          headers: fnHeaders(),
          body: JSON.stringify({ token, password: pass, full_name })
        });
        const data = await res.json().catch(() => ({}));
        if(!res.ok){
          setState("bad", data?.error || "Could not create account.");
          toast(data?.error || "Could not create account.");
          btn.disabled = false;
          return;
        }

        // Auto-login
        const { error } = await sb.auth.signInWithPassword({ email, password: pass });
        if(error){
          setState("warn", "Account created. Please login.");
          toast("Account created. Please login.");
          // switch to login UI
          document.getElementById("registerBox").style.display = "none";
          document.getElementById("loginBox").style.display = "block";
          document.getElementById("email").value = email;
          btn.disabled = false;
          return;
        }

        // Premium gate (hard enforcement)
        const ok = await (window.LARMAH?.requirePremium ? LARMAH.requirePremium({ redirectTo: "premium.html" }) : true);
        if(!ok){
          setState("bad","Premium access required.");
          btn.disabled = false;
          return;
        }

        setState("good", "Account created. Redirecting…");
        toast("Welcome to Premium ✅");

        setTimeout(() => {
          window.location.href = "dashboard.html";
        }, 700);

      }catch(e){
        setState("bad", "Network error while creating account.");
        toast("Network error.");
        btn.disabled = false;
      }
    }
    window.registerWithInvite = registerWithInvite;

    async function login(){
      const sb = await (window.LARMAH?.supabase?.wait ? LARMAH.supabase.wait() : null);
      if(!sb) return toast("Supabase not ready.");

      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;

      if(!email) return toast("Email is required.");
      if(!password) return toast("Password is required.");

      const loginBtn = document.getElementById("loginBtn");
      const resetBtn = document.getElementById("resetBtn");
      loginBtn.disabled = true;
      resetBtn.disabled = true;
      setState("warn","Signing in…");

      const { error } = await sb.auth.signInWithPassword({ email, password });
      if(error){
        setState("bad", error.message);
        toast(error.message);
        loginBtn.disabled = false;
        resetBtn.disabled = false;
        return;
      }

      const ok = await (window.LARMAH?.requirePremium
        ? LARMAH.requirePremium({
            redirectTo: "premium.html",
            onFail: () => {
              setState("bad","This email is not Premium-enabled.");
              toast("Premium access required. Please go Premium.");
            }
          })
        : true);

      if(!ok){
        loginBtn.disabled = false;
        resetBtn.disabled = false;
        return;
      }

      setState("good","Login successful. Redirecting…");
      toast("Welcome.");

      setTimeout(() => {
        window.location.href = "dashboard.html";
      }, 700);
    }
    window.login = login;

    async function resetPassword(){
      const sb = await (window.LARMAH?.supabase?.wait ? LARMAH.supabase.wait() : null);
      if(!sb) return toast("Supabase not ready.");

      const email = document.getElementById("email").value.trim();
      if(!email) return toast("Enter your email first.");

      const { error } = await sb.auth.resetPasswordForEmail(email, {
        redirectTo: `${location.origin}/auth.html`
      });

      if(error){
        setState("bad", error.message);
        toast(error.message);
        return;
      }
      setState("good","Reset email sent. Check your inbox/spam.");
      toast("Reset email sent.");
    }
    window.resetPassword = resetPassword;

    // Boot: if invite token exists, switch UI to registration mode
    document.addEventListener("DOMContentLoaded", () => {
      const token = getInviteToken();
      if(token){
        document.getElementById("pageTitle").textContent = "Create your Premium account";
        document.getElementById("pageLead").textContent = "You’re using a Premium invite link. Set your password to activate your Premium-only account.";
        document.getElementById("registerBox").style.display = "block";
        document.getElementById("loginBox").style.display = "none";

        // try to prefill email from token by asking user to paste email? (we avoid that)
        // Instead: decode email server-side after create click; but UX is nicer with email shown.
        // We'll set placeholder and fill after successful create; OR allow user to type but keep locked.
        document.getElementById("reg_email").value = "Loading…";

        // We can fetch email by calling premium-resend? Not safe.
        // So we keep it locked but filled after successful register response.
        // Better: user sees email only after register returns; but required for login.
        // We'll show email input as "Loading…" until they click create.
        // If you want it prefilled BEFORE clicking, I can add a tiny "premium-invite-info" function.
        setState("warn", "Invite link detected. Set your password to activate.");
      }
    });
  </script>
</body>
</html>
