<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <title>Insights | Larmah Enterprise</title>
  <meta name="description" content="Live market intelligence, FX rates, real estate trends, and logistics updates for the Nigerian market." />
  <meta name="keywords" content="Nigeria FX Rates, Lagos Real Estate News, Logistics Trends Nigeria, Crypto Rates Nigeria, Larmah Insights" />
  <meta name="theme-color" content="#070A12" />
  <link rel="canonical" href="https://heylarmah.tech/insights.html" />

  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://heylarmah.tech/insights.html" />
  <meta property="og:title" content="Larmah Insights | Market Intelligence" />
  <meta property="og:description" content="Stay ahead with live FX rates, verified market news, and strategic updates." />
  <meta property="og:image" content="https://heylarmah.tech/assets/images/larmah-header.jpeg" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Larmah Insights" />
  <meta name="twitter:description" content="Live data and verified updates for the Nigerian commerce sector." />
  <meta name="twitter:image" content="https://heylarmah.tech/assets/images/larmah-header.jpeg" />

  <link rel="icon" href="assets/images/larmah-favicon.jpeg" type="image/jpeg" />
  <link rel="preload" href="assets/images/larmah-header.jpeg" as="image" />

  <link rel="stylesheet" href="assets/css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="assets/js/app.js"></script>

  <style>
    .live-dot { display:inline-flex; align-items:center; gap:8px; font-weight:800; font-size:.85rem; color: var(--ok); }
    .live-dot i { font-size: 8px; }

    .market-board{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 12px;
      margin-bottom: 22px;
    }
    .ticker-card{
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 16px;
      text-align:center;
    }
    .ticker-pair{ font-size: 0.8rem; color: var(--muted); font-weight: 900; margin-bottom: 6px; }
    .ticker-val{ font-size: 1.2rem; font-weight: 950; color: var(--text); }
    .ticker-sub{ font-size:.8rem; color: var(--muted); opacity:.9; margin-top:6px; }

    /* Insight media slider */
    .card-media{
      width:100%; height:180px; border-radius:14px; overflow:hidden;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.2);
      margin-bottom: 12px;
      position: relative;
      user-select:none;
    }
    .card-media img{ width:100%; height:100%; object-fit:cover; display:block; }
    .media-nav{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:space-between;
      padding: 0 10px;
      pointer-events:none;
    }
    .media-btn{
      width:34px; height:34px; border-radius:12px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.10);
      display:grid; place-items:center;
      color:#fff;
      pointer-events:auto;
      cursor:pointer;
      backdrop-filter: blur(6px);
    }
    .media-btn:hover{ background: rgba(0,0,0,0.55); }
    .media-dots{
      position:absolute; left:0; right:0; bottom:10px;
      display:flex; justify-content:center; gap:6px;
      pointer-events:none;
    }
    .media-dot{
      width:7px; height:7px; border-radius:999px;
      background: rgba(255,255,255,0.35);
      border: 1px solid rgba(255,255,255,0.25);
    }
    .media-dot.active{ background: rgba(255,255,255,0.9); }

    .blog-date { font-size: 0.8rem; color: var(--accent); font-weight: 900; margin-bottom: 6px; display: block; }
    .blog-snip { color: var(--muted); font-size: 0.95rem; margin-top: 8px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

    .sk-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; }
    .sk-card{ height:210px; border-radius:16px; background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); opacity:.6; }
  </style>
</head>

<body data-page="insights">

  <div id="mobileNavOverlay">
    <div class="msheet">
      <div class="msheet-head">
        <div class="msheet-brand"><img src="assets/images/larmah-header.jpeg" alt="Larmah Logo"></div>
        <button class="msheet-close" onclick="LARMAH.toggleMenu()" aria-label="Close Menu"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="msheet-body">
        <div class="msheet-links">
          <a href="real-estate.html" class="msheet-link"><span><i class="fa-solid fa-house" style="width:24px;color:var(--brand)"></i> Real Estate</span><i class="fa-solid fa-chevron-right" style="font-size:12px;opacity:.5"></i></a>
          <a href="logistics.html" class="msheet-link"><span><i class="fa-solid fa-truck" style="width:24px;color:var(--brand)"></i> Logistics</span><i class="fa-solid fa-chevron-right" style="font-size:12px;opacity:.5"></i></a>
          <a href="insights.html" class="msheet-link active"><span><i class="fa-solid fa-chart-line" style="width:24px;color:var(--brand)"></i> Insights</span><i class="fa-solid fa-check" style="font-size:12px;"></i></a>
          <a href="exchange.html" class="msheet-link"><span><i class="fa-solid fa-money-bill-transfer" style="width:24px;color:var(--brand)"></i> Exchange</span><i class="fa-solid fa-chevron-right" style="font-size:12px;opacity:.5"></i></a>
        </div>
        <div class="msheet-footer">
          <div class="msheet-hint">Menu</div>
          <a href="premium.html" class="msheet-link" style="color:var(--accent);border-color:rgba(212,175,55,.2)"><span><i class="fa-solid fa-crown" style="width:24px"></i> Premium</span></a>
        </div>
      </div>
    </div>
  </div>

  <header>
    <div class="container header-inner">
      <a class="brand" href="index.html" aria-label="Larmah Home"><img src="assets/images/larmah-header.jpeg" alt="Larmah Enterprise" /></a>
      <button class="menu-btn" onclick="LARMAH.toggleMenu()" aria-label="Open menu"><i class="fa-solid fa-bars"></i></button>
      <nav id="nav" aria-label="Primary navigation">
        <ul>
          <li><a class="nav-link" href="real-estate.html">Real Estate</a></li>
          <li><a class="nav-link" href="logistics.html">Logistics</a></li>
          <li><a class="nav-link active" href="insights.html">Insights</a></li>
          <li><a class="nav-link" href="exchange.html">Exchange</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <div class="hero-shell">
        <div class="hero-inner">
          <div>
            <div class="hero-kicker">
              <span class="kicker-pill"><i class="fa-solid fa-chart-column"></i> Market Intelligence</span>
              <span class="kicker-dot">•</span>
              <span class="kicker-sub">Supabase Live Updates</span>
            </div>

            <h1>Stay Ahead of the Market.</h1>
            <p class="lead">Verified updates from the Larmah desk — live rates and curated insights, updated by Admin.</p>

            <div class="actions">
              <a class="btn solid" href="#news"><i class="fa-regular fa-newspaper"></i> Latest Insights</a>
              <a class="btn primary" href="exchange.html"><i class="fa-solid fa-money-bill-transfer"></i> Exchange</a>
            </div>

            <div class="small live-dot" id="liveStateIN" style="margin-top:12px;opacity:.9">
              <i class="fa-solid fa-circle fa-beat"></i> Live updates enabled
            </div>
          </div>

          <div class="hero-badges" style="align-content:center">
            <div class="hero-card" style="background:rgba(0,0,0,0.4)">
              <div style="font-size:.8rem;color:var(--muted)">USDT/NGN Sell</div>
              <div style="font-size:1.5rem;font-weight:950;margin:4px 0" id="heroRateMain">—</div>
              <div style="font-size:.85rem;color:var(--ok)">Live from Admin</div>
            </div>
            <div class="hero-card" style="background:rgba(0,0,0,0.4)">
              <div style="font-size:.8rem;color:var(--muted)">Active Insights</div>
              <div style="font-size:1.5rem;font-weight:950;margin:4px 0" id="heroInsightCount">—</div>
              <div style="font-size:.85rem;color:var(--ok)">Desk feed</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="section-head-split">
        <div>
          <h2>Live Market Board</h2>
          <p class="lead">Pairs pulled from <code>rates</code> table.</p>
        </div>
        <a class="mini-link small" href="exchange.html">Trade Now →</a>
      </div>

      <div id="marketBoard" class="market-board">
        <div class="ticker-card"><div class="ticker-pair">USDT/NGN</div><div class="ticker-val">—</div><div class="ticker-sub">Buy/Sell</div></div>
        <div class="ticker-card"><div class="ticker-pair">BTC/USDT</div><div class="ticker-val">—</div><div class="ticker-sub">Buy/Sell</div></div>
        <div class="ticker-card"><div class="ticker-pair">BTC/NGN</div><div class="ticker-val">—</div><div class="ticker-sub">Buy/Sell</div></div>
        <div class="ticker-card"><div class="ticker-pair">ETH/USDT</div><div class="ticker-val">—</div><div class="ticker-sub">Buy/Sell</div></div>
      </div>
    </section>

    <section class="section" id="news">
      <div class="section-head-split">
        <div>
          <h2>Latest Insights</h2>
          <p class="lead">Pulled from Supabase <code>insights</code> table.</p>
        </div>
        <div class="pillbar">
          <button class="btn small" onclick="setInsightFilter('all')">All</button>
          <button class="btn small" onclick="setInsightFilter('real-estate')">Property</button>
          <button class="btn small" onclick="setInsightFilter('logistics')">Logistics</button>
          <button class="btn small" onclick="setInsightFilter('exchange')">Exchange</button>
        </div>
      </div>

      <div id="newsMount">
        <div class="sk-grid">
          <div class="sk-card"></div><div class="sk-card"></div><div class="sk-card"></div>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="cta-strip">
        <div>
          <h2 style="margin:0">Don't miss a beat.</h2>
          <p class="lead" style="margin:6px 0 0">Join the Larmah broadcast list on WhatsApp.</p>
        </div>
        <button class="btn solid" onclick="LARMAH.openWhatsApp(LARMAH.buildMessage('Join Broadcast List', { Name:'' }))">
          <i class="fa-brands fa-whatsapp"></i> Subscribe Free
        </button>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <div class="footer-grid">
        <div>
          <div class="brandline">
            <img src="assets/images/larmah-header.jpeg" alt="Larmah Enterprise" />
            <div>
              <div style="font-weight:950">Larmah Enterprise</div>
              <div class="small">Real Estate • Logistics • Insights • Exchange</div>
            </div>
          </div>
          <div class="small" style="margin-top:8px">
            Trust-first commerce for Nigeria — verified listings, trackable enquiries, and WhatsApp-first support.
          </div>
          <div class="social-row" aria-label="Social links">
            <a class="social-btn" href="https://instagram.com/hey_larmah" aria-label="Instagram" title="Instagram"><i class="fa-brands fa-instagram"></i></a>
            <a class="social-btn" href="https://x.com/heylarmah_tech" aria-label="X" title="X (Twitter)"><i class="fa-brands fa-x-twitter"></i></a>
            <a class="social-btn" href="https://t.me/heylarmah_tech" aria-label="Telegram" title="Telegram"><i class="fa-brands fa-telegram"></i></a>
            <a class="social-btn" href="https://youtube.com/@heylarmah" aria-label="YouTube" title="YouTube"><i class="fa-brands fa-youtube"></i></a>
          </div>
        </div>

        <div>
          <b>Navigation</b>
          <div class="small" style="margin-top:10px"><a href="real-estate.html">Real Estate</a></div>
          <div class="small"><a href="logistics.html">Logistics</a></div>
          <div class="small"><a href="insights.html">Insights</a></div>
          <div class="small"><a href="exchange.html">Exchange</a></div>
          <div class="small"><a href="premium.html">Premium</a></div>
        </div>

        <div>
          <b>Contact</b>
          <div class="small" style="margin-top:10px"><i class="fa-brands fa-whatsapp"></i> +234 706 308 0605</div>
          <div class="small"><i class="fa-regular fa-envelope"></i> business@heylarmah.tech</div>
          <div class="small"><i class="fa-solid fa-location-dot"></i> Lagos, Nigeria</div>
          <div class="actions" style="margin-top:12px">
            <button class="btn small" onclick="LARMAH.openWhatsApp(LARMAH.buildMessage('Support', { Message:'Hello Larmah, I need help.' }))">
              <i class="fa-brands fa-whatsapp"></i> WhatsApp Support
            </button>
          </div>
          <!-- ✅ Removed Staff Sign-in/Admin -->
        </div>
      </div>

      <div class="small">© <span id="year"></span> Larmah Enterprise. All rights reserved.</div>
    </div>
  </footer>

  <div id="toast" class="toast"></div>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();
    const sbClient = () => window.supabaseClient || (window.ensureSupabaseClient && window.ensureSupabaseClient()) || null;

    let __insightsAll = [];
    let __insightsFilter = "all";
    const __IN_IMG_URLS = {};
    const __IN_IMG_IDX = {};

    // rate map for market board
    let __ratesMap = {};

    function normUpper(s){ return String(s||"").trim().toUpperCase(); }

    function normalizeRateRow(r){
      const base = normUpper(r.base || r.asset || "");
      const quote = normUpper(r.quote || "NGN");
      const pair = normUpper(r.pair || (base + "/" + quote));
      return { ...r, base, quote, pair };
    }

    function getInsightImages(it){
      const arr = Array.isArray(it.image_urls) ? it.image_urls.filter(Boolean) : [];
      if(arr.length) return arr.slice(0,3);
      if(it.image_url) return [it.image_url];
      return [];
    }

    function initInsightImages(it){
      const id = String(it.id);
      __IN_IMG_URLS[id] = getInsightImages(it);
      __IN_IMG_IDX[id] = 0;
    }

    function cycleInsightImage(id, dir){
      const urls = __IN_IMG_URLS[id] || [];
      if(urls.length <= 1) return;
      const max = urls.length;
      const cur = __IN_IMG_IDX[id] || 0;
      __IN_IMG_IDX[id] = (cur + dir + max) % max;

      const img = document.getElementById(`in-img-${id}`);
      if(img) img.src = urls[__IN_IMG_IDX[id]] || "";

      const dotsWrap = document.getElementById(`in-dots-${id}`);
      if(dotsWrap){
        dotsWrap.querySelectorAll(".media-dot").forEach((d,i)=> d.classList.toggle("active", i===__IN_IMG_IDX[id]));
      }
    }

    function setInsightFilter(cat){
      __insightsFilter = cat;
      renderInsights();
    }

    function renderInsights(){
      const mount = document.getElementById("newsMount");
      const items = (__insightsAll||[]).filter(it => {
        if(__insightsFilter === "all") return true;
        return String(it.category||"all") === __insightsFilter;
      });

      document.getElementById("heroInsightCount").textContent = String((__insightsAll||[]).length);

      if(!items.length){
        mount.innerHTML = `<div class="notice">No updates yet for this category.</div>`;
        return;
      }

      mount.innerHTML = `
        <div class="grid">
          ${items.map(it => {
            const id = String(it.id);
            initInsightImages(it);
            const urls = __IN_IMG_URLS[id];
            const hasMany = urls.length > 1;
            const hasImg = urls.length > 0;

            return `
              <div class="card">
                ${hasImg ? `
                  <div class="card-media">
                    <img id="in-img-${id}" src="${LARMAH.escapeHtml(urls[0])}" alt="${LARMAH.escapeHtml(it.title)}" loading="lazy"
                         onerror="this.style.display='none'">
                    ${hasMany ? `
                      <div class="media-nav">
                        <button class="media-btn" type="button" onclick="cycleInsightImage('${id}', -1)" aria-label="Prev"><i class="fa-solid fa-chevron-left"></i></button>
                        <button class="media-btn" type="button" onclick="cycleInsightImage('${id}', 1)" aria-label="Next"><i class="fa-solid fa-chevron-right"></i></button>
                      </div>
                      <div class="media-dots" id="in-dots-${id}">
                        ${urls.map((_,i)=> `<span class="media-dot ${i===0?'active':''}"></span>`).join("")}
                      </div>
                    ` : ``}
                  </div>
                ` : ``}

                <span class="blog-date">${new Date(it.created_at).toLocaleDateString()} • ${(it.category||"all").toUpperCase()}</span>
                <h3 style="font-size:1.1rem">${LARMAH.escapeHtml(it.title)}</h3>
                <div class="blog-snip">${LARMAH.escapeHtml(it.summary || "")}</div>

                <div class="actions" style="margin-top:12px">
                  <button class="btn small" onclick="openInsightChat('${id}')">Discuss</button>
                </div>
              </div>
            `;
          }).join("")}
        </div>
      `;
    }

    function openInsightChat(id){
      const it = (__insightsAll||[]).find(x => String(x.id) === String(id));
      if(!it) return;
      LARMAH.openWhatsApp(LARMAH.buildMessage("Insight Discussion", {
        Topic: it.title,
        Category: it.category || "all",
        Ref: "INS-" + id,
        Message: "I'd like to know more about this update."
      }));
    }

    function fmt(n){
      if(n === null || n === undefined || n === "") return "—";
      const num = Number(n);
      if(Number.isNaN(num)) return String(n);
      return num.toLocaleString(undefined, { maximumFractionDigits: 2 });
    }

    function renderMarketBoard(){
      const board = document.getElementById("marketBoard");
      if(!board) return;

      const wanted = ["USDT/NGN","BTC/USDT","BTC/NGN","ETH/USDT"];
      board.innerHTML = wanted.map(pair => {
        const r = __ratesMap[pair] || null;
        const val = (r?.buy != null && r?.sell != null) ? `${fmt(r.buy)} / ${fmt(r.sell)}` : "—";
        return `
          <div class="ticker-card">
            <div class="ticker-pair">${pair}</div>
            <div class="ticker-val">${val}</div>
            <div class="ticker-sub">Buy / Sell</div>
          </div>
        `;
      }).join("");

      const main = __ratesMap["USDT/NGN"];
      document.getElementById("heroRateMain").textContent = main?.sell ? `₦${fmt(main.sell)}` : "—";
    }

    async function loadRates(){
      const sb = sbClient();
      if(!sb) return;

      const { data, error } = await sb
        .from("rates")
        .select("id,asset,base,quote,pair,buy,sell,status,updated_at")
        .eq("status","active");

      if(error){ console.error(error); return; }

      __ratesMap = {};
      (data||[]).map(normalizeRateRow).forEach(r => { __ratesMap[r.pair] = r; });
      renderMarketBoard();
    }

    async function loadInsights(){
      const sb = sbClient();
      const mount = document.getElementById("newsMount");
      if(!sb){ mount.innerHTML = `<div class="notice">Supabase not ready.</div>`; return; }

      const { data, error } = await sb
        .from("insights")
        .select("*")
        .eq("status","active")
        .order("created_at",{ascending:false})
        .limit(80);

      if(error){
        console.error(error);
        mount.innerHTML = `<div class="notice" style="border-color:rgba(255,90,103,.35)"><strong>Could not load insights.</strong></div>`;
        return;
      }

      __insightsAll = data || [];
      renderInsights();
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadRates();
      loadInsights();

      // ✅ realtime (all pages standard)
      if(window.LARMAH && LARMAH.realtime){
        LARMAH.realtime.subscribe("insights", () => loadInsights(), "in-insights", { debounceMs: 700, statusElId: "liveStateIN" });
        LARMAH.realtime.subscribe("rates", () => loadRates(), "in-rates", { debounceMs: 700 });
      }
    });
  </script>
</body>
</html>
